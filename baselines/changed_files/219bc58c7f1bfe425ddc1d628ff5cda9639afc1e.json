{
    "sha_fail": "219bc58c7f1bfe425ddc1d628ff5cda9639afc1e",
    "changed_files": [
        {
            "commit": "219bc58c7f1bfe425ddc1d628ff5cda9639afc1e",
            "file_path": "prompts/code_prompts.py",
            "diff": "diff --git a/prompts/code_prompts.py b/prompts/code_prompts.py\nindex 13a61ad..6356a3e 100644\n--- a/prompts/code_prompts.py\n+++ b/prompts/code_prompts.py\n@@ -63,6 +63,8 @@ PAPER_DOWNLOADER_PROMPT = \"\"\"You are a precise paper downloader that processes i\n Task: Handle paper according to input type and save to \"./deepcode_lab/papers/id/id.md\"\n Note: Generate id (id is a number) by counting files in \"./deepcode_lab/papers/\" directory and increment by 1.\n \n+CRITICAL RULE: NEVER use write_file tool to create paper content directly. Always use file-downloader tools for PDF/document conversion.\n+\n Processing Rules:\n 1. URL Input (input_type = \"url\"):\n    - Use \"file-downloader\" tool to download paper\n@@ -70,8 +72,9 @@ Processing Rules:\n    - Return saved file path and metadata\n \n 2. File Input (input_type = \"file\"):\n-   - Move file to \"./deepcode_lab/papers/id/\"\n-   - Use \"file-downloader\" tool to convert to .md format\n+   - Move file to \"./deepcode_lab/papers/id/\" using move_file_to tool\n+   - The move_file_to tool will automatically convert PDF/documents to .md format\n+   - NEVER manually extract content or use write_file - let the conversion tools handle this\n    - Return new saved file path and metadata\n \n 3. Directory Input (input_type = \"directory\"):\n"
        },
        {
            "commit": "219bc58c7f1bfe425ddc1d628ff5cda9639afc1e",
            "file_path": "tools/pdf_downloader.py",
            "diff": "diff --git a/tools/pdf_downloader.py b/tools/pdf_downloader.py\nindex e1e4ed8..adb602b 100644\n--- a/tools/pdf_downloader.py\n+++ b/tools/pdf_downloader.py\n@@ -103,7 +103,17 @@ async def perform_document_conversion(\n     conversion_msg = \"\"\n \n     # \u9996\u5148\u5c1d\u8bd5\u4f7f\u7528\u7b80\u5355\u7684PDF\u8f6c\u6362\u5668\uff08\u5bf9\u4e8ePDF\u6587\u4ef6\uff09\n-    if file_path.lower().endswith(\".pdf\") and PYPDF2_AVAILABLE:\n+    # \u68c0\u67e5\u6587\u4ef6\u662f\u5426\u5b9e\u9645\u4e3aPDF\uff08\u65e0\u8bba\u6269\u5c55\u540d\u5982\u4f55\uff09\n+    is_pdf_file = False\n+    if PYPDF2_AVAILABLE:\n+        try:\n+            with open(file_path, \"rb\") as f:\n+                header = f.read(8)\n+                is_pdf_file = header.startswith(b'%PDF')\n+        except Exception:\n+            is_pdf_file = file_path.lower().endswith(\".pdf\")\n+    \n+    if is_pdf_file and PYPDF2_AVAILABLE:\n         try:\n             simple_converter = SimplePdfConverter()\n             conversion_result = simple_converter.convert_pdf_to_markdown(file_path)\n"
        },
        {
            "commit": "219bc58c7f1bfe425ddc1d628ff5cda9639afc1e",
            "file_path": "utils/file_processor.py",
            "diff": "diff --git a/utils/file_processor.py b/utils/file_processor.py\nindex 1d1bcd1..b25346f 100644\n--- a/utils/file_processor.py\n+++ b/utils/file_processor.py\n@@ -187,6 +187,12 @@ class FileProcessor:\n             if not os.path.exists(file_path):\n                 raise FileNotFoundError(f\"File not found: {file_path}\")\n \n+            # Check if file is actually a PDF by reading the first few bytes\n+            with open(file_path, \"rb\") as f:\n+                header = f.read(8)\n+                if header.startswith(b'%PDF'):\n+                    raise IOError(f\"File {file_path} is a PDF file, not a text file. Please convert it to markdown format or use PDF processing tools.\")\n+\n             # Read file content\n             # Note: Using async with would be better for large files\n             # but for simplicity and compatibility, using regular file reading\n@@ -195,6 +201,8 @@ class FileProcessor:\n \n             return content\n \n+        except UnicodeDecodeError as e:\n+            raise IOError(f\"Error reading file {file_path}: File encoding is not UTF-8. Original error: {str(e)}\")\n         except Exception as e:\n             raise IOError(f\"Error reading file {file_path}: {str(e)}\")\n \n"
        },
        {
            "commit": "219bc58c7f1bfe425ddc1d628ff5cda9639afc1e",
            "file_path": "workflows/agent_orchestration_engine.py",
            "diff": "diff --git a/workflows/agent_orchestration_engine.py b/workflows/agent_orchestration_engine.py\nindex 0292611..027775d 100644\n--- a/workflows/agent_orchestration_engine.py\n+++ b/workflows/agent_orchestration_engine.py\n@@ -661,6 +661,12 @@ async def orchestrate_document_preprocessing_agent(\n         # Step 2: Read document content to determine size\n         md_path = os.path.join(dir_info[\"paper_dir\"], md_files[0])\n         try:\n+            # Check if file is actually a PDF by reading the first few bytes\n+            with open(md_path, \"rb\") as f:\n+                header = f.read(8)\n+                if header.startswith(b'%PDF'):\n+                    raise IOError(f\"File {md_path} is a PDF file, not a text file. Please convert it to markdown format or use PDF processing tools.\")\n+            \n             with open(md_path, \"r\", encoding=\"utf-8\") as f:\n                 document_content = f.read()\n         except Exception as e:\n"
        }
    ]
}