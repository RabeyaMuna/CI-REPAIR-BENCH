{
    "sha_fail": "1a5a2bdf66d72b86a7b459bba8842598b867acef",
    "changed_files": [
        {
            "commit": "1a5a2bdf66d72b86a7b459bba8842598b867acef",
            "file_path": ".env.example",
            "diff": "diff --git a/.env.example b/.env.example\nindex 14bdf06..972eca4 100644\n--- a/.env.example\n+++ b/.env.example\n@@ -3,3 +3,4 @@ LOG_URL=https://logviewername.herokuapp.com/\n GUILD_ID=1234567890\n OWNERS=Owner1ID,Owner2ID,Owner3ID\n CONNECTION_URI=mongodb+srv://mongodburi\n+DISABLE_AUTOUPDATES=true\n\\ No newline at end of file\n"
        },
        {
            "commit": "1a5a2bdf66d72b86a7b459bba8842598b867acef",
            "file_path": "core/thread.py",
            "diff": "diff --git a/core/thread.py b/core/thread.py\nindex 926f441..d40a79d 100644\n--- a/core/thread.py\n+++ b/core/thread.py\n@@ -259,11 +259,16 @@ class Thread:\n             # Only send if there is content, embeds, or attachments\n             if not content and not embeds and not attachments:\n                 continue  # Skip empty messages\n-            # Format internal/system/mod-only messages as 'username: textcontent'\n-            if msg_type in (\"internal\", \"note\", \"system\", \"mod_only\"):\n+            author_is_mod = msg[\"author_id\"] not in [r.id for r in self.recipients]\n+            if author_is_mod:\n                 username = msg.get(\"author_name\") or (getattr(author, \"name\", None)) or \"Unknown\"\n-                formatted = f\"{username}: {content}\" if content else username\n-                await channel.send(formatted)\n+                user_id = msg.get(\"author_id\")\n+                if embeds:\n+                    embeds[0].set_author(name=f\"{username} ({user_id})\", icon_url=author.display_avatar.url if author and hasattr(author, \"display_avatar\") else None)\n+                    await channel.send(embeds=embeds)\n+                else:\n+                    formatted = f\"**{username} ({user_id})**: {content}\" if content else f\"**{username} ({user_id})**\"\n+                    await channel.send(formatted)\n             else:\n                 await channel.send(content=content or None, embeds=embeds or None)\n         self.snoozed = False\n@@ -596,6 +601,8 @@ class Thread:\n             await self._close(closer, silent, delete_channel, message)\n \n     async def _close(self, closer, silent=False, delete_channel=True, message=None, scheduled=False):\n+        if self.channel:\n+            self.manager.closing.add(self.channel.id)\n         try:\n             self.manager.cache.pop(self.id)\n         except KeyError as e:\n@@ -722,10 +729,15 @@ class Thread:\n                 if user is not None:\n                     tasks.append(user.send(embed=embed))\n \n-        if delete_channel:\n+        if delete_channel and self.channel:\n             tasks.append(self.channel.delete())\n \n-        await asyncio.gather(*tasks)\n+        try:\n+            await asyncio.gather(*tasks)\n+        finally:\n+            if self.channel:\n+                self.manager.closing.discard(self.channel.id)\n+\n         self.bot.dispatch(\"thread_close\", self, closer, silent, delete_channel, message, scheduled)\n \n     async def cancel_closure(self, auto_close: bool = False, all: bool = False) -> None:\n@@ -801,10 +813,7 @@ class Thread:\n             ):\n                 raise ValueError(\"Thread message not found.\")\n \n-            if message1.embeds[0].color.value == self.bot.main_color and (\n-                message1.embeds[0].author.name.startswith(\"Note\")\n-                or message1.embeds[0].author.name.startswith(\"Persistent Note\")\n-            ):\n+            if message1.embeds[0].footer and \"Internal Message\" in message1.embeds[0].footer.text:\n                 if not note:\n                     raise ValueError(\"Thread message not found.\")\n                 return message1, None\n@@ -867,7 +876,7 @@ class Thread:\n         embed1.description = message\n \n         tasks = [self.bot.api.edit_message(message1.id, message), message1.edit(embed=embed1)]\n-        if message1.embeds[0].author.name.startswith(\"Persistent Note\"):\n+        if message1.embeds[0].footer and \"Persistent Internal Message\" in message1.embeds[0].footer.text:\n             tasks += [self.bot.api.edit_note(message1.id, message)]\n         else:\n             for m2 in message2:\n@@ -894,7 +903,7 @@ class Thread:\n             if m2 is not None:\n                 tasks += [m2.delete()]\n \n-        if message1.embeds[0].author.name.startswith(\"Persistent Note\"):\n+        if message1.embeds[0].footer and \"Persistent Internal Message\" in message1.embeds[0].footer.text:\n             tasks += [self.bot.api.delete_note(message1.id)]\n \n         if tasks:\n@@ -992,9 +1001,9 @@ class Thread:\n             thread_creation=thread_creation,\n         )\n \n-        # Log as 'internal' type for logviewer visibility\n+        # Log as 'system' type for logviewer visibility\n         self.bot.loop.create_task(\n-            self.bot.api.append_log(message, message_id=msg.id, channel_id=self.channel.id, type_=\"internal\")\n+            self.bot.api.append_log(message, message_id=msg.id, channel_id=self.channel.id, type_=\"system\")\n         )\n \n         return msg\n@@ -1194,10 +1203,10 @@ class Thread:\n                     url=f\"https://discordapp.com/users/{author.id}#{message.id}\",\n                 )\n         else:\n-            # Special note messages\n+            # Notes are just replies with a different footer and color\n             embed.set_author(\n-                name=f\"{'Persistent' if persistent_note else ''} Note ({author.name})\",\n-                icon_url=system_avatar_url,\n+                name=str(author),\n+                icon_url=avatar_url,\n                 url=f\"https://discordapp.com/users/{author.id}#{message.id}\",\n             )\n \n@@ -1325,8 +1334,10 @@ class Thread:\n \n         if from_mod:\n             embed.colour = self.bot.mod_color\n+            if note:\n+                embed.set_footer(text=f\"{'Persistent' if persistent_note else ''} Internal Message\")\n             # Anonymous reply sent in thread channel\n-            if anonymous and isinstance(destination, discord.TextChannel):\n+            elif anonymous and isinstance(destination, discord.TextChannel):\n                 embed.set_footer(text=\"Anonymous Reply\")\n             # Normal messages\n             elif not anonymous:\n@@ -1336,8 +1347,6 @@ class Thread:\n                 embed.set_footer(text=mod_tag)  # Normal messages\n             else:\n                 embed.set_footer(text=self.bot.config[\"anon_tag\"])\n-        elif note:\n-            embed.colour = self.bot.main_color\n         else:\n             embed.set_footer(text=f\"Message ID: {message.id}\")\n             embed.colour = self.bot.recipient_color\n@@ -1489,6 +1498,7 @@ class ThreadManager:\n     def __init__(self, bot):\n         self.bot = bot\n         self.cache = {}\n+        self.closing = set()\n \n     async def populate_cache(self) -> None:\n         for channel in self.bot.modmail_guild.text_channels:\n@@ -1512,6 +1522,8 @@ class ThreadManager:\n     ) -> typing.Optional[Thread]:\n         \"\"\"Finds a thread from cache or from discord channel topics.\"\"\"\n         if recipient is None and channel is not None and isinstance(channel, discord.TextChannel):\n+            if channel.id in self.closing:\n+                return None\n             thread = await self._find_from_channel(channel)\n             if thread is None:\n                 user_id, thread = next(\n"
        }
    ]
}