{
    "sha_fail": "7a4b27be84c300a67cc8dea17a3b3d4e75688dd8",
    "changed_files": [
        {
            "commit": "7a4b27be84c300a67cc8dea17a3b3d4e75688dd8",
            "file_path": "tests/test_proxy_connect.py",
            "diff": "diff --git a/tests/test_proxy_connect.py b/tests/test_proxy_connect.py\nindex 61d79743..e5bec182 100644\n--- a/tests/test_proxy_connect.py\n+++ b/tests/test_proxy_connect.py\n@@ -20,7 +20,7 @@ class MitmProxy:\n     auth_user = \"scrapy\"\n     auth_pass = \"scrapy\"\n \n-    def start(self):\n+    def start(self, listen_host: str = \"127.0.0.1\"):\n         script = \"\"\"\n import sys\n from mitmproxy.tools.main import mitmdump\n@@ -35,7 +35,7 @@ sys.exit(mitmdump())\n                 \"-c\",\n                 script,\n                 \"--listen-host\",\n-                \"127.0.0.1\",\n+                listen_host,\n                 \"--listen-port\",\n                 \"0\",\n                 \"--proxyauth\",\n@@ -47,7 +47,9 @@ sys.exit(mitmdump())\n             stdout=PIPE,\n         )\n         line = self.proc.stdout.readline().decode(\"utf-8\")\n-        host_port = re.search(r\"listening at (?:http://)?([^:]+:\\d+)\", line).group(1)\n+        host_port = re.search(\n+            r\"listening at (?:https?:\\/\\/)?([^\\s.]+(?:\\.\\S+)*?:\\d+)\", line\n+        ).group(1)\n         return f\"http://{self.auth_user}:{self.auth_pass}@{host_port}\"\n \n     def stop(self):\n@@ -61,7 +63,7 @@ def _wrong_credentials(proxy_url):\n     return urlunsplit(bad_auth_proxy)\n \n \n-class TestProxyConnect:\n+class BaseTestProxyConnect:\n     @classmethod\n     def setup_class(cls):\n         cls.mockserver = MockServer()\n@@ -78,9 +80,8 @@ class TestProxyConnect:\n             pytest.skip(\"mitmproxy is not installed\")\n \n         self._oldenv = os.environ.copy()\n-\n         self._proxy = MitmProxy()\n-        proxy_url = self._proxy.start()\n+        proxy_url = self._proxy.start(listen_host=self.proxy_host)\n         os.environ[\"https_proxy\"] = proxy_url\n         os.environ[\"http_proxy\"] = proxy_url\n \n@@ -101,8 +102,6 @@ class TestProxyConnect:\n         crawler = get_crawler(SimpleSpider)\n         with LogCapture() as log:\n             yield crawler.crawl(self.mockserver.url(\"/status?n=200\", is_secure=True))\n-        # The proxy returns a 407 error code but it does not reach the client;\n-        # he just sees a TunnelError.\n         self._assert_got_tunnel_error(log)\n \n     @inlineCallbacks\n@@ -120,3 +119,11 @@ class TestProxyConnect:\n \n     def _assert_got_tunnel_error(self, log):\n         assert \"TunnelError\" in str(log)\n+\n+\n+class TestProxyConnect(BaseTestProxyConnect):\n+    proxy_host = \"127.0.0.1\"\n+\n+\n+class TestProxyConnectIPv6(BaseTestProxyConnect):\n+    proxy_host = \"::1\"\n"
        }
    ]
}