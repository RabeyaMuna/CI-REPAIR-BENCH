{
    "sha_fail": "58de72d97f1b19b44a141fbaa4cdd0411748f6ea",
    "changed_files": [
        {
            "commit": "58de72d97f1b19b44a141fbaa4cdd0411748f6ea",
            "file_path": "src/oscar/apps/customer/apps.py",
            "diff": "diff --git a/src/oscar/apps/customer/apps.py b/src/oscar/apps/customer/apps.py\nindex fe9a29f..bd40f28 100644\n--- a/src/oscar/apps/customer/apps.py\n+++ b/src/oscar/apps/customer/apps.py\n@@ -25,6 +25,9 @@ class CustomerConfig(OscarConfig):\n         self.anon_order_detail_view = get_class(\n             \"customer.views\", \"AnonymousOrderDetailView\"\n         )\n+        self.anon_order_form_view = get_class(\n+            \"customer.views\", \"AnonymousOrderFormView\"\n+        )\n         self.order_line_view = get_class(\"customer.views\", \"OrderLineView\")\n \n         self.address_list_view = get_class(\"customer.views\", \"AddressListView\")\n@@ -133,6 +136,11 @@ class CustomerConfig(OscarConfig):\n                 login_required(self.order_history_view.as_view()),\n                 name=\"order-list\",\n             ),\n+            re_path(\n+                r\"^order-status-form/(?P<order_number>[\\w-]*)/(?P<hash>[A-z0-9-_=:]+)/$\",\n+                self.anon_order_form_view.as_view(),\n+                name=\"anon-order-form\",\n+            ),\n             re_path(\n                 r\"^order-status/(?P<order_number>[\\w-]*)/(?P<hash>[A-z0-9-_=:]+)/$\",\n                 self.anon_order_detail_view.as_view(),\n"
        },
        {
            "commit": "58de72d97f1b19b44a141fbaa4cdd0411748f6ea",
            "file_path": "src/oscar/apps/customer/forms.py",
            "diff": "diff --git a/src/oscar/apps/customer/forms.py b/src/oscar/apps/customer/forms.py\nindex 8d414b2..7cc783e 100644\n--- a/src/oscar/apps/customer/forms.py\n+++ b/src/oscar/apps/customer/forms.py\n@@ -437,3 +437,7 @@ class ProductAlertForm(forms.ModelForm):\n     class Meta:\n         model = ProductAlert\n         fields = [\"email\"]\n+\n+\n+class AnonymousOrderForm(forms.Form):\n+    email = forms.EmailField(label=_(\"Email address\"))\n"
        },
        {
            "commit": "58de72d97f1b19b44a141fbaa4cdd0411748f6ea",
            "file_path": "src/oscar/apps/customer/mixins.py",
            "diff": "diff --git a/src/oscar/apps/customer/mixins.py b/src/oscar/apps/customer/mixins.py\nindex ee358e7..6b3a639 100644\n--- a/src/oscar/apps/customer/mixins.py\n+++ b/src/oscar/apps/customer/mixins.py\n@@ -10,6 +10,7 @@ from oscar.core.loading import get_class, get_model\n \n User = get_user_model()\n CommunicationEventType = get_model(\"communication\", \"CommunicationEventType\")\n+Order = get_model(\"order\", \"Order\")\n CustomerDispatcher = get_class(\"customer.utils\", \"CustomerDispatcher\")\n \n logger = logging.getLogger(\"oscar.customer\")\n@@ -85,3 +86,26 @@ class RegisterUserMixin(object):\n     def send_registration_email(self, user):\n         extra_context = {\"user\": user, \"request\": self.request}\n         CustomerDispatcher().send_registration_email_for_user(user, extra_context)\n+\n+\n+class AnonymousOrderMixin:\n+    @property\n+    def email(self):\n+        return self.request.session.get(\"anon_order_email\")\n+\n+    @property\n+    def order_number(self):\n+        return self.kwargs.get(\"order_number\")\n+\n+    @property\n+    def hash(self):\n+        return self.kwargs.get(\"hash\")\n+\n+    def get_object(self):\n+        try:\n+            order = Order.objects.get(user=None, number=self.order_number)\n+            if order.check_verification_hash(self.hash) and order.email == self.email:\n+                return order\n+        except (AttributeError, Order.DoesNotExist):\n+            return None\n+        return None\n"
        },
        {
            "commit": "58de72d97f1b19b44a141fbaa4cdd0411748f6ea",
            "file_path": "src/oscar/apps/customer/views.py",
            "diff": "diff --git a/src/oscar/apps/customer/views.py b/src/oscar/apps/customer/views.py\nindex 7f5b0a0..9f0b4a7 100644\n--- a/src/oscar/apps/customer/views.py\n+++ b/src/oscar/apps/customer/views.py\n@@ -19,6 +19,8 @@ from oscar.core.utils import safe_referrer\n from oscar.views.generic import PostActionMixin\n \n from . import signals\n+from .forms import AnonymousOrderForm\n+from .mixins import AnonymousOrderMixin\n \n PageTitleMixin, RegisterUserMixin = get_classes(\n     \"customer.mixins\", [\"PageTitleMixin\", \"RegisterUserMixin\"]\n@@ -625,18 +627,36 @@ class OrderLineView(PostActionMixin, generic.DetailView):\n         messages.info(self.request, msg)\n \n \n-class AnonymousOrderDetailView(generic.DetailView):\n+class AnonymousOrderFormView(AnonymousOrderMixin, generic.FormView):\n+    form_class = AnonymousOrderForm\n+    template_name = \"oscar/customer/anon_order_form.html\"\n+\n+    def form_valid(self, form):\n+        self.request.session[\"anon_order_email\"] = form.cleaned_data[\"email\"]\n+        if not self.get_object():\n+            form.add_error(None, _(\"Order not found\"))\n+            return self.form_invalid(form)\n+        return super().form_valid(form)\n+\n+    def get_success_url(self):\n+        return reverse(\n+            \"customer:anon-order\",\n+            kwargs={\"order_number\": self.order_number, \"hash\": self.hash},\n+        )\n+\n+\n+class AnonymousOrderDetailView(AnonymousOrderMixin, generic.DetailView):\n     model = Order\n     template_name = \"oscar/customer/anon_order.html\"\n \n-    def get_object(self, queryset=None):\n-        # Check URL hash matches that for order to prevent spoof attacks\n-        order = get_object_or_404(\n-            self.model, user=None, number=self.kwargs[\"order_number\"]\n-        )\n-        if not order.check_verification_hash(self.kwargs[\"hash\"]):\n-            raise http.Http404()\n-        return order\n+    def dispatch(self, request, *args, **kwargs):\n+        if not self.get_object():\n+            return redirect(\n+                \"customer:anon-order-form\",\n+                order_number=self.order_number,\n+                hash=self.hash,\n+            )\n+        return super().dispatch(request, *args, **kwargs)\n \n \n # ------------\n"
        },
        {
            "commit": "58de72d97f1b19b44a141fbaa4cdd0411748f6ea",
            "file_path": "src/oscar/templates/oscar/customer/anon_order_form.html",
            "diff": "diff --git a/src/oscar/templates/oscar/customer/anon_order_form.html b/src/oscar/templates/oscar/customer/anon_order_form.html\nnew file mode 100644\nindex 0000000..be1eac3\n--- /dev/null\n+++ b/src/oscar/templates/oscar/customer/anon_order_form.html\n@@ -0,0 +1,14 @@\n+{% extends \"oscar/layout.html\" %}\n+{% load i18n %}\n+{% block extrahead %}\n+    <meta name=\"robots\" content=\"noindex\">\n+{% endblock %}\n+{% block content %}\n+<form method=\"post\">{%csrf_token%}\n+    <p><h3>{% trans \"Enter the following information you used for this order\" %}</h3></p>\n+{{form.as_p}}\n+<button class=\"btn btn-secondary\" type=\"submit\">{% trans \"Submit\" %}</button>\n+\n+</form>\n+\n+{% endblock %}\n\\ No newline at end of file\n"
        }
    ]
}