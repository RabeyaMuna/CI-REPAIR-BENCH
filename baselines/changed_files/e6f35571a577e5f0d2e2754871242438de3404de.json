{
    "sha_fail": "e6f35571a577e5f0d2e2754871242438de3404de",
    "changed_files": [
        {
            "commit": "e6f35571a577e5f0d2e2754871242438de3404de",
            "file_path": "kitty/constants.py",
            "diff": "diff --git a/kitty/constants.py b/kitty/constants.py\nindex a888181..9244c28 100644\n--- a/kitty/constants.py\n+++ b/kitty/constants.py\n@@ -34,6 +34,7 @@ class Version(NamedTuple):\n kitty_run_data: dict[str, Any] = getattr(sys, 'kitty_run_data', {})\n launched_by_launch_services = kitty_run_data.get('launched_by_launch_services', False)\n is_quick_access_terminal_app = kitty_run_data.get('is_quick_access_terminal_app', False)\n+serialize_user_var_name = 'kitty_serialize_window_id'\n \n if getattr(sys, 'frozen', False):\n     extensions_dir: str = kitty_run_data['extensions_dir']\n"
        },
        {
            "commit": "e6f35571a577e5f0d2e2754871242438de3404de",
            "file_path": "kitty/layout/base.py",
            "diff": "diff --git a/kitty/layout/base.py b/kitty/layout/base.py\nindex 554e91a..acb30de 100644\n--- a/kitty/layout/base.py\n+++ b/kitty/layout/base.py\n@@ -7,10 +7,11 @@\n from typing import Any, NamedTuple\n \n from kitty.borders import BorderColor\n+from kitty.constants import serialize_user_var_name\n from kitty.fast_data_types import Region, set_active_window, viewport_for_window\n from kitty.options.types import Options\n-from kitty.types import Edges, WindowGeometry\n-from kitty.typing_compat import TypedDict, WindowMapper, WindowType\n+from kitty.types import Edges, WindowGeometry, WindowMapper\n+from kitty.typing_compat import TypedDict, WindowType\n from kitty.window_list import WindowGroup, WindowList\n \n \n@@ -437,16 +438,33 @@ def layout_action(self, action_name: str, args: Sequence[str], all_windows: Wind\n     def layout_state(self) -> dict[str, Any]:\n         return {}\n \n-    def set_layout_state(self, layout_state: dict[str, Any], map_window_id: WindowMapper) -> bool:\n+    def set_layout_state(self, layout_state: dict[str, Any], map_group_id: WindowMapper) -> bool:\n         return True\n \n-    def serialize(self) -> dict[str, Any]:\n+    def serialize(self, all_windows: WindowList) -> dict[str, Any]:\n         ans = self.layout_state()\n         ans['opts'] = self.layout_opts.serialized()\n         ans['class'] = self.__class__.__name__\n+        ans['all_windows'] = aw = all_windows.serialize_state()\n+        for wg in aw['window_groups']:\n+            wg['window_ids'] = tuple(w['id'] for w in aw.pop('windows'))\n         return ans\n \n-    def unserialize(self, s: dict[str, Any], map_window_id: WindowMapper) -> bool:\n+    def unserialize(\n+        self, s: dict[str, Any], all_windows: WindowList,\n+        serialize_user_var_name: str = serialize_user_var_name\n+    ) -> bool:\n         if s.get('class') != self.__class__.__name__:\n             return False\n-        return self.set_layout_state(s, map_window_id)\n+        window_id_map = {}\n+        for w in all_windows:\n+            k = w.user_vars.pop(serialize_user_var_name, None)\n+            if k is not None:\n+                try:\n+                    window_id_map[int(k)] = w.id\n+                except Exception:\n+                    pass\n+        m = all_windows.unserialize_layout_state(s['all_windows'], window_id_map)\n+        if m is None:\n+            return False\n+        return self.set_layout_state(s, m.get)\n"
        },
        {
            "commit": "e6f35571a577e5f0d2e2754871242438de3404de",
            "file_path": "kitty/layout/splits.py",
            "diff": "diff --git a/kitty/layout/splits.py b/kitty/layout/splits.py\nindex 2abb4d2..b0ef321 100644\n--- a/kitty/layout/splits.py\n+++ b/kitty/layout/splits.py\n@@ -5,8 +5,8 @@\n from typing import Any, NamedTuple, Optional, TypedDict, Union\n \n from kitty.borders import BorderColor\n-from kitty.types import Edges, WindowGeometry\n-from kitty.typing_compat import EdgeLiteral, WindowMapper, WindowType\n+from kitty.types import Edges, WindowGeometry, WindowMapper\n+from kitty.typing_compat import EdgeLiteral, WindowType\n from kitty.window_list import WindowGroup, WindowList\n \n from .base import BorderLine, Layout, LayoutOpts, NeighborsMap, blank_rects_for_window, lgd, window_geometry_from_layouts\n@@ -55,8 +55,7 @@ def unserialize(x: int | SerializedPair | None) -> int | Pair | None:\n             if x is None:\n                 return None\n             if isinstance(x, int):\n-                w = map_window_id(x)\n-                return None if w is None else w.id\n+                return map_window_id(x)\n             ans = Pair()\n             ans.unserialize(x, map_window_id)\n             return ans if ans.one or ans.two else None\n@@ -710,9 +709,9 @@ def layout_action(self, action_name: str, args: Sequence[str], all_windows: Wind\n     def layout_state(self) -> dict[str, Any]:\n         return {'pairs': self.pairs_root.serialize()}\n \n-    def set_layout_state(self, layout_state: dict[str, Any], map_window_id: WindowMapper) -> bool:\n+    def set_layout_state(self, layout_state: dict[str, Any], map_group_id: WindowMapper) -> bool:\n         new_root = Pair()\n-        new_root.unserialize(layout_state['pairs'], map_window_id)\n+        new_root.unserialize(layout_state['pairs'], map_group_id)\n         before = frozenset(self.pairs_root.all_window_ids())\n         if before == frozenset(new_root.all_window_ids()):\n             self.pairs_root = new_root\n"
        },
        {
            "commit": "e6f35571a577e5f0d2e2754871242438de3404de",
            "file_path": "kitty/tabs.py",
            "diff": "diff --git a/kitty/tabs.py b/kitty/tabs.py\nindex 3649d80..d64ecd3 100644\n--- a/kitty/tabs.py\n+++ b/kitty/tabs.py\n@@ -272,7 +272,7 @@ def serialize_state(self) -> dict[str, Any]:\n             'window_list': self.windows.serialize_state(),\n             'current_layout': self._current_layout_name,\n             'last_used_layout': self._last_used_layout,\n-            'layout_state': self.current_layout.serialize(),\n+            'layout_state': self.current_layout.serialize(self.windows),\n             'enabled_layouts': self.enabled_layouts,\n             'name': self.name,\n         }\n"
        },
        {
            "commit": "e6f35571a577e5f0d2e2754871242438de3404de",
            "file_path": "kitty/types.py",
            "diff": "diff --git a/kitty/types.py b/kitty/types.py\nindex 68bf40a..86416ce 100644\n--- a/kitty/types.py\n+++ b/kitty/types.py\n@@ -230,4 +230,5 @@ def w(f: _T) -> _T:\n     return w\n \n \n+WindowMapper = Callable[[int], int | None]\n DecoratedFunc = TypeVar('DecoratedFunc', bound=Callable[..., Any])\n"
        },
        {
            "commit": "e6f35571a577e5f0d2e2754871242438de3404de",
            "file_path": "kitty/typing_compat.py",
            "diff": "diff --git a/kitty/typing_compat.py b/kitty/typing_compat.py\nindex 22e6f5c..bdf2907 100644\n--- a/kitty/typing_compat.py\n+++ b/kitty/typing_compat.py\n@@ -23,4 +23,3 @@\n OptionsProtocol = object\n NotRequired = object\n CoreTextFont = FontConfigPattern = dict\n-WindowMapper = object\n"
        },
        {
            "commit": "e6f35571a577e5f0d2e2754871242438de3404de",
            "file_path": "kitty/typing_compat.pyi",
            "diff": "diff --git a/kitty/typing_compat.pyi b/kitty/typing_compat.pyi\nindex 5285188..9c95b07 100644\n--- a/kitty/typing_compat.pyi\n+++ b/kitty/typing_compat.pyi\n@@ -54,7 +54,6 @@ GRT_C = Literal[0, 1]\n GRT_d = Literal['a', 'A', 'c', 'C', 'i', 'I', 'p', 'P', 'q', 'Q', 'x', 'X', 'y', 'Y', 'z', 'Z', 'f', 'F']\n ReadableBuffer = bytes | bytearray | memoryview | array.array[int] | mmap.mmap\n WriteableBuffer = bytearray | memoryview | array.array[int] | mmap.mmap\n-WindowMapper = Callable[[int], WindowType | None]\n \n \n \n@@ -72,5 +71,5 @@ __all__ = (\n     'KeyActionType', 'KeyMap', 'KittyCommonOpts', 'AliasMap', 'CoreTextFont', 'WindowSystemMouseEvent',\n     'FontConfigPattern', 'ScreenType', 'StartupCtx', 'KeyEventType', 'LayoutType', 'PowerlineStyle',\n     'RemoteCommandType', 'SessionType', 'SessionTab', 'SpecialWindowInstance', 'TabType', 'ScreenSize', 'WindowType',\n-    'ReadableBuffer', 'WriteableBuffer', 'WindowMapper',\n+    'ReadableBuffer', 'WriteableBuffer',\n )\n"
        },
        {
            "commit": "e6f35571a577e5f0d2e2754871242438de3404de",
            "file_path": "kitty/window_list.py",
            "diff": "diff --git a/kitty/window_list.py b/kitty/window_list.py\nindex 0c4055f..6c01829 100644\n--- a/kitty/window_list.py\n+++ b/kitty/window_list.py\n@@ -6,7 +6,7 @@\n from collections.abc import Iterator\n from contextlib import suppress\n from itertools import count\n-from typing import Any, Deque, Union\n+from typing import Any, Deque, Sequence, Union\n \n from .fast_data_types import Color, get_options\n from .types import OverlayType, WindowGeometry\n@@ -48,6 +48,12 @@ def __contains__(self, window: WindowType) -> bool:\n                 return True\n         return False\n \n+    def has_window_id(self, wid: int) -> bool:\n+        for w in self.windows:\n+            if w.id == wid:\n+                return True\n+        return False\n+\n     @property\n     def needs_attention(self) -> bool:\n         for w in self.windows:\n@@ -93,6 +99,12 @@ def serialize_state(self) -> dict[str, Any]:\n             'windows': [w.serialize_state() for w in self.windows]\n         }\n \n+    def unserialize_layout_state(self, window_ids: Sequence[int]) -> None:\n+        order_map = {wid: i for i, wid in enumerate(window_ids)}\n+        def sort_key(w: WindowType) -> int:\n+            return order_map.get(w.id, -1)\n+        self.windows.sort(key=sort_key)\n+\n     def as_simple_dict(self) -> dict[str, Any]:\n         return {\n             'id': self.id,\n@@ -173,6 +185,55 @@ def serialize_state(self) -> dict[str, Any]:\n             'window_groups': [g.serialize_state() for g in self.groups]\n         }\n \n+    def unserialize_layout_state(self, state: dict[str, Any], window_id_map: dict[int, int]) -> dict[int, int] | None:\n+        if set(window_id_map.values()) != set(self.id_map):\n+            # some window in this collection does not correspond to a\n+            # serialized window\n+            return None\n+        ans = {}\n+        gmap = {g.id: g for g in self.groups}\n+        present_wids_map = {g.id: {w.id for w in g} for g in self.groups}\n+\n+        def unmapped_group_having_subset_of_windows(wids: Sequence[int]) -> Iterator[WindowGroup]:\n+            mapped_wids = set()\n+            for wid in wids:\n+                new_wid = window_id_map.get(wid)\n+                if new_wid is not None:\n+                    mapped_wids.add(new_wid)\n+            for gid in tuple(gmap):\n+                present_wids = present_wids_map[gid]\n+                if present_wids.issubset(mapped_wids):\n+                    yield gmap.pop(gid)\n+                    break\n+\n+        for wg in state['window_groups']:\n+            old_group_id = wg['id']\n+            for group in unmapped_group_having_subset_of_windows(wg['window_ids']):\n+                ans[old_group_id] = group.id\n+        # check that all the groups present were also in the serialized state.\n+        # there could have been extra windows/groups in the serialized state,\n+        # we ignore them.\n+        if len(ans) != len(self.groups):\n+            return None\n+        gmap = {g.id: g for g in self.groups}\n+        groups = []\n+        for wg in state['window_groups']:\n+            old_group_id = wg['id']\n+            if new_group_id := ans.get(old_group_id):\n+                groups.append((g := gmap[new_group_id]))\n+                new_window_ids = []\n+                for old_window_id in wg['window_ids']:\n+                    if new_window_id := window_id_map.get(old_window_id):\n+                        new_window_ids.append(new_window_id)\n+                g.unserialize_layout_state(new_window_ids)\n+        self.groups = groups\n+        history = []\n+        for old_wid in state['active_group_history']:\n+            if new_wid := window_id_map.get(old_wid):\n+                history.append(new_wid)\n+        self.active_group_history = deque(history, 64)\n+        return ans\n+\n     @property\n     def active_group_idx(self) -> int:\n         return self._active_group_idx\n"
        }
    ]
}