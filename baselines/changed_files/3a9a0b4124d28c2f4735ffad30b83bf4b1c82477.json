{
    "sha_fail": "3a9a0b4124d28c2f4735ffad30b83bf4b1c82477",
    "changed_files": [
        {
            "commit": "3a9a0b4124d28c2f4735ffad30b83bf4b1c82477",
            "file_path": "cookbook/agent_concepts/state/last_n_session_messages.py",
            "diff": "diff --git a/cookbook/agent_concepts/state/last_n_session_messages.py b/cookbook/agent_concepts/state/last_n_session_messages.py\nindex 4f6794cc3..13e6dab45 100644\n--- a/cookbook/agent_concepts/state/last_n_session_messages.py\n+++ b/cookbook/agent_concepts/state/last_n_session_messages.py\n@@ -1,9 +1,10 @@\n+# Remove the tmp db file before running the script\n+import os\n+\n from agno.agent import Agent\n from agno.models.openai import OpenAIChat\n from agno.storage.sqlite import SqliteStorage\n \n-# Remove the tmp db file before running the script\n-import os\n os.remove(\"tmp/data.db\")\n \n agent = Agent(\n@@ -12,8 +13,8 @@ agent = Agent(\n     storage=SqliteStorage(table_name=\"agent_sessions_new\", db_file=\"tmp/data.db\"),\n     add_history_to_messages=True,\n     num_history_runs=3,\n-    search_previous_sessions_history=True,\n-    num_history_sessions=2,\n+    search_previous_sessions_history=True, # allow searching previous sessions\n+    num_history_sessions=2, # only include the last 2 sessions in the search to avoid context length issues\n     show_tool_calls=True,\n )\n \n"
        },
        {
            "commit": "3a9a0b4124d28c2f4735ffad30b83bf4b1c82477",
            "file_path": "libs/agno/agno/agent/agent.py",
            "diff": "diff --git a/libs/agno/agno/agent/agent.py b/libs/agno/agno/agent/agent.py\nindex bcef8ad3f..6bceb711b 100644\n--- a/libs/agno/agno/agent/agent.py\n+++ b/libs/agno/agno/agent/agent.py\n@@ -7243,9 +7243,7 @@ class Agent:\n             if self.storage is None:\n                 return \"Storage not available\"\n \n-            selected_sessions = self.storage.get_last_n_sessions(\n-                num_history_sessions=num_history_sessions, user_id=user_id\n-            )\n+            selected_sessions = self.storage.get_recent_sessions(limit=num_history_sessions, user_id=user_id)\n \n             all_messages = []\n             seen_message_pairs = set()\n"
        },
        {
            "commit": "3a9a0b4124d28c2f4735ffad30b83bf4b1c82477",
            "file_path": "libs/agno/agno/storage/base.py",
            "diff": "diff --git a/libs/agno/agno/storage/base.py b/libs/agno/agno/storage/base.py\nindex 325ae58c8..c44ad3c8f 100644\n--- a/libs/agno/agno/storage/base.py\n+++ b/libs/agno/agno/storage/base.py\n@@ -35,8 +35,11 @@ class Storage(ABC):\n         raise NotImplementedError\n \n     @abstractmethod\n-    def get_last_n_sessions(\n-        self, user_id: Optional[str] = None, entity_id: Optional[str] = None, limit: Optional[int] = 2, \n+    def get_recent_sessions(\n+        self,\n+        user_id: Optional[str] = None,\n+        entity_id: Optional[str] = None,\n+        limit: Optional[int] = 2,\n     ) -> List[Session]:\n         raise NotImplementedError\n \n"
        },
        {
            "commit": "3a9a0b4124d28c2f4735ffad30b83bf4b1c82477",
            "file_path": "libs/agno/agno/storage/dynamodb.py",
            "diff": "diff --git a/libs/agno/agno/storage/dynamodb.py b/libs/agno/agno/storage/dynamodb.py\nindex cc60fcd1a..b9a472f81 100644\n--- a/libs/agno/agno/storage/dynamodb.py\n+++ b/libs/agno/agno/storage/dynamodb.py\n@@ -394,8 +394,11 @@ class DynamoDbStorage(Storage):\n             logger.error(f\"Error retrieving sessions: {e}\")\n         return sessions\n \n-    def get_last_n_sessions(\n-        self, num_history_sessions: Optional[int] = 3, user_id: Optional[str] = None, entity_id: Optional[str] = None\n+    def get_recent_sessions(\n+        self,\n+        user_id: Optional[str] = None,\n+        entity_id: Optional[str] = None,\n+        limit: Optional[int] = 2,\n     ) -> List[Session]:\n         \"\"\"Get the last N sessions, ordered by created_at descending.\n \n@@ -416,7 +419,7 @@ class DynamoDbStorage(Storage):\n                         KeyConditionExpression=Key(\"user_id\").eq(user_id),\n                         ProjectionExpression=\"session_id, agent_id, user_id, team_session_id, memory, agent_data, session_data, extra_data, created_at, updated_at\",\n                         ScanIndexForward=False,\n-                        Limit=num_history_sessions if num_history_sessions is not None else None,\n+                        Limit=limit if limit is not None else None,\n                     )\n                 elif self.mode == \"team\":\n                     response = self.table.query(\n@@ -424,7 +427,7 @@ class DynamoDbStorage(Storage):\n                         KeyConditionExpression=Key(\"user_id\").eq(user_id),\n                         ProjectionExpression=\"session_id, team_id, user_id, team_session_id, memory, team_data, session_data, extra_data, created_at, updated_at\",\n                         ScanIndexForward=False,\n-                        Limit=num_history_sessions if num_history_sessions is not None else None,\n+                        Limit=limit if limit is not None else None,\n                     )\n                 elif self.mode == \"workflow\":\n                     response = self.table.query(\n@@ -432,7 +435,7 @@ class DynamoDbStorage(Storage):\n                         KeyConditionExpression=Key(\"user_id\").eq(user_id),\n                         ProjectionExpression=\"session_id, workflow_id, user_id, memory, workflow_data, session_data, extra_data, created_at, updated_at\",\n                         ScanIndexForward=False,\n-                        Limit=num_history_sessions if num_history_sessions is not None else None,\n+                        Limit=limit if limit is not None else None,\n                     )\n             elif entity_id is not None:\n                 if self.mode == \"agent\":\n@@ -441,7 +444,7 @@ class DynamoDbStorage(Storage):\n                         KeyConditionExpression=Key(\"agent_id\").eq(entity_id),\n                         ProjectionExpression=\"session_id, agent_id, user_id, team_session_id, memory, agent_data, session_data, extra_data, created_at, updated_at\",\n                         ScanIndexForward=False,\n-                        Limit=num_history_sessions if num_history_sessions is not None else None,\n+                        Limit=limit if limit is not None else None,\n                     )\n                 elif self.mode == \"team\":\n                     response = self.table.query(\n@@ -449,7 +452,7 @@ class DynamoDbStorage(Storage):\n                         KeyConditionExpression=Key(\"team_id\").eq(entity_id),\n                         ProjectionExpression=\"session_id, team_id, user_id, team_session_id, memory, team_data, session_data, extra_data, created_at, updated_at\",\n                         ScanIndexForward=False,\n-                        Limit=num_history_sessions if num_history_sessions is not None else None,\n+                        Limit=limit if limit is not None else None,\n                     )\n                 elif self.mode == \"workflow\":\n                     response = self.table.query(\n@@ -457,24 +460,24 @@ class DynamoDbStorage(Storage):\n                         KeyConditionExpression=Key(\"workflow_id\").eq(entity_id),\n                         ProjectionExpression=\"session_id, workflow_id, user_id, memory, workflow_data, session_data, extra_data, created_at, updated_at\",\n                         ScanIndexForward=False,\n-                        Limit=num_history_sessions if num_history_sessions is not None else None,\n+                        Limit=limit if limit is not None else None,\n                     )\n             else:\n                 # If no filters, scan the table and sort by created_at\n                 if self.mode == \"agent\":\n                     response = self.table.scan(\n                         ProjectionExpression=\"session_id, agent_id, user_id, team_session_id, memory, agent_data, session_data, extra_data, created_at, updated_at\",\n-                        Limit=num_history_sessions if num_history_sessions is not None else None,\n+                        Limit=limit if limit is not None else None,\n                     )\n                 elif self.mode == \"team\":\n                     response = self.table.scan(\n                         ProjectionExpression=\"session_id, team_id, user_id, team_session_id, memory, team_data, session_data, extra_data, created_at, updated_at\",\n-                        Limit=num_history_sessions if num_history_sessions is not None else None,\n+                        Limit=limit if limit is not None else None,\n                     )\n                 elif self.mode == \"workflow\":\n                     response = self.table.scan(\n                         ProjectionExpression=\"session_id, workflow_id, user_id, memory, workflow_data, session_data, extra_data, created_at, updated_at\",\n-                        Limit=num_history_sessions if num_history_sessions is not None else None,\n+                        Limit=limit if limit is not None else None,\n                     )\n \n             items = response.get(\"Items\", [])\n@@ -493,7 +496,7 @@ class DynamoDbStorage(Storage):\n                     sessions.append(session)\n \n         except Exception as e:\n-            logger.error(f\"Error getting last {num_history_sessions} sessions: {e}\")\n+            logger.error(f\"Error getting last {limit} sessions: {e}\")\n \n         return sessions\n \n"
        },
        {
            "commit": "3a9a0b4124d28c2f4735ffad30b83bf4b1c82477",
            "file_path": "libs/agno/agno/storage/gcs_json.py",
            "diff": "diff --git a/libs/agno/agno/storage/gcs_json.py b/libs/agno/agno/storage/gcs_json.py\nindex 4f509b52b..b33575953 100644\n--- a/libs/agno/agno/storage/gcs_json.py\n+++ b/libs/agno/agno/storage/gcs_json.py\n@@ -143,8 +143,11 @@ class GCSJsonStorage(JsonStorage):\n                     continue\n         return sessions\n \n-    def get_last_n_sessions(\n-        self, num_history_sessions: Optional[int] = 3, user_id: Optional[str] = None, entity_id: Optional[str] = None\n+    def get_recent_sessions(\n+        self,\n+        user_id: Optional[str] = None,\n+        entity_id: Optional[str] = None,\n+        limit: Optional[int] = 2,\n     ) -> List[Session]:\n         \"\"\"Get the last N sessions, ordered by created_at descending.\n \n@@ -184,8 +187,8 @@ class GCSJsonStorage(JsonStorage):\n \n             # Sort by created_at descending and take only num_history_sessions\n             session_data.sort(key=lambda x: x[0], reverse=True)\n-            if num_history_sessions is not None:\n-                session_data = session_data[:num_history_sessions]\n+            if limit is not None:\n+                session_data = session_data[:limit]\n \n             # Convert filtered and sorted data to Session objects\n             for _, data in session_data:\n@@ -201,7 +204,7 @@ class GCSJsonStorage(JsonStorage):\n                     sessions.append(session)\n \n         except Exception as e:\n-            logger.error(f\"Error getting last {num_history_sessions} sessions: {e}\")\n+            logger.error(f\"Error getting last {limit} sessions: {e}\")\n \n         return sessions\n \n"
        },
        {
            "commit": "3a9a0b4124d28c2f4735ffad30b83bf4b1c82477",
            "file_path": "libs/agno/agno/storage/json.py",
            "diff": "diff --git a/libs/agno/agno/storage/json.py b/libs/agno/agno/storage/json.py\nindex a3780a03a..79077baf7 100644\n--- a/libs/agno/agno/storage/json.py\n+++ b/libs/agno/agno/storage/json.py\n@@ -122,8 +122,11 @@ class JsonStorage(Storage):\n                         sessions.append(_session)\n         return sessions\n \n-    def get_last_n_sessions(\n-        self, num_history_sessions: Optional[int] = 3, user_id: Optional[str] = None, entity_id: Optional[str] = None\n+    def get_recent_sessions(\n+        self,\n+        user_id: Optional[str] = None,\n+        entity_id: Optional[str] = None,\n+        limit: Optional[int] = 2,\n     ) -> List[Session]:\n         \"\"\"Get the last N sessions, ordered by created_at descending.\n \n@@ -166,8 +169,8 @@ class JsonStorage(Storage):\n \n         # Sort by created_at descending and take only num_history_sessions\n         session_data.sort(key=lambda x: x[0], reverse=True)\n-        if num_history_sessions is not None:\n-            session_data = session_data[:num_history_sessions]\n+        if limit is not None:\n+            session_data = session_data[:limit]\n \n         # Convert filtered and sorted data to Session objects\n         for _, data in session_data:\n"
        },
        {
            "commit": "3a9a0b4124d28c2f4735ffad30b83bf4b1c82477",
            "file_path": "libs/agno/agno/storage/mongodb.py",
            "diff": "diff --git a/libs/agno/agno/storage/mongodb.py b/libs/agno/agno/storage/mongodb.py\nindex 4d2014c48..dddd7b33c 100644\n--- a/libs/agno/agno/storage/mongodb.py\n+++ b/libs/agno/agno/storage/mongodb.py\n@@ -165,8 +165,11 @@ class MongoDbStorage(Storage):\n             logger.error(f\"Error getting sessions: {e}\")\n             return []\n \n-    def get_last_n_sessions(\n-        self, num_history_sessions: Optional[int] = 2, user_id: Optional[str] = None, entity_id: Optional[str] = None\n+    def get_recent_sessions(\n+        self,\n+        user_id: Optional[str] = None,\n+        entity_id: Optional[str] = None,\n+        limit: Optional[int] = 2,\n     ) -> List[Session]:\n         \"\"\"Get the last N sessions, ordered by created_at descending.\n \n@@ -194,8 +197,8 @@ class MongoDbStorage(Storage):\n             # Execute query with sort and limit\n             cursor = self.collection.find(query)\n             cursor = cursor.sort(\"created_at\", -1)  # Sort by created_at descending\n-            if num_history_sessions is not None:\n-                cursor = cursor.limit(num_history_sessions)\n+            if limit is not None:\n+                cursor = cursor.limit(limit)\n \n             sessions: List[Session] = []\n             for doc in cursor:\n@@ -216,7 +219,7 @@ class MongoDbStorage(Storage):\n             return sessions\n \n         except PyMongoError as e:\n-            logger.error(f\"Error getting last {num_history_sessions} sessions: {e}\")\n+            logger.error(f\"Error getting last {limit} sessions: {e}\")\n             return []\n \n     def upsert(self, session: Session, create_and_retry: bool = True) -> Optional[Session]:\n"
        },
        {
            "commit": "3a9a0b4124d28c2f4735ffad30b83bf4b1c82477",
            "file_path": "libs/agno/agno/storage/postgres.py",
            "diff": "diff --git a/libs/agno/agno/storage/postgres.py b/libs/agno/agno/storage/postgres.py\nindex 74ebbc0e0..d32ad0ee7 100644\n--- a/libs/agno/agno/storage/postgres.py\n+++ b/libs/agno/agno/storage/postgres.py\n@@ -353,8 +353,11 @@ class PostgresStorage(Storage):\n             self.create()\n         return []\n \n-    def get_last_n_sessions(\n-        self, num_history_sessions: Optional[int] = 3, user_id: Optional[str] = None, entity_id: Optional[str] = None\n+    def get_recent_sessions(\n+        self,\n+        user_id: Optional[str] = None,\n+        entity_id: Optional[str] = None,\n+        limit: Optional[int] = 2,\n     ) -> List[Session]:\n         \"\"\"Get the last N sessions, ordered by created_at descending.\n \n@@ -384,8 +387,8 @@ class PostgresStorage(Storage):\n \n                 # Order by created_at desc and limit results\n                 stmt = stmt.order_by(self.table.c.created_at.desc())\n-                if num_history_sessions is not None:\n-                    stmt = stmt.limit(num_history_sessions)\n+                if limit is not None:\n+                    stmt = stmt.limit(limit)\n \n                 # Execute query\n                 rows = sess.execute(stmt).fetchall()\n"
        },
        {
            "commit": "3a9a0b4124d28c2f4735ffad30b83bf4b1c82477",
            "file_path": "libs/agno/agno/storage/redis.py",
            "diff": "diff --git a/libs/agno/agno/storage/redis.py b/libs/agno/agno/storage/redis.py\nindex 48f186aea..39123094e 100644\n--- a/libs/agno/agno/storage/redis.py\n+++ b/libs/agno/agno/storage/redis.py\n@@ -189,8 +189,11 @@ class RedisStorage(Storage):\n \n         return sessions\n \n-    def get_last_n_sessions(\n-        self, num_history_sessions: Optional[int] = 3, user_id: Optional[str] = None, entity_id: Optional[str] = None\n+    def get_recent_sessions(\n+        self,\n+        user_id: Optional[str] = None,\n+        entity_id: Optional[str] = None,\n+        limit: Optional[int] = 2,\n     ) -> List[Session]:\n         \"\"\"Get the last N sessions, ordered by created_at descending.\n \n@@ -234,8 +237,8 @@ class RedisStorage(Storage):\n \n             # Sort by created_at descending and take only num_history_sessions\n             session_data.sort(key=lambda x: x[0], reverse=True)\n-            if num_history_sessions is not None:\n-                session_data = session_data[:num_history_sessions]\n+            if limit is not None:\n+                session_data = session_data[:limit]\n \n             # Convert filtered and sorted data to Session objects\n             for _, data in session_data:\n@@ -251,7 +254,7 @@ class RedisStorage(Storage):\n                     sessions.append(session)\n \n         except Exception as e:\n-            logger.error(f\"Error getting last {num_history_sessions} sessions: {e}\")\n+            logger.error(f\"Error getting last {limit} sessions: {e}\")\n \n         return sessions\n \n"
        },
        {
            "commit": "3a9a0b4124d28c2f4735ffad30b83bf4b1c82477",
            "file_path": "libs/agno/agno/storage/singlestore.py",
            "diff": "diff --git a/libs/agno/agno/storage/singlestore.py b/libs/agno/agno/storage/singlestore.py\nindex c2daffd11..c168b2564 100644\n--- a/libs/agno/agno/storage/singlestore.py\n+++ b/libs/agno/agno/storage/singlestore.py\n@@ -236,8 +236,11 @@ class SingleStoreStorage(Storage):\n             log_debug(f\"Table does not exist: {self.table.name}\")\n         return sessions\n \n-    def get_last_n_sessions(\n-        self, num_history_sessions: Optional[int] = 3, user_id: Optional[str] = None, entity_id: Optional[str] = None\n+    def get_recent_sessions(\n+        self,\n+        user_id: Optional[str] = None,\n+        entity_id: Optional[str] = None,\n+        limit: Optional[int] = 2,\n     ) -> List[Session]:\n         \"\"\"Get the last N sessions, ordered by created_at descending.\n \n@@ -268,8 +271,8 @@ class SingleStoreStorage(Storage):\n \n                 # Order by created_at desc and limit results\n                 stmt = stmt.order_by(self.table.c.created_at.desc())\n-                if num_history_sessions is not None:\n-                    stmt = stmt.limit(num_history_sessions)\n+                if limit is not None:\n+                    stmt = stmt.limit(limit)\n \n                 # Execute query\n                 rows = sess.execute(stmt).fetchall()\n"
        },
        {
            "commit": "3a9a0b4124d28c2f4735ffad30b83bf4b1c82477",
            "file_path": "libs/agno/agno/storage/sqlite.py",
            "diff": "diff --git a/libs/agno/agno/storage/sqlite.py b/libs/agno/agno/storage/sqlite.py\nindex c6a0dd7db..d72409d4d 100644\n--- a/libs/agno/agno/storage/sqlite.py\n+++ b/libs/agno/agno/storage/sqlite.py\n@@ -331,8 +331,11 @@ class SqliteStorage(Storage):\n                 log_debug(f\"Exception reading from table: {e}\")\n         return []\n \n-    def get_last_n_sessions(\n-        self, num_history_sessions: Optional[int] = 2, user_id: Optional[str] = None, entity_id: Optional[str] = None\n+    def get_recent_sessions(\n+        self,\n+        user_id: Optional[str] = None,\n+        entity_id: Optional[str] = None,\n+        limit: Optional[int] = 2,\n     ) -> List[Session]:\n         \"\"\"\n         Get the last N sessions, ordered by created_at descending.\n@@ -361,8 +364,8 @@ class SqliteStorage(Storage):\n \n                 # Order by created_at desc and limit to num_history_sessions\n                 stmt = stmt.order_by(self.table.c.created_at.desc())\n-                if num_history_sessions is not None:\n-                    stmt = stmt.limit(num_history_sessions)\n+                if limit is not None:\n+                    stmt = stmt.limit(limit)\n \n                 # Execute query\n                 rows = sess.execute(stmt).fetchall()\n"
        },
        {
            "commit": "3a9a0b4124d28c2f4735ffad30b83bf4b1c82477",
            "file_path": "libs/agno/agno/storage/yaml.py",
            "diff": "diff --git a/libs/agno/agno/storage/yaml.py b/libs/agno/agno/storage/yaml.py\nindex b0f65fb70..fdd874ed4 100644\n--- a/libs/agno/agno/storage/yaml.py\n+++ b/libs/agno/agno/storage/yaml.py\n@@ -122,8 +122,11 @@ class YamlStorage(Storage):\n                         sessions.append(_session)\n         return sessions\n \n-    def get_last_n_sessions(\n-        self, num_history_sessions: Optional[int] = 2, user_id: Optional[str] = None, entity_id: Optional[str] = None\n+    def get_recent_sessions(\n+        self,\n+        user_id: Optional[str] = None,\n+        entity_id: Optional[str] = None,\n+        limit: Optional[int] = 2,\n     ) -> List[Session]:\n         \"\"\"Get the last N sessions, ordered by created_at descending.\n \n@@ -166,8 +169,8 @@ class YamlStorage(Storage):\n \n         # Sort by created_at descending and take only num_history_sessions\n         session_data.sort(key=lambda x: x[0], reverse=True)\n-        if num_history_sessions is not None:\n-            session_data = session_data[:num_history_sessions]\n+        if limit is not None:\n+            session_data = session_data[:limit]\n \n         # Convert filtered and sorted data to Session objects\n         for _, data in session_data:\n"
        }
    ]
}