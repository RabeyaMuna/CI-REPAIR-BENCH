{
    "sha_fail": "3ce7b9cb7b89ed8330621bdb0acb809eb830d687",
    "changed_files": [
        {
            "commit": "3ce7b9cb7b89ed8330621bdb0acb809eb830d687",
            "file_path": "README.rst",
            "diff": "diff --git a/README.rst b/README.rst\nindex 088a322..d597f57 100755\n--- a/README.rst\n+++ b/README.rst\n@@ -63,7 +63,8 @@ Features\n \n - Implementation of all General, Market Data and Account endpoints.\n - Asyncio implementation\n-- Testnet support for Spot, Futures and Vanilla Options\n+- Demo trading support (by providing demo=True)\n+- Testnet support for Spot, Futures and Vanilla Options (deprecated)\n - Simple handling of authentication include RSA and EDDSA keys\n - No need to generate timestamps yourself, the wrapper does it for you\n - RecvWindow sent by default\n"
        },
        {
            "commit": "3ce7b9cb7b89ed8330621bdb0acb809eb830d687",
            "file_path": "binance/async_client.py",
            "diff": "diff --git a/binance/async_client.py b/binance/async_client.py\nindex 177aac6..f0be76f 100644\n--- a/binance/async_client.py\n+++ b/binance/async_client.py\n@@ -31,6 +31,7 @@ class AsyncClient(BaseClient):\n         tld: str = \"com\",\n         base_endpoint: str = BaseClient.BASE_ENDPOINT_DEFAULT,\n         testnet: bool = False,\n+        demo: bool = False,\n         loop=None,\n         session_params: Optional[Dict[str, Any]] = None,\n         private_key: Optional[Union[str, Path]] = None,\n@@ -41,6 +42,15 @@ class AsyncClient(BaseClient):\n         self.https_proxy = https_proxy\n         self.loop = loop or get_loop()\n         self._session_params: Dict[str, Any] = session_params or {}\n+        \n+        # Convert https_proxy to requests_params format for BaseClient\n+        if https_proxy and requests_params is None:\n+            requests_params = {'proxies': {'http': https_proxy, 'https': https_proxy}}\n+        elif https_proxy and requests_params is not None:\n+            if 'proxies' not in requests_params:\n+                requests_params['proxies'] = {}\n+            requests_params['proxies'].update({'http': https_proxy, 'https': https_proxy})\n+        \n         super().__init__(\n             api_key,\n             api_secret,\n@@ -48,6 +58,7 @@ class AsyncClient(BaseClient):\n             tld,\n             base_endpoint,\n             testnet,\n+            demo,\n             private_key,\n             private_key_pass,\n             time_unit=time_unit,\n@@ -62,6 +73,7 @@ class AsyncClient(BaseClient):\n         tld: str = \"com\",\n         base_endpoint: str = BaseClient.BASE_ENDPOINT_DEFAULT,\n         testnet: bool = False,\n+        demo: bool = False,\n         loop=None,\n         session_params: Optional[Dict[str, Any]] = None,\n         private_key: Optional[Union[str, Path]] = None,\n@@ -76,6 +88,7 @@ class AsyncClient(BaseClient):\n             tld,\n             base_endpoint,\n             testnet,\n+            demo,\n             loop,\n             session_params,\n             private_key,\n@@ -151,6 +164,9 @@ class AsyncClient(BaseClient):\n             url_encoded_data = urlencode(dict_data)\n             data = f\"{url_encoded_data}&signature={signature}\"\n \n+        # Remove proxies from kwargs since aiohttp uses 'proxy' parameter instead\n+        kwargs.pop('proxies', None)\n+        \n         async with getattr(self.session, method)(\n             yarl.URL(uri, encoded=True),\n             proxy=self.https_proxy,\n@@ -1876,6 +1892,77 @@ class AsyncClient(BaseClient):\n             params[\"newClientOrderId\"] = self.CONTRACT_ORDER_PREFIX + self.uuid22()\n         return await self._request_futures_api(\"post\", \"order\", True, data=params)\n \n+    async def futures_limit_order(self, **params):\n+        \"\"\"Send in a new futures limit order.\n+\n+        https://developers.binance.com/docs/derivatives/usds-margined-futures/trade/rest-api\n+\n+        \"\"\"\n+        if \"newClientOrderId\" not in params:\n+            params[\"newClientOrderId\"] = self.CONTRACT_ORDER_PREFIX + self.uuid22()\n+        params[\"type\"] = \"LIMIT\"\n+        return await self._request_futures_api(\"post\", \"order\", True, data=params)\n+\n+    async def futures_market_order(self, **params):\n+        \"\"\"Send in a new futures market order.\n+\n+        https://developers.binance.com/docs/derivatives/usds-margined-futures/trade/rest-api\n+\n+        \"\"\"\n+        if \"newClientOrderId\" not in params:\n+            params[\"newClientOrderId\"] = self.CONTRACT_ORDER_PREFIX + self.uuid22()\n+        params[\"type\"] = \"MARKET\"\n+        return await self._request_futures_api(\"post\", \"order\", True, data=params)\n+\n+\n+    async def futures_limit_buy_order(self, **params):\n+        \"\"\"Send in a new futures limit buy order.\n+\n+        https://developers.binance.com/docs/derivatives/usds-margined-futures/trade/rest-api\n+\n+        \"\"\"\n+        if \"newClientOrderId\" not in params:\n+            params[\"newClientOrderId\"] = self.CONTRACT_ORDER_PREFIX + self.uuid22()\n+        params[\"side\"] = \"BUY\"\n+        params[\"type\"] = \"LIMIT\"\n+        return await self._request_futures_api(\"post\", \"order\", True, data=params)\n+\n+    async def futures_limit_sell_order(self, **params):\n+        \"\"\"Send in a new futures limit sell order.\n+\n+        https://developers.binance.com/docs/derivatives/usds-margined-futures/trade/rest-api\n+\n+        \"\"\"\n+        if \"newClientOrderId\" not in params:\n+            params[\"newClientOrderId\"] = self.CONTRACT_ORDER_PREFIX + self.uuid22()\n+        params[\"side\"] = \"SELL\"\n+        params[\"type\"] = \"LIMIT\"\n+        return await self._request_futures_api(\"post\", \"order\", True, data=params)\n+\n+    async def futures_market_buy_order(self, **params):\n+        \"\"\"Send in a new futures market buy order.\n+\n+        https://developers.binance.com/docs/derivatives/usds-margined-futures/trade/rest-api\n+\n+        \"\"\"\n+        if \"newClientOrderId\" not in params:\n+            params[\"newClientOrderId\"] = self.CONTRACT_ORDER_PREFIX + self.uuid22()\n+        params[\"side\"] = \"BUY\"\n+        params[\"type\"] = \"MARKET\"\n+        return await self._request_futures_api(\"post\", \"order\", True, data=params)\n+\n+    async def futures_market_sell_order(self, **params):\n+        \"\"\"Send in a new futures market sell order.\n+\n+        https://developers.binance.com/docs/derivatives/usds-margined-futures/trade/rest-api\n+\n+        \"\"\"\n+        if \"newClientOrderId\" not in params:\n+            params[\"newClientOrderId\"] = self.CONTRACT_ORDER_PREFIX + self.uuid22()\n+        params[\"side\"] = \"SELL\"\n+        params[\"type\"] = \"MARKET\"\n+        return await self._request_futures_api(\"post\", \"order\", True, data=params)\n+\n     async def futures_modify_order(self, **params):\n         \"\"\"Modify an existing order. Currently only LIMIT order modification is supported.\n \n"
        },
        {
            "commit": "3ce7b9cb7b89ed8330621bdb0acb809eb830d687",
            "file_path": "binance/base_client.py",
            "diff": "diff --git a/binance/base_client.py b/binance/base_client.py\nindex 8e1cd54..1237922 100644\n--- a/binance/base_client.py\n+++ b/binance/base_client.py\n@@ -22,14 +22,17 @@ from .helpers import get_loop\n class BaseClient:\n     API_URL = \"https://api{}.binance.{}/api\"\n     API_TESTNET_URL = \"https://testnet.binance.vision/api\"\n+    API_DEMO_URL = \"https://demo-api.binance.com/api\"\n     MARGIN_API_URL = \"https://api{}.binance.{}/sapi\"\n     WEBSITE_URL = \"https://www.binance.{}\"\n     FUTURES_URL = \"https://fapi.binance.{}/fapi\"\n     FUTURES_TESTNET_URL = \"https://testnet.binancefuture.com/fapi\"\n+    FUTURES_DEMO_URL = \"https://demo-fapi.binance.com/fapi\"\n     FUTURES_DATA_URL = \"https://fapi.binance.{}/futures/data\"\n     FUTURES_DATA_TESTNET_URL = \"https://testnet.binancefuture.com/futures/data\"\n     FUTURES_COIN_URL = \"https://dapi.binance.{}/dapi\"\n     FUTURES_COIN_TESTNET_URL = \"https://testnet.binancefuture.com/dapi\"\n+    FUTURES_COIN_DEMO_URL = \"https://demo-dapi.binance.com/dapi\"\n     FUTURES_COIN_DATA_URL = \"https://dapi.binance.{}/futures/data\"\n     FUTURES_COIN_DATA_TESTNET_URL = \"https://testnet.binancefuture.com/futures/data\"\n     OPTIONS_URL = \"https://eapi.binance.{}/eapi\"\n@@ -37,8 +40,10 @@ class BaseClient:\n     PAPI_URL = \"https://papi.binance.{}/papi\"\n     WS_API_URL = \"wss://ws-api.binance.{}/ws-api/v3\"\n     WS_API_TESTNET_URL = \"wss://ws-api.testnet.binance.vision/ws-api/v3\"\n+    WS_API_DEMO_URL = \"wss://demo-ws-api.binance.com/ws-api/v3\"\n     WS_FUTURES_URL = \"wss://ws-fapi.binance.{}/ws-fapi/v1\"\n     WS_FUTURES_TESTNET_URL = \"wss://testnet.binancefuture.com/ws-fapi/v1\"\n+    WS_FUTURES_DEMO_URL = \"wss://testnet.binancefuture.com/ws-fapi/v1\"\n     PUBLIC_API_VERSION = \"v3\"\n     PRIVATE_API_VERSION = \"v3\"\n     MARGIN_API_VERSION = \"v1\"\n@@ -157,6 +162,7 @@ class BaseClient:\n         tld: str = \"com\",\n         base_endpoint: str = BASE_ENDPOINT_DEFAULT,\n         testnet: bool = False,\n+        demo: bool = False,\n         private_key: Optional[Union[str, Path]] = None,\n         private_key_pass: Optional[str] = None,\n         loop: Optional[asyncio.AbstractEventLoop] = None,\n@@ -201,15 +207,27 @@ class BaseClient:\n         self._requests_params = requests_params\n         self.response = None\n         self.testnet = testnet\n+        self.demo = demo\n         self.timestamp_offset = 0\n-        ws_api_url = self.WS_API_TESTNET_URL if testnet else self.WS_API_URL.format(tld)\n+        ws_api_url = self.WS_API_URL.format(tld)\n+        if testnet:\n+            ws_api_url = self.WS_API_TESTNET_URL\n+        elif demo:\n+            ws_api_url = self.WS_API_DEMO_URL\n         if self.TIME_UNIT:\n             ws_api_url += f\"?timeUnit={self.TIME_UNIT}\"\n-        self.ws_api = WebsocketAPI(url=ws_api_url, tld=tld)\n-        ws_future_url = (\n-            self.WS_FUTURES_TESTNET_URL if testnet else self.WS_FUTURES_URL.format(tld)\n-        )\n-        self.ws_future = WebsocketAPI(url=ws_future_url, tld=tld)\n+        # Extract proxy from requests_params for WebSocket connections\n+        https_proxy = None\n+        if requests_params and 'proxies' in requests_params:\n+            https_proxy = requests_params['proxies'].get('https') or requests_params['proxies'].get('http')\n+        \n+        self.ws_api = WebsocketAPI(url=ws_api_url, tld=tld, https_proxy=https_proxy)\n+        ws_future_url = self.WS_FUTURES_URL.format(tld)\n+        if testnet:\n+            ws_future_url = self.WS_FUTURES_TESTNET_URL\n+        elif demo:\n+            ws_future_url = self.WS_FUTURES_DEMO_URL\n+        self.ws_future = WebsocketAPI(url=ws_future_url, tld=tld, https_proxy=https_proxy)\n         self.loop = loop or get_loop()\n \n     def _get_headers(self) -> Dict:\n@@ -250,6 +268,8 @@ class BaseClient:\n         url = self.API_URL\n         if self.testnet:\n             url = self.API_TESTNET_URL\n+        elif self.demo:\n+            url = self.API_DEMO_URL\n         v = self.PRIVATE_API_VERSION if signed else version\n         return url + \"/\" + v + \"/\" + path\n \n@@ -273,6 +293,8 @@ class BaseClient:\n         url = self.FUTURES_URL\n         if self.testnet:\n             url = self.FUTURES_TESTNET_URL\n+        elif self.demo:\n+            url = self.FUTURES_DEMO_URL\n         options = {\n             1: self.FUTURES_API_VERSION,\n             2: self.FUTURES_API_VERSION2,\n@@ -290,6 +312,8 @@ class BaseClient:\n         url = self.FUTURES_COIN_URL\n         if self.testnet:\n             url = self.FUTURES_COIN_TESTNET_URL\n+        elif self.demo:\n+            url = self.FUTURES_COIN_DEMO_URL\n         options = {\n             1: self.FUTURES_API_VERSION,\n             2: self.FUTURES_API_VERSION2,\n"
        },
        {
            "commit": "3ce7b9cb7b89ed8330621bdb0acb809eb830d687",
            "file_path": "binance/client.py",
            "diff": "diff --git a/binance/client.py b/binance/client.py\nindex 43bd46b..95d7619 100755\n--- a/binance/client.py\n+++ b/binance/client.py\n@@ -29,6 +29,7 @@ class Client(BaseClient):\n         tld: str = \"com\",\n         base_endpoint: str = BaseClient.BASE_ENDPOINT_DEFAULT,\n         testnet: bool = False,\n+        demo: bool = False,\n         private_key: Optional[Union[str, Path]] = None,\n         private_key_pass: Optional[str] = None,\n         ping: Optional[bool] = True,\n@@ -41,6 +42,7 @@ class Client(BaseClient):\n             tld,\n             base_endpoint,\n             testnet,\n+            demo,\n             private_key,\n             private_key_pass,\n             time_unit=time_unit,\n@@ -7364,7 +7366,7 @@ class Client(BaseClient):\n         \"\"\"\n         return self._request_futures_api(\"get\", \"premiumIndexKlines\", data=params)\n \n-    def futures_continous_klines(self, **params):\n+    def futures_continuous_klines(self, **params):\n         \"\"\"Kline/candlestick bars for a specific contract type. Klines are uniquely identified by their open time.\n \n         https://developers.binance.com/docs/derivatives/usds-margined-futures/market-data/rest-api/Continuous-Contract-Kline-Candlestick-Data\n@@ -7779,6 +7781,77 @@ class Client(BaseClient):\n             params[\"newClientOrderId\"] = self.CONTRACT_ORDER_PREFIX + self.uuid22()\n         return self._request_futures_api(\"post\", \"order\", True, data=params)\n \n+    def futures_limit_order(self, **params):\n+        \"\"\"Send in a new futures limit order.\n+\n+        https://developers.binance.com/docs/derivatives/usds-margined-futures/trade/rest-api\n+\n+        \"\"\"\n+        if \"newClientOrderId\" not in params:\n+            params[\"newClientOrderId\"] = self.CONTRACT_ORDER_PREFIX + self.uuid22()\n+        params[\"type\"] = \"LIMIT\"\n+        return self._request_futures_api(\"post\", \"order\", True, data=params)\n+\n+    def futures_market_order(self, **params):\n+        \"\"\"Send in a new futures market order.\n+\n+        https://developers.binance.com/docs/derivatives/usds-margined-futures/trade/rest-api\n+\n+        \"\"\"\n+        if \"newClientOrderId\" not in params:\n+            params[\"newClientOrderId\"] = self.CONTRACT_ORDER_PREFIX + self.uuid22()\n+        params[\"type\"] = \"MARKET\"\n+        return self._request_futures_api(\"post\", \"order\", True, data=params)\n+\n+\n+    def futures_limit_buy_order(self, **params):\n+        \"\"\"Send in a new futures limit buy order.\n+\n+        https://developers.binance.com/docs/derivatives/usds-margined-futures/trade/rest-api\n+\n+        \"\"\"\n+        if \"newClientOrderId\" not in params:\n+            params[\"newClientOrderId\"] = self.CONTRACT_ORDER_PREFIX + self.uuid22()\n+        params[\"side\"] = \"BUY\"\n+        params[\"type\"] = \"LIMIT\"\n+        return self._request_futures_api(\"post\", \"order\", True, data=params)\n+\n+    def futures_limit_sell_order(self, **params):\n+        \"\"\"Send in a new futures limit sell order.\n+\n+        https://developers.binance.com/docs/derivatives/usds-margined-futures/trade/rest-api\n+\n+        \"\"\"\n+        if \"newClientOrderId\" not in params:\n+            params[\"newClientOrderId\"] = self.CONTRACT_ORDER_PREFIX + self.uuid22()\n+        params[\"side\"] = \"SELL\"\n+        params[\"type\"] = \"LIMIT\"\n+        return self._request_futures_api(\"post\", \"order\", True, data=params)\n+\n+    def futures_market_buy_order(self, **params):\n+        \"\"\"Send in a new futures market buy order.\n+\n+        https://developers.binance.com/docs/derivatives/usds-margined-futures/trade/rest-api\n+\n+        \"\"\"\n+        if \"newClientOrderId\" not in params:\n+            params[\"newClientOrderId\"] = self.CONTRACT_ORDER_PREFIX + self.uuid22()\n+        params[\"side\"] = \"BUY\"\n+        params[\"type\"] = \"MARKET\"\n+        return self._request_futures_api(\"post\", \"order\", True, data=params)\n+\n+    def futures_market_sell_order(self, **params):\n+        \"\"\"Send in a new futures market sell order.\n+\n+        https://developers.binance.com/docs/derivatives/usds-margined-futures/trade/rest-api\n+\n+        \"\"\"\n+        if \"newClientOrderId\" not in params:\n+            params[\"newClientOrderId\"] = self.CONTRACT_ORDER_PREFIX + self.uuid22()\n+        params[\"side\"] = \"SELL\"\n+        params[\"type\"] = \"MARKET\"\n+        return self._request_futures_api(\"post\", \"order\", True, data=params)\n+\n     def futures_modify_order(self, **params):\n         \"\"\"Modify an existing order. Currently only LIMIT order modification is supported.\n \n@@ -13999,7 +14072,7 @@ class Client(BaseClient):\n                 \"data\": [\n                     {\n                         \"day\": \"2023-06-30\",\n-                        \"url\": \"https://bin-prod-user-rebate-bucket.s3.ap-northeast-1.amazonaws.com/future-data-symbol-update/2023-06-30/BTCUSDT_T_DEPTH_2023-06-30.tar.gz?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Date=20230925T025710Z&X-Amz-SignedHeaders=host&X-Amz-Expires=86399&X-Amz-Credential=AKIAVL364M5ZNFZ74IPP%2F20230925%2Fap-northeast-1%2Fs3%2Faws4_request&X-Amz-Signature=5fffcb390d10f34d71615726f81f99e42d80a11532edeac77b858c51a88cbf59\"\n+                        \"url\": \"\"\n                     }\n                 ]\n             }\n"
        },
        {
            "commit": "3ce7b9cb7b89ed8330621bdb0acb809eb830d687",
            "file_path": "binance/ws/streams.py",
            "diff": "diff --git a/binance/ws/streams.py b/binance/ws/streams.py\nindex 8c73d8c..33d5f3b 100755\n--- a/binance/ws/streams.py\n+++ b/binance/ws/streams.py\n@@ -26,10 +26,13 @@ class BinanceSocketType(str, Enum):\n class BinanceSocketManager:\n     STREAM_URL = \"wss://stream.binance.{}:9443/\"\n     STREAM_TESTNET_URL = \"wss://stream.testnet.binance.vision/\"\n+    STREAM_DEMO_URL = \"wss://demo-stream.binance.com/\"\n     FSTREAM_URL = \"wss://fstream.binance.{}/\"\n     FSTREAM_TESTNET_URL = \"wss://stream.binancefuture.com/\"\n+    FSTREAM_DEMO_URL = \"wss://fstream.binancefuture.com/\"\n     DSTREAM_URL = \"wss://dstream.binance.{}/\"\n     DSTREAM_TESTNET_URL = \"wss://dstream.binancefuture.com/\"\n+    DSTREAM_DEMO_URL = \"wss://dstream.binancefuture.com/\"\n     OPTIONS_URL = \"wss://nbstream.binance.{}/eoptions/\"\n \n     WEBSOCKET_DEPTH_5 = \"5\"\n@@ -60,6 +63,7 @@ class BinanceSocketManager:\n         self._client = client\n         self._user_timeout = user_timeout\n         self.testnet = self._client.testnet\n+        self.demo = self._client.demo\n         self._max_queue_size = max_queue_size\n         self.ws_kwargs = {}\n \n@@ -69,6 +73,8 @@ class BinanceSocketManager:\n         stream_url = self.STREAM_URL\n         if self.testnet:\n             stream_url = self.STREAM_TESTNET_URL\n+        elif self.demo:\n+            stream_url = self.STREAM_DEMO_URL\n         return stream_url\n \n     def _get_socket(\n@@ -128,10 +134,14 @@ class BinanceSocketManager:\n             stream_url = self.FSTREAM_URL\n             if self.testnet:\n                 stream_url = self.FSTREAM_TESTNET_URL\n+            elif self.demo:\n+                stream_url = self.FSTREAM_DEMO_URL\n         else:\n             stream_url = self.DSTREAM_URL\n             if self.testnet:\n                 stream_url = self.DSTREAM_TESTNET_URL\n+            elif self.demo:\n+                stream_url = self.DSTREAM_DEMO_URL\n         return self._get_socket(path, stream_url, prefix, socket_type=socket_type)\n \n     def _get_options_socket(self, path: str, prefix: str = \"ws/\"):\n@@ -907,6 +917,8 @@ class BinanceSocketManager:\n         stream_url = self.STREAM_URL\n         if self.testnet:\n             stream_url = self.STREAM_TESTNET_URL\n+        elif self.demo:\n+            stream_url = self.STREAM_DEMO_URL\n         return self._get_account_socket(\"user\", stream_url=stream_url)\n \n     def futures_user_socket(self):\n@@ -922,6 +934,8 @@ class BinanceSocketManager:\n         stream_url = self.FSTREAM_URL\n         if self.testnet:\n             stream_url = self.FSTREAM_TESTNET_URL\n+        elif self.demo:\n+            stream_url = self.FSTREAM_DEMO_URL\n         return self._get_account_socket(\"futures\", stream_url=stream_url)\n \n     def coin_futures_user_socket(self):\n@@ -948,8 +962,11 @@ class BinanceSocketManager:\n         stream_url = self.STREAM_URL\n         if self.testnet:\n             stream_url = self.STREAM_TESTNET_URL\n+        elif self.demo:\n+            stream_url = self.STREAM_DEMO_URL\n         return self._get_account_socket(\"margin\", stream_url=stream_url)\n \n+\n     def futures_socket(self):\n         \"\"\"Start a websocket for futures data\n \n@@ -962,6 +979,8 @@ class BinanceSocketManager:\n         stream_url = self.FSTREAM_URL\n         if self.testnet:\n             stream_url = self.FSTREAM_TESTNET_URL\n+        elif self.demo:\n+            stream_url = self.FSTREAM_DEMO_URL\n         return self._get_account_socket(\"futures\", stream_url=stream_url)\n \n     def coin_futures_socket(self):\n@@ -976,6 +995,8 @@ class BinanceSocketManager:\n         stream_url = self.DSTREAM_URL\n         if self.testnet:\n             stream_url = self.DSTREAM_TESTNET_URL\n+        elif self.demo:\n+            stream_url = self.DSTREAM_DEMO_URL\n         return self._get_account_socket(\"coin_futures\", stream_url=stream_url)\n \n     def portfolio_margin_socket(self):\n@@ -990,6 +1011,8 @@ class BinanceSocketManager:\n         stream_url = self.FSTREAM_URL\n         if self.testnet:\n             stream_url = self.FSTREAM_TESTNET_URL\n+        elif self.demo:\n+            stream_url = self.FSTREAM_DEMO_URL\n         stream_url += \"pm/\"\n         return self._get_account_socket(\"portfolio_margin\", stream_url=stream_url)\n \n@@ -1008,6 +1031,8 @@ class BinanceSocketManager:\n         stream_url = self.STREAM_URL\n         if self.testnet:\n             stream_url = self.STREAM_TESTNET_URL\n+        elif self.demo:\n+            stream_url = self.STREAM_DEMO_URL\n         return self._get_account_socket(symbol, stream_url=stream_url)\n \n     def options_ticker_socket(self, symbol: str):\n"
        },
        {
            "commit": "3ce7b9cb7b89ed8330621bdb0acb809eb830d687",
            "file_path": "binance/ws/websocket_api.py",
            "diff": "diff --git a/binance/ws/websocket_api.py b/binance/ws/websocket_api.py\nindex 8542b62..aa9bf96 100644\n--- a/binance/ws/websocket_api.py\n+++ b/binance/ws/websocket_api.py\n@@ -1,4 +1,4 @@\n-from typing import Dict\n+from typing import Dict, Optional\n import asyncio\n \n from websockets import WebSocketClientProtocol  # type: ignore\n@@ -9,14 +9,19 @@ from binance.exceptions import BinanceAPIException, BinanceWebsocketUnableToConn\n \n \n class WebsocketAPI(ReconnectingWebsocket):\n-    def __init__(self, url: str, tld: str = \"com\", testnet: bool = False):\n+    def __init__(self, url: str, tld: str = \"com\", testnet: bool = False, https_proxy: Optional[str] = None):\n         self._tld = tld\n         self._testnet = testnet\n         self._responses: Dict[str, asyncio.Future] = {}\n-        self._connection_lock = (\n-            asyncio.Lock()\n-        )  # used to ensure only one connection is established at a time\n-        super().__init__(url=url, prefix=\"\", path=\"\", is_binary=False)\n+        self._connection_lock: Optional[asyncio.Lock] = None\n+        super().__init__(url=url, prefix=\"\", path=\"\", is_binary=False, https_proxy=https_proxy)\n+\n+    @property\n+    def connection_lock(self) -> asyncio.Lock:\n+        if self._connection_lock is None:\n+            loop = asyncio.get_event_loop()\n+            self._connection_lock = asyncio.Lock()\n+        return self._connection_lock\n \n     def _handle_message(self, msg):\n         \"\"\"Override message handling to support request-response\"\"\"\n@@ -51,7 +56,7 @@ class WebsocketAPI(ReconnectingWebsocket):\n         3. Wait for connection to be ready\n         4. Handle reconnection if needed\n         \"\"\"\n-        async with self._connection_lock:\n+        async with self.connection_lock:\n             try:\n                 if (\n                     self.ws is None\n"
        },
        {
            "commit": "3ce7b9cb7b89ed8330621bdb0acb809eb830d687",
            "file_path": "tests/conftest.py",
            "diff": "diff --git a/tests/conftest.py b/tests/conftest.py\nindex afb29b0..d0537e1 100644\n--- a/tests/conftest.py\n+++ b/tests/conftest.py\n@@ -11,7 +11,7 @@ from binance.ws.streams import ThreadedWebsocketManager\n proxies = {}\n proxy = os.getenv(\"PROXY\")\n \n-proxy = \"http://51.83.140.52:16301\"\n+proxy = \"http://188.245.226.105:8911\"\n if proxy:\n     proxies = {\"http\": proxy, \"https\": proxy}  # tmp: improve this in the future\n else:\n@@ -24,9 +24,10 @@ futures_api_secret = os.getenv(\"TEST_FUTURES_API_SECRET\")\n testnet = os.getenv(\"TEST_TESTNET\", \"true\").lower() == \"true\"\n api_key = \"u4L8MG2DbshTfTzkx2Xm7NfsHHigvafxeC29HrExEmah1P8JhxXkoOu6KntLICUc\"\n api_secret = \"hBZEqhZUUS6YZkk7AIckjJ3iLjrgEFr5CRtFPp5gjzkrHKKC9DAv4OH25PlT6yq5\"\n-testnet = True\n-futures_api_key = \"227719da8d8499e8d3461587d19f259c0b39c2b462a77c9b748a6119abd74401\"\n-futures_api_secret = \"b14b935f9cfacc5dec829008733c40da0588051f29a44625c34967b45c11d73c\"\n+testnet = True # only for spot now\n+demo = True # spot and swap\n+futures_api_key = \"HjhMFvuF1veWQVdUbLIy7TiCYe9fj4W6sEukmddD8TM9kPVRHMK6nS2SdV5mwE5u\"\n+futures_api_secret = \"Suu9pWcO9zbvVuc6cSQsVuiiw2DmmA8DgHrUfePF9s2RtaHa0zxK3eAF4MfIk7Pd\"\n \n \n # Configure logging for all tests\n@@ -58,15 +59,17 @@ def liveClient():\n @pytest.fixture(scope=\"function\")\n def futuresClient():\n     return Client(\n-        futures_api_key, futures_api_secret, {\"proxies\": proxies}, testnet=testnet\n+        futures_api_key, futures_api_secret, {\"proxies\": proxies}, demo=demo\n     )\n \n \n @pytest_asyncio.fixture(scope=\"function\")\n async def clientAsync():\n     client = AsyncClient(api_key, api_secret, https_proxy=proxy, testnet=testnet)\n-    yield client\n-    await client.close_connection()\n+    try:\n+        yield client\n+    finally:\n+        await client.close_connection()\n \n \n @pytest_asyncio.fixture(scope=\"function\")\n@@ -74,15 +77,19 @@ async def futuresClientAsync():\n     client = AsyncClient(\n         futures_api_key, futures_api_secret, https_proxy=proxy, testnet=testnet\n     )\n-    yield client\n-    await client.close_connection()\n+    try:\n+        yield client\n+    finally:\n+        await client.close_connection()\n \n \n @pytest_asyncio.fixture(scope=\"function\")\n async def liveClientAsync():\n     client = AsyncClient(api_key, api_secret, https_proxy=proxy, testnet=False)\n-    yield client\n-    await client.close_connection()\n+    try:\n+        yield client\n+    finally:\n+        await client.close_connection()\n \n @pytest.fixture(scope=\"function\")\n def manager():\n@@ -93,14 +100,23 @@ def manager():\n @pytest.fixture(autouse=True, scope=\"function\")\n def event_loop():\n     \"\"\"Create new event loop for each test\"\"\"\n-    loop = asyncio.new_event_loop()\n-    yield loop\n-    # Clean up pending tasks\n-    pending = asyncio.all_tasks(loop)\n-    for task in pending:\n-        task.cancel()\n-    loop.run_until_complete(asyncio.gather(*pending, return_exceptions=True))\n-    loop.close()\n+    try:\n+        loop = asyncio.new_event_loop()\n+        asyncio.set_event_loop(loop)\n+        yield loop\n+    finally:\n+        # Clean up pending tasks\n+        try:\n+            pending = asyncio.all_tasks(loop)\n+            for task in pending:\n+                task.cancel()\n+            if pending:\n+                loop.run_until_complete(asyncio.gather(*pending, return_exceptions=True))\n+        except Exception:\n+            pass  # Ignore cleanup errors\n+        finally:\n+            loop.close()\n+            asyncio.set_event_loop(None)\n \n \n def pytest_addoption(parser):\n"
        },
        {
            "commit": "3ce7b9cb7b89ed8330621bdb0acb809eb830d687",
            "file_path": "tests/test_async_client.py",
            "diff": "diff --git a/tests/test_async_client.py b/tests/test_async_client.py\nindex fab9806..ee3563b 100644\n--- a/tests/test_async_client.py\n+++ b/tests/test_async_client.py\n@@ -1,4 +1,5 @@\n import pytest\n+import sys\n \n from binance.async_client import AsyncClient\n from .conftest import proxy, api_key, api_secret, testnet\n@@ -114,48 +115,63 @@ async def test_stream_get_listen_key_and_close(clientAsync):\n #########################\n \n \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n async def test_ws_get_order_book(clientAsync):\n     await clientAsync.ws_get_order_book(symbol=\"BTCUSDT\")\n     \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n async def test_ws_get_recent_trades(clientAsync):\n     await clientAsync.ws_get_recent_trades(symbol=\"BTCUSDT\")\n     \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n async def test_ws_get_historical_trades(clientAsync):\n     await clientAsync.ws_get_historical_trades(symbol=\"BTCUSDT\")\n     \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n async def test_ws_get_aggregate_trades(clientAsync):\n     await clientAsync.ws_get_aggregate_trades(symbol=\"BTCUSDT\")\n     \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n async def test_ws_get_klines(clientAsync):\n     await clientAsync.ws_get_klines(symbol=\"BTCUSDT\", interval=\"1m\")\n     \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n async def test_ws_get_uiKlines(clientAsync):\n     await clientAsync.ws_get_uiKlines(symbol=\"BTCUSDT\", interval=\"1m\")\n     \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n async def test_ws_get_avg_price(clientAsync):\n     await clientAsync.ws_get_avg_price(symbol=\"BTCUSDT\")\n     \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n async def test_ws_get_ticker(clientAsync):\n     ticker = await clientAsync.ws_get_ticker(symbol=\"BTCUSDT\")\n     \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n async def test_ws_get_trading_day_ticker(clientAsync):\n     await clientAsync.ws_get_trading_day_ticker(symbol=\"BTCUSDT\")\n     \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n async def test_ws_get_symbol_ticker_window(clientAsync):\n     await clientAsync.ws_get_symbol_ticker_window(symbol=\"BTCUSDT\")\n     \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n async def test_ws_get_symbol_ticker(clientAsync):\n     await clientAsync.ws_get_symbol_ticker(symbol=\"BTCUSDT\")\n     \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n async def test_ws_get_orderbook_ticker(clientAsync):\n     await clientAsync.ws_get_orderbook_ticker(symbol=\"BTCUSDT\")\n     \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n async def test_ws_ping(clientAsync):\n     await clientAsync.ws_ping()\n     \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n async def test_ws_get_time(clientAsync):\n     await clientAsync.ws_get_time()\n     \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n async def test_ws_get_exchange_info(clientAsync):\n     await clientAsync.ws_get_exchange_info(symbol=\"BTCUSDT\")\n     \n"
        },
        {
            "commit": "3ce7b9cb7b89ed8330621bdb0acb809eb830d687",
            "file_path": "tests/test_async_client_futures.py",
            "diff": "diff --git a/tests/test_async_client_futures.py b/tests/test_async_client_futures.py\nindex d22d35c..618a184 100644\n--- a/tests/test_async_client_futures.py\n+++ b/tests/test_async_client_futures.py\n@@ -90,6 +90,7 @@ async def test_futures_index_index_price_constituents(futuresClientAsync):\n async def test_futures_liquidation_orders(futuresClientAsync):\n     await futuresClientAsync.futures_liquidation_orders()\n \n+@pytest.mark.skip(reason=\"Temporary skip due to issues with api\")\n async def test_futures_api_trading_status(futuresClientAsync):\n     await futuresClientAsync.futures_api_trading_status()\n \n"
        },
        {
            "commit": "3ce7b9cb7b89ed8330621bdb0acb809eb830d687",
            "file_path": "tests/test_async_client_options.py",
            "diff": "diff --git a/tests/test_async_client_options.py b/tests/test_async_client_options.py\nindex 5121125..3a43177 100644\n--- a/tests/test_async_client_options.py\n+++ b/tests/test_async_client_options.py\n@@ -1,6 +1,7 @@\n import pytest\n+import sys\n \n-pytestmark = [pytest.mark.options, pytest.mark.asyncio]\n+pytestmark = [pytest.mark.options, pytest.mark.asyncio, pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")]\n \n @pytest.fixture\n def options_symbol(liveClient):\n"
        },
        {
            "commit": "3ce7b9cb7b89ed8330621bdb0acb809eb830d687",
            "file_path": "tests/test_async_client_ws_api.py",
            "diff": "diff --git a/tests/test_async_client_ws_api.py b/tests/test_async_client_ws_api.py\nindex 8475c17..d853894 100644\n--- a/tests/test_async_client_ws_api.py\n+++ b/tests/test_async_client_ws_api.py\n@@ -1,61 +1,48 @@\n import pytest\n+import sys\n+pytestmark = [pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\"), pytest.mark.asyncio()]\n \n-@pytest.mark.asyncio()\n async def test_ws_get_order_book(clientAsync):\n     await clientAsync.ws_get_order_book(symbol=\"BTCUSDT\")\n \n-@pytest.mark.asyncio()\n async def test_ws_get_recent_trades(clientAsync):\n     await clientAsync.ws_get_recent_trades(symbol=\"BTCUSDT\")\n \n-@pytest.mark.asyncio()\n async def test_ws_get_historical_trades(clientAsync):\n     await clientAsync.ws_get_historical_trades(symbol=\"BTCUSDT\")\n \n-@pytest.mark.asyncio()\n async def test_ws_get_aggregate_trades(clientAsync):\n     await clientAsync.ws_get_aggregate_trades(symbol=\"BTCUSDT\")\n \n-@pytest.mark.asyncio()\n async def test_ws_get_klines(clientAsync):\n     await clientAsync.ws_get_klines(symbol=\"BTCUSDT\", interval=\"1m\")\n \n-@pytest.mark.asyncio()\n async def test_ws_get_uiKlines(clientAsync):\n     await clientAsync.ws_get_uiKlines(symbol=\"BTCUSDT\", interval=\"1m\")\n \n-@pytest.mark.asyncio()\n async def test_ws_get_avg_price(clientAsync):\n     await clientAsync.ws_get_avg_price(symbol=\"BTCUSDT\")\n \n-@pytest.mark.asyncio()\n async def test_ws_get_ticker(clientAsync):\n     await clientAsync.ws_get_ticker(symbol=\"BTCUSDT\")\n \n-@pytest.mark.asyncio()\n async def test_ws_get_trading_day_ticker(clientAsync):\n     await clientAsync.ws_get_trading_day_ticker(symbol=\"BTCUSDT\")\n \n-@pytest.mark.asyncio()\n async def test_ws_get_symbol_ticker_window(clientAsync):\n     await clientAsync.ws_get_symbol_ticker_window(symbol=\"BTCUSDT\")\n \n-@pytest.mark.asyncio()\n async def test_ws_get_symbol_ticker(clientAsync):\n     await clientAsync.ws_get_symbol_ticker(symbol=\"BTCUSDT\")\n \n-@pytest.mark.asyncio()\n async def test_ws_get_orderbook_ticker(clientAsync):\n     await clientAsync.ws_get_orderbook_ticker(symbol=\"BTCUSDT\")\n \n-@pytest.mark.asyncio()\n async def test_ws_ping(clientAsync):\n     await clientAsync.ws_ping()\n \n-@pytest.mark.asyncio()\n async def test_ws_get_time(clientAsync):\n     await clientAsync.ws_get_time()\n \n-@pytest.mark.asyncio()\n async def test_ws_get_exchange_info(clientAsync):\n     await clientAsync.ws_get_exchange_info(symbol=\"BTCUSDT\")\n"
        },
        {
            "commit": "3ce7b9cb7b89ed8330621bdb0acb809eb830d687",
            "file_path": "tests/test_async_client_ws_futures_requests.py",
            "diff": "diff --git a/tests/test_async_client_ws_futures_requests.py b/tests/test_async_client_ws_futures_requests.py\nindex cde6fcf..787a6d1 100644\n--- a/tests/test_async_client_ws_futures_requests.py\n+++ b/tests/test_async_client_ws_futures_requests.py\n@@ -7,17 +7,19 @@ from .test_get_order_book import assert_ob\n from .test_order import assert_contract_order\n \n try:\n-    from unittest.mock import AsyncMock, patch  # Python 3.8+\n+    from unittest.mock import patch  # Python 3.8+\n except ImportError:\n-    from asynctest import CoroutineMock as AsyncMock, patch  # Python 3.7\n+    from asynctest import patch  # Python 3.7\n \n \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n @pytest.mark.asyncio()\n async def test_ws_futures_get_order_book(futuresClientAsync):\n     orderbook = await futuresClientAsync.ws_futures_get_order_book(symbol=\"BTCUSDT\")\n     assert_ob(orderbook)\n \n \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n @pytest.mark.asyncio\n async def test_concurrent_ws_futures_get_order_book(futuresClientAsync):\n     symbols = [\"BTCUSDT\", \"ETHUSDT\", \"BNBUSDT\", \"ADAUSDT\"]\n@@ -42,16 +44,19 @@ async def test_bad_request(futuresClientAsync):\n         await futuresClientAsync.ws_futures_get_order_book()\n \n \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n @pytest.mark.asyncio()\n async def test_ws_futures_get_all_tickers(futuresClientAsync):\n     await futuresClientAsync.ws_futures_get_all_tickers()\n \n \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n @pytest.mark.asyncio()\n async def test_ws_futures_get_order_book_ticker(futuresClientAsync):\n     await futuresClientAsync.ws_futures_get_order_book_ticker()\n \n \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n @pytest.mark.asyncio()\n async def test_ws_futures_create_get_edit_cancel_order_with_orjson(futuresClientAsync):\n     if 'orjson' not in sys.modules:\n@@ -87,6 +92,7 @@ async def test_ws_futures_create_get_edit_cancel_order_with_orjson(futuresClient\n         orderid=order[\"orderId\"], symbol=order[\"symbol\"]\n     )\n \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n @pytest.mark.asyncio()\n async def test_ws_futures_create_get_edit_cancel_order_without_orjson(futuresClientAsync):\n     with patch.dict('sys.modules', {'orjson': None}):\n@@ -121,39 +127,49 @@ async def test_ws_futures_create_get_edit_cancel_order_without_orjson(futuresCli\n         )\n \n \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n @pytest.mark.asyncio()\n async def test_ws_futures_v2_account_position(futuresClientAsync):\n     await futuresClientAsync.ws_futures_v2_account_position()\n \n \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n @pytest.mark.asyncio()\n async def test_ws_futures_account_position(futuresClientAsync):\n     await futuresClientAsync.ws_futures_account_position()\n \n \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n @pytest.mark.asyncio()\n async def test_ws_futures_v2_account_balance(futuresClientAsync):\n     await futuresClientAsync.ws_futures_v2_account_balance()\n \n \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n @pytest.mark.asyncio()\n async def test_ws_futures_account_balance(futuresClientAsync):\n     await futuresClientAsync.ws_futures_account_balance()\n \n \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n @pytest.mark.asyncio()\n async def test_ws_futures_v2_account_status(futuresClientAsync):\n     await futuresClientAsync.ws_futures_v2_account_status()\n \n \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n @pytest.mark.asyncio()\n async def test_ws_futures_account_status(futuresClientAsync):\n     await futuresClientAsync.ws_futures_account_status()\n \n \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n @pytest.mark.asyncio\n async def test_ws_futures_fail_to_connect(futuresClientAsync):\n-    # Simulate WebSocket connection being closed during the request\n-    with patch(\"websockets.connect\", new_callable=AsyncMock):\n+    # Close any existing connection first\n+    await futuresClientAsync.close_connection()\n+    \n+    # Mock the WebSocket API's connect method to raise an exception\n+    with patch.object(futuresClientAsync.ws_future, 'connect', side_effect=ConnectionError(\"Simulated connection failure\")):\n         with pytest.raises(BinanceWebsocketUnableToConnect):\n             await futuresClientAsync.ws_futures_get_order_book(symbol=\"BTCUSDT\")\n"
        },
        {
            "commit": "3ce7b9cb7b89ed8330621bdb0acb809eb830d687",
            "file_path": "tests/test_client.py",
            "diff": "diff --git a/tests/test_client.py b/tests/test_client.py\nindex 10fea4c..c4b973e 100644\n--- a/tests/test_client.py\n+++ b/tests/test_client.py\n@@ -1,3 +1,4 @@\n+import sys\n import pytest\n from binance.client import Client\n from binance.exceptions import BinanceAPIException, BinanceRequestException\n@@ -131,62 +132,77 @@ def test_get_dust_assets(client):\n #########################\n \n \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n def test_ws_get_order_book(client):\n     client.ws_get_order_book(symbol=\"BTCUSDT\")\n \n \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n def test_ws_get_recent_trades(client):\n     client.ws_get_recent_trades(symbol=\"BTCUSDT\")\n \n \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n def test_ws_get_historical_trades(client):\n     client.ws_get_historical_trades(symbol=\"BTCUSDT\")\n \n \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n def test_ws_get_aggregate_trades(client):\n     client.ws_get_aggregate_trades(symbol=\"BTCUSDT\")\n \n \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n def test_ws_get_klines(client):\n     client.ws_get_klines(symbol=\"BTCUSDT\", interval=\"1m\")\n \n \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n def test_ws_get_uiKlines(client):\n     client.ws_get_uiKlines(symbol=\"BTCUSDT\", interval=\"1m\")\n \n \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n def test_ws_get_avg_price(client):\n     client.ws_get_avg_price(symbol=\"BTCUSDT\")\n \n \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n def test_ws_get_ticker(client):\n     ticker = client.ws_get_ticker(symbol=\"BTCUSDT\")\n \n \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n def test_ws_get_trading_day_ticker(client):\n     client.ws_get_trading_day_ticker(symbol=\"BTCUSDT\")\n \n \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n def test_ws_get_symbol_ticker_window(client):\n     client.ws_get_symbol_ticker_window(symbol=\"BTCUSDT\")\n \n \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n def test_ws_get_symbol_ticker(client):\n     client.ws_get_symbol_ticker(symbol=\"BTCUSDT\")\n \n \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n def test_ws_get_orderbook_ticker(client):\n     client.ws_get_orderbook_ticker(symbol=\"BTCUSDT\")\n \n \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n def test_ws_ping(client):\n     client.ws_ping()\n \n \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n def test_ws_get_time(client):\n     client.ws_get_time()\n \n \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n def test_ws_get_exchange_info(client):\n     client.ws_get_exchange_info(symbol=\"BTCUSDT\")\n \n"
        },
        {
            "commit": "3ce7b9cb7b89ed8330621bdb0acb809eb830d687",
            "file_path": "tests/test_client_futures.py",
            "diff": "diff --git a/tests/test_client_futures.py b/tests/test_client_futures.py\nindex 21a8864..8e074b4 100644\n--- a/tests/test_client_futures.py\n+++ b/tests/test_client_futures.py\n@@ -118,6 +118,7 @@ def test_futures_liquidation_orders(futuresClient):\n     futuresClient.futures_liquidation_orders()\n \n \n+@pytest.mark.skip(reason=\"Fails in demo environment\")\n def test_futures_api_trading_status(futuresClient):\n     futuresClient.futures_api_trading_status()\n \n@@ -624,7 +625,7 @@ def test_futures_coin_account_order_history_download_mock(futuresClient):\n         \"downloadId\": \"546975389218332672\",\n     }\n     url_pattern = re.compile(\n-        r\"https://(?:testnet\\.)?binancefuture\\.com/dapi/v1/order/asyn\"\n+        r\"https://[^/]+/dapi/v1/order/asyn\"\n         r\"\\?recvWindow=\\d+\"\n         r\"&timestamp=\\d+\"\n         r\"&signature=[a-f0-9]{64}\"\n@@ -642,7 +643,7 @@ def test_futures_coin_account_order_history_download_mock(futuresClient):\n def test_futures_coin_account_order_download_id_mock(futuresClient):\n     expected_response = {\"link\": \"hello\"}\n     url_pattern = re.compile(\n-        r\"https://(?:testnet\\.)?binancefuture\\.com/dapi/v1/order/asyn/id\"\n+        r\"https://[^/]+/dapi/v1/order/asyn/id\"\n         r\"\\?downloadId=123\"\n         r\"&recvWindow=\\d+\"\n         r\"&timestamp=\\d+\"\n@@ -666,7 +667,7 @@ def test_futures_coin_account_trade_history_download_id_mock(futuresClient):\n         \"downloadId\": \"546975389218332672\",\n     }\n     url_pattern = re.compile(\n-        r\"https://(?:testnet\\.)?binancefuture\\.com/dapi/v1/trade/asyn\"\n+        r\"https://[^/]+/dapi/v1/trade/asyn\"\n         r\"\\?recvWindow=\\d+\"\n         r\"&timestamp=\\d+\"\n         r\"&signature=[a-f0-9]{64}\"\n@@ -684,7 +685,7 @@ def test_futures_coin_account_trade_history_download_id_mock(futuresClient):\n def test_futures_coin_account_trade_history_download_link_mock(futuresClient):\n     expected_response = {\"link\": \"hello\"}\n     url_pattern = re.compile(\n-        r\"https://(?:testnet\\.)?binancefuture\\.com/dapi/v1/trade/asyn/id\"\n+        r\"https://[^/]+/dapi/v1/trade/asyn/id\"\n         r\"\\?downloadId=123\"\n         r\"&recvWindow=\\d+\"\n         r\"&timestamp=\\d+\"\n"
        },
        {
            "commit": "3ce7b9cb7b89ed8330621bdb0acb809eb830d687",
            "file_path": "tests/test_client_options.py",
            "diff": "diff --git a/tests/test_client_options.py b/tests/test_client_options.py\nindex 8b6d09b..4016980 100644\n--- a/tests/test_client_options.py\n+++ b/tests/test_client_options.py\n@@ -1,7 +1,8 @@\n import pytest\n+import sys\n \n \n-pytestmark = pytest.mark.options\n+pytestmark = [pytest.mark.options, pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")]\n \n \n @pytest.fixture\n"
        },
        {
            "commit": "3ce7b9cb7b89ed8330621bdb0acb809eb830d687",
            "file_path": "tests/test_client_ws_api.py",
            "diff": "diff --git a/tests/test_client_ws_api.py b/tests/test_client_ws_api.py\nindex 4982e12..b1faa7d 100644\n--- a/tests/test_client_ws_api.py\n+++ b/tests/test_client_ws_api.py\n@@ -1,7 +1,10 @@\n+import sys\n+import pytest\n from binance.client import Client\n from .conftest import proxies, api_key, api_secret, testnet\n from .test_get_order_book import assert_ob\n \n+pytestmark = [pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")]\n \n def test_ws_get_order_book(client):\n     orderbook = client.ws_get_order_book(symbol=\"BTCUSDT\")\n"
        },
        {
            "commit": "3ce7b9cb7b89ed8330621bdb0acb809eb830d687",
            "file_path": "tests/test_client_ws_futures_requests.py",
            "diff": "diff --git a/tests/test_client_ws_futures_requests.py b/tests/test_client_ws_futures_requests.py\nindex eb29fe0..deb19ac 100644\n--- a/tests/test_client_ws_futures_requests.py\n+++ b/tests/test_client_ws_futures_requests.py\n@@ -1,9 +1,11 @@\n import pytest\n+import sys\n from binance.exceptions import BinanceAPIException\n from .test_get_order_book import assert_ob\n from .test_order import assert_contract_order\n \n \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n def test_ws_futures_get_order_book(futuresClient):\n     orderbook = futuresClient.ws_futures_get_order_book(symbol=\"BTCUSDT\")\n     assert_ob(orderbook)\n@@ -14,14 +16,17 @@ def test_bad_request(futuresClient):\n         futuresClient.ws_futures_get_order_book()\n \n \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n def test_ws_futures_get_all_tickers(futuresClient):\n     futuresClient.ws_futures_get_all_tickers()\n \n \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n def test_ws_futures_get_order_book_ticker(futuresClient):\n     futuresClient.ws_futures_get_order_book_ticker()\n \n \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n def test_ws_futures_create_get_edit_cancel_order(futuresClient):\n     ticker = futuresClient.ws_futures_get_order_book_ticker(symbol=\"LTCUSDT\")\n     positions = futuresClient.ws_futures_v2_account_position(symbol=\"LTCUSDT\")\n@@ -52,25 +57,31 @@ def test_ws_futures_create_get_edit_cancel_order(futuresClient):\n     )\n \n \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n def test_ws_futures_v2_account_position(futuresClient):\n     futuresClient.ws_futures_v2_account_position()\n \n \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n def test_ws_futures_account_position(futuresClient):\n     futuresClient.ws_futures_account_position()\n \n \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n def test_ws_futures_v2_account_balance(futuresClient):\n     futuresClient.ws_futures_v2_account_balance()\n \n \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n def test_ws_futures_account_balance(futuresClient):\n     futuresClient.ws_futures_account_balance()\n \n \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n def test_ws_futures_v2_account_status(futuresClient):\n     futuresClient.ws_futures_v2_account_status()\n \n \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n def test_ws_futures_account_status(futuresClient):\n     futuresClient.ws_futures_account_status()\n"
        },
        {
            "commit": "3ce7b9cb7b89ed8330621bdb0acb809eb830d687",
            "file_path": "tests/test_get_order_book.py",
            "diff": "diff --git a/tests/test_get_order_book.py b/tests/test_get_order_book.py\nindex 71b6068..5ce74de 100644\n--- a/tests/test_get_order_book.py\n+++ b/tests/test_get_order_book.py\n@@ -1,4 +1,5 @@\n import pytest\n+import sys\n from binance.exceptions import BinanceAPIException\n \n \n@@ -67,6 +68,7 @@ async def test_futures_get_order_book_async(clientAsync):\n         pytest.fail(f\"API request failed: {str(e)}\")\n \n \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n @pytest.mark.asyncio()\n async def test_ws_get_order_book(clientAsync):\n     order_book = await clientAsync.ws_get_order_book(symbol=\"BTCUSDT\")\n"
        },
        {
            "commit": "3ce7b9cb7b89ed8330621bdb0acb809eb830d687",
            "file_path": "tests/test_socket_manager.py",
            "diff": "diff --git a/tests/test_socket_manager.py b/tests/test_socket_manager.py\nindex 64e7fac..e5adb7b 100644\n--- a/tests/test_socket_manager.py\n+++ b/tests/test_socket_manager.py\n@@ -1,5 +1,6 @@\n from binance import BinanceSocketManager, AsyncClient\n import pytest\n+from .conftest import proxy\n \n \n def assert_message(msg):\n@@ -9,7 +10,7 @@ def assert_message(msg):\n \n @pytest.mark.asyncio()\n async def test_ticker_socket():\n-    client = await AsyncClient.create(testnet=True)\n+    client = await AsyncClient.create(testnet=True, https_proxy=proxy)\n     bm = BinanceSocketManager(client)\n \n     ts = bm.futures_ticker_socket()\n"
        },
        {
            "commit": "3ce7b9cb7b89ed8330621bdb0acb809eb830d687",
            "file_path": "tests/test_streams_options.py",
            "diff": "diff --git a/tests/test_streams_options.py b/tests/test_streams_options.py\nindex 8d77144..1fb91b7 100644\n--- a/tests/test_streams_options.py\n+++ b/tests/test_streams_options.py\n@@ -12,9 +12,9 @@ pytestmark = [\n logger = logging.getLogger(__name__)\n \n # Test constants\n-OPTION_SYMBOL = \"BTC-250926-40000-P\"\n+OPTION_SYMBOL = \"BTC-251226-60000-P\"\n UNDERLYING_SYMBOL = \"BTC\"\n-EXPIRATION_DATE = \"250926\"\n+EXPIRATION_DATE = \"251226\"\n INTERVAL = \"1m\"\n DEPTH = \"20\"\n \n"
        },
        {
            "commit": "3ce7b9cb7b89ed8330621bdb0acb809eb830d687",
            "file_path": "tests/test_ws_api.py",
            "diff": "diff --git a/tests/test_ws_api.py b/tests/test_ws_api.py\nindex e7f1165..2a8078c 100644\n--- a/tests/test_ws_api.py\n+++ b/tests/test_ws_api.py\n@@ -8,8 +8,10 @@ from binance import AsyncClient\n from binance.exceptions import BinanceAPIException, BinanceWebsocketUnableToConnect\n from binance.ws.constants import WSListenerState\n from .test_get_order_book import assert_ob\n+from .conftest import proxy\n \n \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n @pytest.mark.asyncio\n async def test_ws_api_public_endpoint(clientAsync):\n     \"\"\"Test normal order book request\"\"\"\n@@ -17,12 +19,14 @@ async def test_ws_api_public_endpoint(clientAsync):\n     assert_ob(order_book)\n \n \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n @pytest.mark.asyncio\n async def test_ws_api_private_endpoint(clientAsync):\n     \"\"\"Test normal order book request\"\"\"\n     orders = await clientAsync.ws_get_all_orders(symbol=\"BTCUSDT\")\n \n \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n @pytest.mark.asyncio\n async def test_ws_futures_public_endpoint(futuresClientAsync):\n     \"\"\"Test normal order book request\"\"\"\n@@ -30,12 +34,14 @@ async def test_ws_futures_public_endpoint(futuresClientAsync):\n     assert_ob(order_book)\n \n \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n @pytest.mark.asyncio\n async def test_ws_futures_private_endpoint(futuresClientAsync):\n     \"\"\"Test normal order book request\"\"\"\n     await futuresClientAsync.ws_futures_v2_account_position(symbol=\"BTCUSDT\")\n \n \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n @pytest.mark.asyncio\n async def test_ws_get_symbol_ticker(clientAsync):\n     \"\"\"Test symbol ticker request\"\"\"\n@@ -102,7 +108,7 @@ async def test_multiple_requests(clientAsync):\n @pytest.mark.asyncio\n async def test_testnet_url():\n     \"\"\"Test testnet URL configuration\"\"\"\n-    testnet_client = AsyncClient(testnet=True)\n+    testnet_client = AsyncClient(testnet=True, https_proxy=proxy)\n     try:\n         assert testnet_client.ws_api._url == testnet_client.WS_API_TESTNET_URL\n         order_book = await testnet_client.ws_get_order_book(symbol=\"BTCUSDT\")\n@@ -114,38 +120,53 @@ async def test_testnet_url():\n @pytest.mark.asyncio\n async def test_message_handling(clientAsync):\n     \"\"\"Test message handling with various message types\"\"\"\n-    # Test valid message\n-    future = asyncio.Future()\n-    clientAsync.ws_api._responses[\"123\"] = future\n-    valid_msg = {\"id\": \"123\", \"status\": 200, \"result\": {\"test\": \"data\"}}\n-    clientAsync.ws_api._handle_message(json.dumps(valid_msg))\n-    result = await clientAsync.ws_api._responses[\"123\"]\n-    assert result == valid_msg\n-    \n-@pytest.mark.asyncio\n-async def test_message_handling_raise_exception(clientAsync):\n-    with pytest.raises(BinanceAPIException):\n+    try:\n+        # Test valid message\n         future = asyncio.Future()\n         clientAsync.ws_api._responses[\"123\"] = future\n-        valid_msg = {\"id\": \"123\", \"status\": 400, \"error\": {\"code\": \"0\", \"msg\": \"error message\"}}\n+        valid_msg = {\"id\": \"123\", \"status\": 200, \"result\": {\"test\": \"data\"}}\n         clientAsync.ws_api._handle_message(json.dumps(valid_msg))\n-        await future\n+        result = await clientAsync.ws_api._responses[\"123\"]\n+        assert result == valid_msg\n+    finally:\n+        await clientAsync.close_connection()\n+\n+@pytest.mark.asyncio\n+async def test_message_handling_raise_exception(clientAsync):\n+    try:\n+        with pytest.raises(BinanceAPIException):\n+            future = asyncio.Future()\n+            clientAsync.ws_api._responses[\"123\"] = future\n+            valid_msg = {\"id\": \"123\", \"status\": 400, \"error\": {\"code\": \"0\", \"msg\": \"error message\"}}\n+            clientAsync.ws_api._handle_message(json.dumps(valid_msg))\n+            await future\n+    finally:\n+        await clientAsync.close_connection()\n+\n @pytest.mark.asyncio\n async def test_message_handling_raise_exception_without_id(clientAsync):\n-    with pytest.raises(BinanceAPIException):\n-        future = asyncio.Future()\n-        clientAsync.ws_api._responses[\"123\"] = future\n-        valid_msg = {\"id\": \"123\", \"status\": 400, \"error\": {\"code\": \"0\", \"msg\": \"error message\"}}\n-        clientAsync.ws_api._handle_message(json.dumps(valid_msg))\n-        await future\n-    \n+    try:\n+        with pytest.raises(BinanceAPIException):\n+            future = asyncio.Future()\n+            clientAsync.ws_api._responses[\"123\"] = future\n+            valid_msg = {\"id\": \"123\", \"status\": 400, \"error\": {\"code\": \"0\", \"msg\": \"error message\"}}\n+            clientAsync.ws_api._handle_message(json.dumps(valid_msg))\n+            await future\n+    finally:\n+        await clientAsync.close_connection()\n+\n+\n @pytest.mark.asyncio\n async def test_message_handling_invalid_json(clientAsync):\n-    with pytest.raises(json.JSONDecodeError):\n-        clientAsync.ws_api._handle_message(\"invalid json\")\n+    try:\n+        with pytest.raises(json.JSONDecodeError):\n+            clientAsync.ws_api._handle_message(\"invalid json\")\n \n-    with pytest.raises(json.JSONDecodeError):\n-        clientAsync.ws_api._handle_message(\"invalid json\")\n+        with pytest.raises(json.JSONDecodeError):\n+            clientAsync.ws_api._handle_message(\"invalid json\")\n+    finally:\n+        # Ensure cleanup\n+        await clientAsync.close_connection()\n \n \n @pytest.mark.asyncio(scope=\"function\")\n@@ -173,10 +194,11 @@ async def test_cleanup_on_exit(clientAsync):\n     assert future.exception() is not None\n \n \n+@pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n @pytest.mark.asyncio\n async def test_ws_queue_overflow(clientAsync):\n     \"\"\"WebSocket API should not overflow queue\"\"\"\n-    # \n+    #\n     original_size = clientAsync.ws_api.max_queue_size\n     clientAsync.ws_api.max_queue_size = 1\n \n@@ -184,36 +206,37 @@ async def test_ws_queue_overflow(clientAsync):\n         # Request multiple order books concurrently\n         symbols = [\"BTCUSDT\", \"ETHUSDT\", \"BNBUSDT\"]\n         tasks = [clientAsync.ws_get_order_book(symbol=symbol) for symbol in symbols]\n-        \n+\n         # Execute all requests concurrently and wait for results\n         results = await asyncio.gather(*tasks, return_exceptions=True)\n-        \n+\n         # Check that we got valid responses or expected overflow errors\n         valid_responses = [r for r in results if not isinstance(r, Exception)]\n         assert len(valid_responses) == len(symbols), \"Should get at least one valid response\"\n-        \n+\n         for result in valid_responses:\n             assert_ob(result)\n-            \n+\n     finally:\n         # Restore original queue size\n         clientAsync.ws_api.MAX_QUEUE_SIZE = original_size\n \n+\n @pytest.mark.skipif(sys.version_info < (3, 8), reason=\"websockets_proxy Python 3.8+\")\n @pytest.mark.asyncio\n async def test_ws_api_with_stream(clientAsync):\n     \"\"\"Test combining WebSocket API requests with stream listening\"\"\"\n     from binance import BinanceSocketManager\n-    \n+\n     # Create socket manager and trade socket\n     bm = BinanceSocketManager(clientAsync)\n     ts = bm.trade_socket(\"BTCUSDT\")\n-    \n+\n     async with ts:\n         # Make WS API request while stream is active\n         order_book = await clientAsync.ws_get_order_book(symbol=\"BTCUSDT\")\n         assert_ob(order_book)\n-        \n+\n         # Verify we can still receive stream data\n         trade = await ts.recv()\n         assert \"s\" in trade  # Symbol\n"
        },
        {
            "commit": "3ce7b9cb7b89ed8330621bdb0acb809eb830d687",
            "file_path": "tox.ini",
            "diff": "diff --git a/tox.ini b/tox.ini\nindex e221c00..92335cb 100644\n--- a/tox.ini\n+++ b/tox.ini\n@@ -1,5 +1,5 @@\n [tox]\n-envlist = py36, py37, py38, py39, py310, py311, py312\n+envlist = py38, py39, py310, py311, py312\n \n [testenv]\n deps =\n@@ -12,7 +12,7 @@ passenv =\n     TEST_API_SECRET\n     TEST_FUTURES_API_KEY\n     TEST_FUTURES_API_SECRET\n-commands = pytest -n 1 -vvs tests/  --timeout=60 --doctest-modules --cov binance --cov-report term-missing --reruns 3 --reruns-delay 120\n+commands = pytest -n 5 -v tests/ --timeout=90 --doctest-modules --cov binance --cov-report term-missing --cov-report xml --reruns 3 --reruns-delay 30\n \n [pep8]\n ignore = E501\n"
        }
    ]
}