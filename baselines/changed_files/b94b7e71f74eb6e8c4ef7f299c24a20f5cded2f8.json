{
    "sha_fail": "b94b7e71f74eb6e8c4ef7f299c24a20f5cded2f8",
    "changed_files": [
        {
            "commit": "b94b7e71f74eb6e8c4ef7f299c24a20f5cded2f8",
            "file_path": "beetsplug/smartplaylist.py",
            "diff": "diff --git a/beetsplug/smartplaylist.py b/beetsplug/smartplaylist.py\nindex c892a604..d077a35b 100644\n--- a/beetsplug/smartplaylist.py\n+++ b/beetsplug/smartplaylist.py\n@@ -45,6 +45,7 @@ class SmartPlaylistPlugin(BeetsPlugin):\n                 \"playlist_dir\": \".\",\n                 \"auto\": True,\n                 \"playlists\": [],\n+                \"uri_template\": None,\n                 \"forward_slash\": False,\n                 \"prefix\": \"\",\n                 \"urlencode\": False,\n@@ -72,6 +73,13 @@ class SmartPlaylistPlugin(BeetsPlugin):\n             action=\"store_true\",\n             help=\"display query results but don't write playlist files.\",\n         )\n+        spl_update.parser.add_option(\n+            \"--uri-template\",\n+            dest=\"uri_template\",\n+            metavar=\"TPL\",\n+            type=\"string\",\n+            help=\"playlist item URI template with `$id` placeholder, e.g. http://beets:8337/item/$id/file.\",\n+        )\n         spl_update.parser.add_option(\n             \"--extm3u\",\n             action=\"store_true\",\n@@ -208,6 +216,7 @@ class SmartPlaylistPlugin(BeetsPlugin):\n                 \"Updating {0} smart playlists...\", len(self._matched_playlists)\n             )\n \n+        tpl = self.config[\"uri_template\"].get()\n         playlist_dir = self.config[\"playlist_dir\"].as_filename()\n         playlist_dir = bytestring_path(playlist_dir)\n         relative_to = self.config[\"relative_to\"].get()\n@@ -238,13 +247,22 @@ class SmartPlaylistPlugin(BeetsPlugin):\n                 m3u_name = sanitize_path(m3u_name, lib.replacements)\n                 if m3u_name not in m3us:\n                     m3us[m3u_name] = []\n-                item_path = item.path\n-                if relative_to:\n-                    item_path = os.path.relpath(item.path, relative_to)\n-                if item_path not in m3us[m3u_name]:\n-                    m3us[m3u_name].append({\"item\": item, \"path\": item_path})\n+                item_uri = item.path\n+                if tpl:\n+                    item_uri = tpl.replace(\"$id\", str(item.id)).encode(\"utf-8\")\n+                else:\n+                    if relative_to:\n+                        item_uri = os.path.relpath(item_uri, relative_to)\n+                    if self.config[\"forward_slash\"].get():\n+                        item_uri = path_as_posix(item_uri)\n+                    if self.config[\"urlencode\"]:\n+                        item_uri = bytestring_path(pathname2url(item_uri))\n+                    item_uri = prefix + item_uri\n+\n+                if item_uri not in m3us[m3u_name]:\n+                    m3us[m3u_name].append({\"item\": item, \"uri\": item_uri})\n                     if pretend and self.config[\"pretend_paths\"]:\n-                        print(displayable_path(item_path))\n+                        print(displayable_path(item_uri))\n                     elif pretend:\n                         print(item)\n \n@@ -261,18 +279,13 @@ class SmartPlaylistPlugin(BeetsPlugin):\n                     if extm3u:\n                         f.write(b\"#EXTM3U\\n\")\n                     for entry in m3us[m3u]:\n-                        path = entry[\"path\"]\n                         item = entry[\"item\"]\n-                        if self.config[\"forward_slash\"].get():\n-                            path = path_as_posix(path)\n-                        if self.config[\"urlencode\"]:\n-                            path = bytestring_path(pathname2url(path))\n                         comment = \"\"\n                         if extm3u:\n                             comment = \"#EXTINF:{},{} - {}\\n\".format(\n                                 int(item.length), item.artist, item.title\n                             )\n-                        f.write(comment.encode(\"utf-8\") + prefix + path + b\"\\n\")\n+                        f.write(comment.encode(\"utf-8\") + entry[\"uri\"] + b\"\\n\")\n             # Send an event when playlists were updated.\n             send_event(\"smartplaylist_update\")\n \n"
        },
        {
            "commit": "b94b7e71f74eb6e8c4ef7f299c24a20f5cded2f8",
            "file_path": "docs/changelog.rst",
            "diff": "diff --git a/docs/changelog.rst b/docs/changelog.rst\nindex 9259b593..7b5e88c3 100644\n--- a/docs/changelog.rst\n+++ b/docs/changelog.rst\n@@ -148,7 +148,8 @@ New features:\n   `synced` option to prefer synced lyrics over plain lyrics.\n * :ref:`import-cmd`: Expose import.quiet_fallback as CLI option.\n * :ref:`import-cmd`: Expose `import.incremental_skip_later` as CLI option.\n-* :doc:`/plugins/smartplaylist`: Add new config option `smartplaylist.extm3u`.\n+* :doc:`/plugins/smartplaylist`: Add new option `smartplaylist.extm3u`.\n+* :doc:`/plugins/smartplaylist`: Add new option `smartplaylist.uri_template`.\n \n Bug fixes:\n \n"
        },
        {
            "commit": "b94b7e71f74eb6e8c4ef7f299c24a20f5cded2f8",
            "file_path": "docs/plugins/smartplaylist.rst",
            "diff": "diff --git a/docs/plugins/smartplaylist.rst b/docs/plugins/smartplaylist.rst\nindex 6a78124e..13cc1eb3 100644\n--- a/docs/plugins/smartplaylist.rst\n+++ b/docs/plugins/smartplaylist.rst\n@@ -119,3 +119,7 @@ other configuration options are:\n - **pretend_paths**: When running with ``--pretend``, show the actual file\n   paths that will be written to the m3u file. Default: ``false``.\n - **extm3u**: Generate extm3u/m3u8 playlists. Default ``\u01f9o``.\n+- **uri_template**: Template with an ``$id`` placeholder used generate a\n+  playlist item URI, e.g. ``http://beets/item/$id/file``.\n+  When this option is specified, the local path-related options ``prefix``,\n+  ``relative_to``, ``forward_slash`` and ``urlencode`` are ignored.\n"
        },
        {
            "commit": "b94b7e71f74eb6e8c4ef7f299c24a20f5cded2f8",
            "file_path": "test/plugins/test_smartplaylist.py",
            "diff": "diff --git a/test/plugins/test_smartplaylist.py b/test/plugins/test_smartplaylist.py\nindex f3660126..eecf408f 100644\n--- a/test/plugins/test_smartplaylist.py\n+++ b/test/plugins/test_smartplaylist.py\n@@ -242,6 +242,47 @@ class SmartPlaylistTest(_common.TestCase):\n         )\n \n \n+    def test_playlist_update_uri_template(self):\n+        spl = SmartPlaylistPlugin()\n+\n+        i = MagicMock()\n+        type(i).id = PropertyMock(return_value=3)\n+        type(i).path = PropertyMock(return_value=b\"/tagada.mp3\")\n+        i.evaluate_template.side_effect = lambda pl, _: pl.replace(\n+            b\"$title\", b\"ta:ga:da\"\n+        ).decode()\n+\n+        lib = Mock()\n+        lib.replacements = CHAR_REPLACE\n+        lib.items.return_value = [i]\n+        lib.albums.return_value = []\n+\n+        q = Mock()\n+        a_q = Mock()\n+        pl = b\"$title-my<playlist>.m3u\", (q, None), (a_q, None)\n+        spl._matched_playlists = [pl]\n+\n+        dir = bytestring_path(mkdtemp())\n+        config[\"smartplaylist\"][\"uri_template\"] = \"http://beets:8337/item/$id/file\"\n+        config[\"smartplaylist\"][\"playlist_dir\"] = py3_path(dir)\n+        try:\n+            spl.update_playlists(lib)\n+        except Exception:\n+            rmtree(syspath(dir))\n+            raise\n+\n+        lib.items.assert_called_once_with(q, None)\n+        lib.albums.assert_called_once_with(a_q, None)\n+\n+        m3u_filepath = path.join(dir, b\"ta_ga_da-my_playlist_.m3u\")\n+        self.assertExists(m3u_filepath)\n+        with open(syspath(m3u_filepath), \"rb\") as f:\n+            content = f.read()\n+        rmtree(syspath(dir))\n+\n+        self.assertEqual(content, b\"http://beets:8337/item/3/file\\n\")\n+\n+\n class SmartPlaylistCLITest(_common.TestCase, TestHelper):\n     def setUp(self):\n         self.setup_beets()\n"
        }
    ]
}