{
    "sha_fail": "385c14d0ae500918cff5565ea836884bfaa2bfa5",
    "changed_files": [
        {
            "commit": "385c14d0ae500918cff5565ea836884bfaa2bfa5",
            "file_path": "cloudinit/net/dhcp.py",
            "diff": "diff --git a/cloudinit/net/dhcp.py b/cloudinit/net/dhcp.py\nindex ed5b4747..1b8caee4 100644\n--- a/cloudinit/net/dhcp.py\n+++ b/cloudinit/net/dhcp.py\n@@ -173,6 +173,7 @@ def networkd_get_option_from_leases(keyname, leases_d=None):\n \n class DhcpClient(abc.ABC):\n     client_name = \"\"\n+    max_wait = 5\n \n     @classmethod\n     def kill_dhcp_client(cls):\n@@ -321,7 +322,7 @@ class IscDhclient(DhcpClient):\n         # kill the correct process, thus freeing cleandir to be deleted back\n         # up the callstack.\n         missing = util.wait_for_files(\n-            [pid_file, lease_file], maxwait=5, naplen=0.01\n+            [pid_file, lease_file], maxwait=self.max_wait, naplen=0.01\n         )\n         if missing:\n             LOG.warning(\n@@ -536,7 +537,131 @@ class Dhcpcd:\n     client_name = \"dhcpcd\"\n \n     def __init__(self):\n-        raise NoDHCPLeaseMissingDhclientError(\"Dhcpcd not yet implemented\")\n+        self.dhclient_path = subp.which(\"dhcpcd\")\n+        if not self.dhclient_path:\n+            LOG.debug(\n+                \"Skip dhclient configuration: No dhclient command found.\"\n+            )\n+            raise NoDHCPLeaseMissingDhclientError()\n+\n+    def dhcp_discovery(\n+        self,\n+        interface,\n+        dhcp_log_func=None,\n+        distro=None,\n+    ):\n+        \"\"\"Run dhclient on the interface without scripts/filesystem artifacts.\n+\n+        @param dhclient_cmd_path: Full path to the dhclient used.\n+        @param interface: Name of the network interface on which to dhclient.\n+        @param dhcp_log_func: A callable accepting the dhclient output and\n+            error streams.\n+\n+        @return: A list of dicts of representing the dhcp leases parsed from\n+            the dhclient.lease file or empty list.\n+        \"\"\"\n+        LOG.debug(\"Performing a dhcp discovery on %s\", interface)\n+\n+        # ISC dhclient needs the interface up to send initial discovery packets\n+        # Generally dhclient relies on dhclient-script PREINIT action to bring\n+        # the link up before attempting discovery. Since we are using\n+        # -sf /bin/true, we need to do that \"link up\" ourselves first.\n+        distro.net_ops.link_up(interface)\n+\n+        # TODO: disabling hooks means we need to get all of the files in\n+        # /lib/dhcpcd/dhcpcd-hooks/ and pass each of those with the --nohook\n+        # argument to dhcpcd\n+        try:\n+            out, err = subp.subp(\n+                [\n+                    \"dhcpcd\",\n+                    \"--oneshot\",  # get lease then exit\n+                    \"--nobackground\",  # don't fork\n+                    \"--ipv4only\",  # only attempt configuring ipv4\n+                    \"--waitip=4\",  # wait for ipv4 to be configured\n+                    \"--persistent\",  # don't deconfigure when dhcpcd exits\n+                    \"--noarp\",  # don't be slow\n+                    interface,\n+                ]\n+            )\n+        except subp.ProcessExecutionError as error:\n+            LOG.debug(\n+                \"dhclient exited with code: %s stderr: %r stdout: %r\",\n+                error.exit_code,\n+                error.stderr,\n+                error.stdout,\n+            )\n+            raise NoDHCPLeaseError from error\n+        return self.parse_dhcp_lease_file(interface)\n+\n+    @staticmethod\n+    def parse_dhcpcd_lease(lease_dump: str, interface: str) -> List[dict]:\n+        \"\"\"parse the output of dhcpcd --dump\n+\n+        map names to the datastructure we create from dhclient\n+\n+        example dhcpcd output:\n+\n+        broadcast_address='192.168.15.255'\n+        dhcp_lease_time='3600'\n+        dhcp_message_type='5'\n+        dhcp_server_identifier='192.168.0.1'\n+        domain_name='us-east-2.compute.internal'\n+        domain_name_servers='192.168.0.2'\n+        host_name='ip-192-168-0-212'\n+        interface_mtu='9001'\n+        ip_address='192.168.0.212'\n+        network_number='192.168.0.0'\n+        routers='192.168.0.1'\n+        subnet_cidr='20'\n+        subnet_mask='255.255.240.0'\n+        \"\"\"\n+\n+        # create a dict from dhcpcd dump output\n+        lease = dict(\n+            [a.split(\"=\") for a in lease_dump.replace(\"'\", \"\").split()]\n+        )\n+\n+        # this name is just different\n+        lease[\"fixed-address\"] = lease.pop(\"ip_address\")\n+\n+        # this is expected by our code, can probably change that at some point\n+        lease[\"interface\"] = interface\n+\n+        # transform underscores to hyphens and return\n+        return [{key.replace(\"_\", \"-\"): value for key, value in lease.items()}]\n+\n+    @classmethod\n+    def parse_dhcp_lease_file(cls, interface) -> List[Dict[str, Any]]:\n+        \"\"\"Return a list of leases\n+\n+        Return a list of dicts of dhcp options. Each dict contains key value\n+        pairs a specific lease in order from oldest to newest.\n+\n+        @raises: InvalidDHCPLeaseFileError on empty or unparseable leasefile\n+            content.\n+        \"\"\"\n+        try:\n+            return cls.parse_dhcpcd_lease(\n+                subp.subp(\n+                    [\n+                        \"dhcpcd\",\n+                        \"--dumplease\",\n+                        interface,\n+                    ],\n+                    rcs=[0, 1],\n+                ).stdout,\n+                interface,\n+            )\n+\n+        except subp.ProcessExecutionError as error:\n+            LOG.debug(\n+                \"dhclient exited with code: %s stderr: %r stdout: %r\",\n+                error.exit_code,\n+                error.stderr,\n+                error.stdout,\n+            )\n+            raise NoDHCPLeaseError from error\n \n \n class Udhcpc(DhcpClient):\n"
        },
        {
            "commit": "385c14d0ae500918cff5565ea836884bfaa2bfa5",
            "file_path": "tests/unittests/net/test_dhcp.py",
            "diff": "diff --git a/tests/unittests/net/test_dhcp.py b/tests/unittests/net/test_dhcp.py\nindex 8ec96eef..2841a724 100644\n--- a/tests/unittests/net/test_dhcp.py\n+++ b/tests/unittests/net/test_dhcp.py\n@@ -447,8 +447,8 @@ class TestDHCPDiscoveryClean(CiTestCase):\n             self.logs.getvalue(),\n         )\n         self.assertIn(\n-            \"DHCP client not found: dhcpcd\",\n-            self.logs.getvalue(),\n+           \"DHCP client not found: dhcpcd\",\n+           self.logs.getvalue(),\n         )\n \n     @mock.patch(\"cloudinit.net.dhcp.find_fallback_nic\", return_value=None)\n"
        }
    ]
}