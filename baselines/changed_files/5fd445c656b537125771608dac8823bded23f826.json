{
    "sha_fail": "5fd445c656b537125771608dac8823bded23f826",
    "changed_files": [
        {
            "commit": "5fd445c656b537125771608dac8823bded23f826",
            "file_path": "src/calibre/gui2/actions/column_tooltips.py",
            "diff": "diff --git a/src/calibre/gui2/actions/column_tooltips.py b/src/calibre/gui2/actions/column_tooltips.py\nindex fb764429..d612bb06 100644\n--- a/src/calibre/gui2/actions/column_tooltips.py\n+++ b/src/calibre/gui2/actions/column_tooltips.py\n@@ -2,9 +2,12 @@\n # License: GPLv3 Copyright: 2022, Charles Haley\n #\n \n+from qt.core import Qt, QDialogButtonBox, QVBoxLayout\n+\n from calibre.gui2 import error_dialog\n from calibre.gui2.actions import InterfaceAction\n from calibre.gui2.dialogs.template_dialog import TemplateDialog\n+from calibre.gui2.widgets2 import Dialog, HTMLDisplay\n \n \n def column_template_placeholder_text():\n@@ -12,37 +15,84 @@ def column_template_placeholder_text():\n             'Notes:\\n'\n             '\u2022 The template global variable \"{0}\" contains the column lookup name.\\n'\n             '\u2022 The global variable \"{1}\" contains the original tooltip text').format('column_lookup_name',\n-\n                                                                                      'original_text')\n \n \n+class ToolTipDialog(Dialog):\n+\n+    def __init__(self, title, prefs):\n+        super().__init__(title, 'show_tooltip_dialog',\n+                         prefs = prefs,\n+                         default_buttons=QDialogButtonBox.StandardButton.Ok)\n+\n+    def setup_ui(self):\n+        l = QVBoxLayout(self)\n+        d = self.display = HTMLDisplay()\n+        l.addWidget(d)\n+        l.addWidget(self.bb)\n+\n+    def set_html(self, tt_text):\n+        self.display.setHtml(tt_text)\n+\n+\n class ColumnTooltipsAction(InterfaceAction):\n \n     name = 'Column tooltips'\n     action_spec = (_('Column tooltips'), 'edit_input.png',\n                    _('Define a custom tooltip for values in a column'), ())\n     action_type = 'current'\n+    action_add_menu = True\n+    action_menu_clone_qaction = _('Edit/define column tooltip')\n     dont_add_to = frozenset(('context-menu-device', 'menubar-device'))\n \n     def genesis(self):\n         self.qaction.triggered.connect(self.show_template_editor)\n+        m = self.qaction.menu()\n+        ac = self.create_menu_action(m, 'tooltip_in_dialog_box', _('Show item tooltip in a dialog'),\n+            icon='dialog_information.png', triggered=self.show_tooltip_in_dialog, shortcut=None)\n+        m.addAction(ac)\n \n-    def show_template_editor(self):\n+    def check_errors(self, only_one_row=False):\n         view = self.gui.current_view()\n         if view is not self.gui.library_view:\n-            return error_dialog(self.gui, _('No template tester available'),\n-                _('Template tester is not available for books '\n-                  'on the device.')).exec()\n-\n+            error_dialog(self.gui, _('No library view available'),\n+                _(\"You can't set custom tooltips for books on the device.\")).exec()\n+            return (None, None, None, None)\n         idx = view.currentIndex()\n         if not idx.isValid():\n-            return error_dialog(self.gui, _('No column selected'),\n+            error_dialog(self.gui, _('No column selected'),\n                     _('A column (cell) must be selected'), show=True)\n+            return (None, None, None, None)\n         column = view.model().column_map[idx.column()]\n         rows = view.selectionModel().selectedRows()\n         if not rows:\n-            return error_dialog(self.gui, _('No books selected'),\n+            error_dialog(self.gui, _('No books selected'),\n                     _('At least one book must be selected'), show=True)\n+            return (None, None, None, None)\n+        if only_one_row and len(rows) != 1:\n+            error_dialog(self.gui, _('Only one book'),\n+                    _('Only one book can be selected'), show=True)\n+            return (None, None, None, None)\n+        return view, idx, column, rows\n+\n+    def show_tooltip_in_dialog(self):\n+        view, idx, column, rows = self.check_errors(only_one_row=True)\n+        if view is None:\n+            return\n+        from calibre.gui2.ui import get_gui\n+        db = get_gui().current_db.new_api\n+        fm = db.field_metadata.get(column)\n+        col_name = fm['name']\n+        d = ToolTipDialog(\n+            _('Tooltip for column {name}, row {row_num}').format(name=col_name, row_num=rows[0].row()+1),\n+            prefs=db.backend.prefs)\n+        d.set_html(idx.data(Qt.ItemDataRole.ToolTipRole))\n+        d.exec()\n+\n+    def show_template_editor(self):\n+        view, _, column, rows = self.check_errors()\n+        if view is None:\n+            return\n         mi = []\n         db = view.model().db\n         for row in rows:\n"
        }
    ]
}