{
    "sha_fail": "d1e88b8766d152d7d4e7911a0072591db1eb4bcd",
    "changed_files": [
        {
            "commit": "d1e88b8766d152d7d4e7911a0072591db1eb4bcd",
            "file_path": "libs/agno/agno/vectordb/weaviate/weaviate.py",
            "diff": "diff --git a/libs/agno/agno/vectordb/weaviate/weaviate.py b/libs/agno/agno/vectordb/weaviate/weaviate.py\nindex 8b61c4107..16fce338e 100644\n--- a/libs/agno/agno/vectordb/weaviate/weaviate.py\n+++ b/libs/agno/agno/vectordb/weaviate/weaviate.py\n@@ -123,7 +123,7 @@ class Weaviate(VectorDb):\n             await self.async_client.connect()  # type: ignore\n \n         if not await self.async_client.is_ready():  # type: ignore\n-            raise Exception(\"Weaviate async client is not ready\")\n+            raise ConnectionError(\"Weaviate async client is not ready\")\n \n         return self.async_client  # type: ignore\n \n@@ -382,12 +382,18 @@ class Weaviate(VectorDb):\n             filters (Optional[Dict[str, Any]]): Filters to apply while upserting\n         \"\"\"\n         log_debug(f\"Upserting {len(documents)} documents into Weaviate.\")\n+        \n         _docs_to_insert = []\n         for document in documents:\n-            if document.name and self.name_exists(document.name):\n+            assert document.name is not None, \"Document name must be set for upsert operation.\"\n+\n+            if self.name_exists(document.name):\n                 if self.doc_content_changed(document, check_existing=False):\n                     log_debug(f\"Document already exists, but content changed. Document will be deleted and added again: {document.name}\")\n-                    self.doc_delete(document.name)\n+                    \n+                    is_first_or_only_chunk = (\"chunk\" in document.meta_data and document.meta_data[\"chunk\"] == 1) or (\"chunk\" not in document.meta_data)\n+                    if is_first_or_only_chunk:\n+                        self.doc_delete(document.name)\n                     _docs_to_insert.append(document)\n                 else:\n                     log_debug(f\"Document skipped, content is unchanged: {document.name}\")\n"
        },
        {
            "commit": "d1e88b8766d152d7d4e7911a0072591db1eb4bcd",
            "file_path": "libs/agno/tests/unit/vectordb/test_weaviatedb.py",
            "diff": "diff --git a/libs/agno/tests/unit/vectordb/test_weaviatedb.py b/libs/agno/tests/unit/vectordb/test_weaviatedb.py\nindex 23b8c0ec3..8f6648e4c 100644\n--- a/libs/agno/tests/unit/vectordb/test_weaviatedb.py\n+++ b/libs/agno/tests/unit/vectordb/test_weaviatedb.py\n@@ -216,10 +216,26 @@ def test_upsert_documents(weaviate_db, sample_documents, mock_weaviate_client):\n     \"\"\"Test upserting documents\"\"\"\n     collection = mock_weaviate_client.collections.get.return_value\n \n+    mock_result = Mock()\n+    mock_result.objects = []\n+    collection.query.fetch_objects.return_value = mock_result\n+\n     weaviate_db.upsert(sample_documents)\n     assert collection.data.insert.call_count == 3\n \n \n+def test_upsert_documents_with_existing_data(weaviate_db, sample_documents, mock_weaviate_client):\n+    \"\"\"Test upserting documents\"\"\"\n+    collection = mock_weaviate_client.collections.get.return_value\n+\n+    mock_result = Mock()\n+    mock_result.objects = [Mock()]  # Simulate existing data\n+    collection.query.fetch_objects.return_value = mock_result\n+\n+    weaviate_db.upsert(sample_documents)\n+    assert collection.data.insert.call_count == 0\n+\n+\n def test_vector_index_config(weaviate_db):\n     \"\"\"Test vector index configuration\"\"\"\n     # Instead of checking instance type, just verify it's not None\n"
        }
    ]
}