{
    "sha_fail": "6045a677ac736652e43bacb313f2fa2ab56c7cda",
    "changed_files": [
        {
            "commit": "6045a677ac736652e43bacb313f2fa2ab56c7cda",
            "file_path": "Include/internal/pycore_interp_structs.h",
            "diff": "diff --git a/Include/internal/pycore_interp_structs.h b/Include/internal/pycore_interp_structs.h\nindex fdbba611..142bcbec 100644\n--- a/Include/internal/pycore_interp_structs.h\n+++ b/Include/internal/pycore_interp_structs.h\n@@ -765,6 +765,7 @@ typedef struct _PyJitState {\n     _PyUOpInstruction *jit_tracer_code_buffer;\n     _Py_CODEUNIT *jit_tracer_insert_exec_instr;\n     _Py_CODEUNIT *jit_tracer_close_loop_instr;\n+    _Py_CODEUNIT *last_specialized_instr;\n     int jit_tracer_initial_stack_depth;\n     int jit_tracer_initial_chain_depth;\n     PyCodeObject *jit_tracer_initial_code; // Strong\n"
        },
        {
            "commit": "6045a677ac736652e43bacb313f2fa2ab56c7cda",
            "file_path": "Python/ceval_macros.h",
            "diff": "diff --git a/Python/ceval_macros.h b/Python/ceval_macros.h\nindex 18ccc3dc..256175b4 100644\n--- a/Python/ceval_macros.h\n+++ b/Python/ceval_macros.h\n@@ -137,6 +137,9 @@\n \n #if _Py_TAIL_CALL_INTERP || USE_COMPUTED_GOTOS\n #  define IS_JIT_TRACING() (DISPATCH_TABLE_VAR == TRACING_DISPATCH_TABLE)\n+// tstate->interp->jit_state.last_specialized_instr != this_instr is required to not get stuck in infinite\n+// specialization loops due to specialization failure.\n+#  define IS_JIT_TRACING_MAKING_PROGRESS() (IS_JIT_TRACING() && tstate->interp->jit_state.last_specialized_instr != this_instr)\n #  define ENTER_TRACING() \\\n     DISPATCH_TABLE_VAR = TRACING_DISPATCH_TABLE;\n #  define LEAVE_TRACING() \\\n@@ -214,6 +217,14 @@ do { \\\n         DISPATCH_GOTO(); \\\n     }\n \n+#define TRACING_SPECIALIZE_DISPATCH_SAME_OPARG() \\\n+{ \\\n+    tstate->interp->jit_state.last_specialized_instr = this_instr; \\\n+    opcode = next_instr->op.code; \\\n+    PRE_DISPATCH_GOTO(); \\\n+    DISPATCH_GOTO(); \\\n+}\n+\n #define DISPATCH_INLINED(NEW_FRAME)                     \\\n     do {                                                \\\n         assert(tstate->interp->eval_frame == NULL);     \\\n@@ -225,11 +236,13 @@ do { \\\n     } while (0)\n \n #define TRACING_DISPATCH_INLINED(NEW_FRAME) \\\n+    tstate->interp->jit_state.last_specialized_instr = this_instr; \\\n     RECORD_TRACE_NO_DISPATCH(); \\\n     DISPATCH_INLINED(NEW_FRAME);\n \n #define TRACING_DISPATCH() \\\n     { \\\n+        tstate->interp->jit_state.last_specialized_instr = this_instr; \\\n         assert(frame->stackpointer == NULL); \\\n         RECORD_TRACE_NO_DISPATCH(); \\\n         NEXTOPARG(); \\\n@@ -337,9 +350,14 @@ GETITEM(PyObject *v, Py_ssize_t i) {\n /* This takes a uint16_t instead of a _Py_BackoffCounter,\n  * because it is used directly on the cache entry in generated code,\n  * which is always an integral type. */\n+#if _Py_TIER2\n+// Force re-specialization when tracing a side exit to get good side exits.\n+#define ADAPTIVE_COUNTER_TRIGGERS(COUNTER) \\\n+    backoff_counter_triggers(forge_backoff_counter((COUNTER))) || IS_JIT_TRACING_MAKING_PROGRESS()\n+#else\n #define ADAPTIVE_COUNTER_TRIGGERS(COUNTER) \\\n     backoff_counter_triggers(forge_backoff_counter((COUNTER)))\n-\n+#endif\n #define ADVANCE_ADAPTIVE_COUNTER(COUNTER) \\\n     do { \\\n         (COUNTER) = advance_backoff_counter((COUNTER)); \\\n"
        },
        {
            "commit": "6045a677ac736652e43bacb313f2fa2ab56c7cda",
            "file_path": "Python/generated_tracer_cases.c.h",
            "diff": "diff --git a/Python/generated_tracer_cases.c.h b/Python/generated_tracer_cases.c.h\nindex cdd7246f..9d739dc0 100644\n--- a/Python/generated_tracer_cases.c.h\n+++ b/Python/generated_tracer_cases.c.h\n@@ -43,7 +43,7 @@\n                     _PyFrame_SetStackPointer(frame, stack_pointer);\n                     _Py_Specialize_BinaryOp(lhs, rhs, next_instr, oparg, LOCALS_ARRAY);\n                     stack_pointer = _PyFrame_GetStackPointer(frame);\n-                    DISPATCH_SAME_OPARG();\n+                    TRACING_SPECIALIZE_DISPATCH_SAME_OPARG()\n                 }\n                 OPCODE_DEFERRED_INC(BINARY_OP);\n                 ADVANCE_ADAPTIVE_COUNTER(this_instr[1].counter);\n@@ -1814,7 +1814,7 @@\n                     _PyFrame_SetStackPointer(frame, stack_pointer);\n                     _Py_Specialize_Call(callable, next_instr, oparg + !PyStackRef_IsNull(self_or_null));\n                     stack_pointer = _PyFrame_GetStackPointer(frame);\n-                    DISPATCH_SAME_OPARG();\n+                    TRACING_SPECIALIZE_DISPATCH_SAME_OPARG()\n                 }\n                 OPCODE_DEFERRED_INC(CALL);\n                 ADVANCE_ADAPTIVE_COUNTER(this_instr[1].counter);\n@@ -3228,7 +3228,7 @@\n                     _PyFrame_SetStackPointer(frame, stack_pointer);\n                     _Py_Specialize_CallKw(callable, next_instr, oparg + !PyStackRef_IsNull(self_or_null));\n                     stack_pointer = _PyFrame_GetStackPointer(frame);\n-                    DISPATCH_SAME_OPARG();\n+                    TRACING_SPECIALIZE_DISPATCH_SAME_OPARG()\n                 }\n                 OPCODE_DEFERRED_INC(CALL_KW);\n                 ADVANCE_ADAPTIVE_COUNTER(this_instr[1].counter);\n@@ -5265,7 +5265,7 @@\n                     _PyFrame_SetStackPointer(frame, stack_pointer);\n                     _Py_Specialize_CompareOp(left, right, next_instr, oparg);\n                     stack_pointer = _PyFrame_GetStackPointer(frame);\n-                    DISPATCH_SAME_OPARG();\n+                    TRACING_SPECIALIZE_DISPATCH_SAME_OPARG()\n                 }\n                 OPCODE_DEFERRED_INC(COMPARE_OP);\n                 ADVANCE_ADAPTIVE_COUNTER(this_instr[1].counter);\n@@ -5550,7 +5550,7 @@\n                     _PyFrame_SetStackPointer(frame, stack_pointer);\n                     _Py_Specialize_ContainsOp(right, next_instr);\n                     stack_pointer = _PyFrame_GetStackPointer(frame);\n-                    DISPATCH_SAME_OPARG();\n+                    TRACING_SPECIALIZE_DISPATCH_SAME_OPARG()\n                 }\n                 OPCODE_DEFERRED_INC(CONTAINS_OP);\n                 ADVANCE_ADAPTIVE_COUNTER(this_instr[1].counter);\n@@ -6531,7 +6531,7 @@\n                     _PyFrame_SetStackPointer(frame, stack_pointer);\n                     _Py_Specialize_ForIter(iter, null_or_index, next_instr, oparg);\n                     stack_pointer = _PyFrame_GetStackPointer(frame);\n-                    DISPATCH_SAME_OPARG();\n+                    TRACING_SPECIALIZE_DISPATCH_SAME_OPARG()\n                 }\n                 OPCODE_DEFERRED_INC(FOR_ITER);\n                 ADVANCE_ADAPTIVE_COUNTER(this_instr[1].counter);\n@@ -8882,7 +8882,7 @@\n                     uint8_t desired = tstate->interp->jit ? JUMP_BACKWARD_JIT : JUMP_BACKWARD_NO_JIT;\n                     FT_ATOMIC_STORE_UINT8_RELAXED(this_instr->op.code, desired);\n                     next_instr = this_instr;\n-                    DISPATCH_SAME_OPARG();\n+                    DISPATCH_SAME_OPARG()\n                 }\n                 #endif\n             }\n@@ -9190,7 +9190,7 @@\n                     _PyFrame_SetStackPointer(frame, stack_pointer);\n                     _Py_Specialize_LoadAttr(owner, next_instr, name);\n                     stack_pointer = _PyFrame_GetStackPointer(frame);\n-                    DISPATCH_SAME_OPARG();\n+                    TRACING_SPECIALIZE_DISPATCH_SAME_OPARG()\n                 }\n                 OPCODE_DEFERRED_INC(LOAD_ATTR);\n                 ADVANCE_ADAPTIVE_COUNTER(this_instr[1].counter);\n@@ -10779,7 +10779,7 @@\n                     _PyFrame_SetStackPointer(frame, stack_pointer);\n                     _Py_Specialize_LoadGlobal(GLOBALS(), BUILTINS(), next_instr, name);\n                     stack_pointer = _PyFrame_GetStackPointer(frame);\n-                    DISPATCH_SAME_OPARG();\n+                    TRACING_SPECIALIZE_DISPATCH_SAME_OPARG()\n                 }\n                 OPCODE_DEFERRED_INC(LOAD_GLOBAL);\n                 ADVANCE_ADAPTIVE_COUNTER(this_instr[1].counter);\n@@ -11177,7 +11177,7 @@\n                     _PyFrame_SetStackPointer(frame, stack_pointer);\n                     _Py_Specialize_LoadSuperAttr(global_super_st, class_st, next_instr, load_method);\n                     stack_pointer = _PyFrame_GetStackPointer(frame);\n-                    DISPATCH_SAME_OPARG();\n+                    TRACING_SPECIALIZE_DISPATCH_SAME_OPARG()\n                 }\n                 OPCODE_DEFERRED_INC(LOAD_SUPER_ATTR);\n                 ADVANCE_ADAPTIVE_COUNTER(this_instr[1].counter);\n@@ -12486,7 +12486,7 @@\n                     _PyFrame_SetStackPointer(frame, stack_pointer);\n                     _Py_Specialize_Send(receiver, next_instr);\n                     stack_pointer = _PyFrame_GetStackPointer(frame);\n-                    DISPATCH_SAME_OPARG();\n+                    TRACING_SPECIALIZE_DISPATCH_SAME_OPARG()\n                 }\n                 OPCODE_DEFERRED_INC(SEND);\n                 ADVANCE_ADAPTIVE_COUNTER(this_instr[1].counter);\n@@ -12854,7 +12854,7 @@\n                     _PyFrame_SetStackPointer(frame, stack_pointer);\n                     _Py_Specialize_StoreAttr(owner, next_instr, name);\n                     stack_pointer = _PyFrame_GetStackPointer(frame);\n-                    DISPATCH_SAME_OPARG();\n+                    TRACING_SPECIALIZE_DISPATCH_SAME_OPARG()\n                 }\n                 OPCODE_DEFERRED_INC(STORE_ATTR);\n                 ADVANCE_ADAPTIVE_COUNTER(this_instr[1].counter);\n@@ -13475,7 +13475,7 @@\n                     _PyFrame_SetStackPointer(frame, stack_pointer);\n                     _Py_Specialize_StoreSubscr(container, sub, next_instr);\n                     stack_pointer = _PyFrame_GetStackPointer(frame);\n-                    DISPATCH_SAME_OPARG();\n+                    TRACING_SPECIALIZE_DISPATCH_SAME_OPARG()\n                 }\n                 OPCODE_DEFERRED_INC(STORE_SUBSCR);\n                 ADVANCE_ADAPTIVE_COUNTER(this_instr[1].counter);\n@@ -13726,7 +13726,7 @@\n                     _PyFrame_SetStackPointer(frame, stack_pointer);\n                     _Py_Specialize_ToBool(value, next_instr);\n                     stack_pointer = _PyFrame_GetStackPointer(frame);\n-                    DISPATCH_SAME_OPARG();\n+                    TRACING_SPECIALIZE_DISPATCH_SAME_OPARG()\n                 }\n                 OPCODE_DEFERRED_INC(TO_BOOL);\n                 ADVANCE_ADAPTIVE_COUNTER(this_instr[1].counter);\n@@ -14224,7 +14224,7 @@\n                     _PyFrame_SetStackPointer(frame, stack_pointer);\n                     _Py_Specialize_UnpackSequence(seq, next_instr, oparg);\n                     stack_pointer = _PyFrame_GetStackPointer(frame);\n-                    DISPATCH_SAME_OPARG();\n+                    TRACING_SPECIALIZE_DISPATCH_SAME_OPARG()\n                 }\n                 OPCODE_DEFERRED_INC(UNPACK_SEQUENCE);\n                 ADVANCE_ADAPTIVE_COUNTER(this_instr[1].counter);\n"
        },
        {
            "commit": "6045a677ac736652e43bacb313f2fa2ab56c7cda",
            "file_path": "Python/optimizer.c",
            "diff": "diff --git a/Python/optimizer.c b/Python/optimizer.c\nindex 2fcf6b76..ca9967e4 100644\n--- a/Python/optimizer.c\n+++ b/Python/optimizer.c\n@@ -904,9 +904,10 @@ _PyJIT_InitializeTracing(PyThreadState *tstate, _PyInterpreterFrame *frame, _Py_\n     tstate->interp->jit_state.jit_tracer_previous_exit = exit;\n     _Py_BloomFilter_Init(&tstate->interp->jit_state.jit_tracer_dependencies);\n     tstate->interp->jit_state.jit_tracer_initial_stack_depth = curr_stackdepth;\n-    tstate->interp->jit_state.jit_tracer_initial_chain_depth = chain_depth;\n+    tstate->interp->jit_state.jit_tracer_initial_chain_depth = chain_depth % MAX_CHAIN_DEPTH;\n     tstate->interp->jit_state.jit_tracer_current_frame = frame;\n     tstate->interp->jit_state.jit_tracer_dependencies_still_valid = true;\n+    tstate->interp->jit_state.last_specialized_instr = NULL;\n }\n \n void\n"
        },
        {
            "commit": "6045a677ac736652e43bacb313f2fa2ab56c7cda",
            "file_path": "Tools/cases_generator/tracer_generator.py",
            "diff": "diff --git a/Tools/cases_generator/tracer_generator.py b/Tools/cases_generator/tracer_generator.py\nindex 30a34a91..7039079d 100644\n--- a/Tools/cases_generator/tracer_generator.py\n+++ b/Tools/cases_generator/tracer_generator.py\n@@ -44,6 +44,7 @@ def __init__(self, out: CWriter, labels: dict[str, Label], cannot_escape: bool =\n             **self._replacers,\n             \"DISPATCH\": self.dispatch,\n             \"DISPATCH_INLINED\": self.dispatch_inlined,\n+            \"DISPATCH_SAME_OPARG\": self.dispatch_same_oparg,\n         }\n \n     def dispatch(\n@@ -75,6 +76,26 @@ def dispatch_inlined(\n         self.out.start_line()\n         self.emit(\"TRACING_DISPATCH_INLINED\")\n         return False\n+\n+    def dispatch_same_oparg(\n+        self,\n+        tkn: Token,\n+        tkn_iter: TokenIterator,\n+        uop: CodeSection,\n+        storage: Storage,\n+        inst: Instruction | None,\n+    ) -> bool:\n+        if storage.spilled:\n+            raise analysis_error(\"stack_pointer needs reloading before dispatch\", tkn)\n+        storage.stack.flush(self.out)\n+        self.out.start_line()\n+        if \"specializing\" in uop.annotations:\n+            self.emit(\"TRACING_SPECIALIZE_DISPATCH_SAME_OPARG\")\n+        else:\n+            self.emit(tkn)\n+        emit_to(self.out, tkn_iter, \"SEMI\")\n+        return False\n+\n     def record_jump_taken(\n         self,\n         tkn: Token,\n"
        }
    ]
}