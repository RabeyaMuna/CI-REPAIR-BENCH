{
    "sha_fail": "e36b14dc3ee04beb3f0d8c2b89252eb864ea5c1a",
    "changed_files": [
        {
            "commit": "e36b14dc3ee04beb3f0d8c2b89252eb864ea5c1a",
            "file_path": "libs/agno/tests/integration/knowledge/test_md_knowledge_base.py",
            "diff": "diff --git a/libs/agno/tests/integration/knowledge/test_md_knowledge_base.py b/libs/agno/tests/integration/knowledge/test_md_knowledge_base.py\nnew file mode 100644\nindex 000000000..54b2b82a3\n--- /dev/null\n+++ b/libs/agno/tests/integration/knowledge/test_md_knowledge_base.py\n@@ -0,0 +1,240 @@\n+import os\n+from pathlib import Path\n+\n+import pytest\n+\n+from agno.agent import Agent\n+from agno.knowledge.markdown import MarkdownKnowledgeBase\n+from agno.vectordb.lancedb import LanceDb\n+\n+\n+@pytest.fixture\n+def setup_vector_db():\n+    \"\"\"Setup a temporary vector DB for testing.\"\"\"\n+    table_name = f\"md_test_{os.urandom(4).hex()}\"\n+    vector_db = LanceDb(table_name=table_name, uri=\"tmp/lancedb\")\n+    yield vector_db\n+    # Clean up after test\n+    vector_db.drop()\n+\n+\n+def get_test_data_dir():\n+    \"\"\"Get the path to the test data directory.\"\"\"\n+    return Path(__file__).parent / \"data\"\n+\n+\n+def get_filtered_data_dir():\n+    \"\"\"Get the path to the filtered test data directory.\"\"\"\n+    return Path(__file__).parent / \"data\" / \"filters\"\n+\n+\n+def prepare_knowledge_base(setup_vector_db):\n+    \"\"\"Prepare a knowledge base with filtered data.\"\"\"\n+    # Create knowledge base\n+    kb = MarkdownKnowledgeBase(vector_db=setup_vector_db)\n+\n+    # Load documents with different user IDs and metadata\n+    kb.load_document(\n+        path=get_filtered_data_dir() / \"cv_1.md\",\n+        metadata={\"user_id\": \"jordan_mitchell\", \"document_type\": \"cv\", \"experience_level\": \"entry\"},\n+        recreate=True,\n+    )\n+\n+    kb.load_document(\n+        path=get_filtered_data_dir() / \"cv_2.md\",\n+        metadata={\"user_id\": \"taylor_brooks\", \"document_type\": \"cv\", \"experience_level\": \"mid\"},\n+    )\n+\n+    return kb\n+\n+\n+async def aprepare_knowledge_base(setup_vector_db):\n+    \"\"\"Prepare a knowledge base with filtered data asynchronously.\"\"\"\n+    # Create knowledge base\n+    kb = MarkdownKnowledgeBase(vector_db=setup_vector_db)\n+\n+    # Load documents with different user IDs and metadata\n+    await kb.aload_document(\n+        path=get_filtered_data_dir() / \"cv_1.md\",\n+        metadata={\"user_id\": \"jordan_mitchell\", \"document_type\": \"cv\", \"experience_level\": \"entry\"},\n+        recreate=True,\n+    )\n+\n+    await kb.aload_document(\n+        path=get_filtered_data_dir() / \"cv_2.md\",\n+        metadata={\"user_id\": \"taylor_brooks\", \"document_type\": \"cv\", \"experience_level\": \"mid\"},\n+    )\n+\n+    return kb\n+\n+\n+def test_text_knowledge_base_directory(setup_vector_db):\n+    \"\"\"Test loading a directory of text files into the knowledge base.\"\"\"\n+    text_dir = get_test_data_dir()\n+\n+    kb = MarkdownKnowledgeBase(path=text_dir, formats=[\".md\"], vector_db=setup_vector_db)\n+    kb.load(recreate=True)\n+\n+    # Asserting the vector DB exists and pg_essay.md was split as expected\n+    assert setup_vector_db.exists()\n+    assert setup_vector_db.get_count() == 6\n+\n+    agent = Agent(knowledge=kb)\n+    response = agent.run(\"What are the key factors in doing great work?\", markdown=True)\n+\n+    tool_calls = []\n+    for msg in response.messages:  # type: ignore\n+        if msg.tool_calls:\n+            tool_calls.extend(msg.tool_calls)\n+\n+    function_calls = [call for call in tool_calls if call.get(\"type\") == \"function\"]\n+    assert any(call[\"function\"][\"name\"] == \"search_knowledge_base\" for call in function_calls)\n+\n+\n+@pytest.mark.asyncio\n+async def test_text_knowledge_base_async_directory(setup_vector_db):\n+    \"\"\"Test asynchronously loading a directory of text files into the knowledge base.\"\"\"\n+    text_dir = get_test_data_dir()\n+\n+    kb = MarkdownKnowledgeBase(path=text_dir, formats=[\".md\"], vector_db=setup_vector_db)\n+    await kb.aload(recreate=True)\n+\n+    # Asserting the vector DB exists and pg_essay.md was split as expected\n+    assert setup_vector_db.exists()\n+    assert setup_vector_db.get_count() == 5\n+\n+    agent = Agent(knowledge=kb)\n+    response = await agent.arun(\"What does Paul Graham say about great work?\", markdown=True)\n+\n+    tool_calls = []\n+    for msg in response.messages:\n+        if msg.tool_calls:\n+            tool_calls.extend(msg.tool_calls)\n+\n+    function_calls = [call for call in tool_calls if call.get(\"type\") == \"function\"]\n+    assert any(call[\"function\"][\"name\"] == \"asearch_knowledge_base\" for call in function_calls)\n+\n+\n+def test_text_knowledge_base_with_metadata_path(setup_vector_db):\n+    \"\"\"Test loading text files with metadata using the new path structure.\"\"\"\n+    kb = MarkdownKnowledgeBase(\n+        path=[\n+            {\n+                \"path\": str(get_filtered_data_dir() / \"cv_1.md\"),\n+                \"metadata\": {\"user_id\": \"jordan_mitchell\", \"document_type\": \"cv\", \"experience_level\": \"entry\"},\n+            },\n+            {\n+                \"path\": str(get_filtered_data_dir() / \"cv_2.md\"),\n+                \"metadata\": {\"user_id\": \"taylor_brooks\", \"document_type\": \"cv\", \"experience_level\": \"mid\"},\n+            },\n+        ],\n+        vector_db=setup_vector_db,\n+    )\n+\n+    kb.load(recreate=True)\n+\n+    # Verify documents were loaded with metadata\n+    agent = Agent(knowledge=kb)\n+    response = agent.run(\n+        \"Tell me about Jordan Mitchell's experience?\", knowledge_filters={\"user_id\": \"jordan_mitchell\"}, markdown=True\n+    )\n+\n+    assert (\n+        \"entry\" in response.content.lower()  # type: ignore\n+        or \"junior\" in response.content.lower()  # type: ignore\n+        or \"Jordan\" in response.content.lower()  # type: ignore\n+    )\n+    assert \"senior developer\" not in response.content.lower()  # type: ignore\n+\n+\n+def test_knowledge_base_with_metadata_path_invalid_filter(setup_vector_db):\n+    \"\"\"Test filtering docx knowledge base with invalid filters using the new path structure.\"\"\"\n+    kb = MarkdownKnowledgeBase(\n+        path=[\n+            {\n+                \"path\": str(get_filtered_data_dir() / \"cv_1.md\"),\n+                \"metadata\": {\"user_id\": \"jordan_mitchell\", \"document_type\": \"cv\", \"experience_level\": \"entry\"},\n+            },\n+            {\n+                \"path\": str(get_filtered_data_dir() / \"cv_2.md\"),\n+                \"metadata\": {\"user_id\": \"taylor_brooks\", \"document_type\": \"cv\", \"experience_level\": \"mid\"},\n+            },\n+        ],\n+        vector_db=setup_vector_db,\n+    )\n+\n+    kb.load(recreate=True)\n+\n+    # Initialize agent with invalid filters\n+    agent = Agent(knowledge=kb, knowledge_filters={\"nonexistent_filter\": \"value\"})\n+\n+    response = agent.run(\"Tell me about the candidate's experience?\", markdown=True)\n+    response_content = response.content.lower()  # type: ignore\n+\n+    assert len(response_content) > 50\n+\n+    # Check the tool calls to verify the invalid filter was not used\n+    tool_calls = []\n+    for msg in response.messages:  # type: ignore\n+        if msg.tool_calls:\n+            tool_calls.extend(msg.tool_calls)\n+\n+    function_calls = [\n+        call\n+        for call in tool_calls\n+        if call.get(\"type\") == \"function\" and call[\"function\"][\"name\"] == \"search_knowledge_base\"\n+    ]\n+\n+    found_invalid_filters = False\n+    for call in function_calls:\n+        call_args = call[\"function\"].get(\"arguments\", \"{}\")\n+        if \"nonexistent_filter\" in call_args:\n+            found_invalid_filters = True\n+\n+    assert not found_invalid_filters\n+\n+\n+def test_knowledge_base_with_valid_filter(setup_vector_db):\n+    \"\"\"Test filtering knowledge base with valid filters.\"\"\"\n+    kb = prepare_knowledge_base(setup_vector_db)\n+\n+    # Initialize agent with filters for Jordan Mitchell\n+    agent = Agent(knowledge=kb, knowledge_filters={\"user_id\": \"jordan_mitchell\"})\n+\n+    # Run a query that should only return results from Jordan Mitchell's CV\n+    response = agent.run(\"Tell me about the Jordan Mitchell's experience?\", markdown=True)\n+\n+    # Check response content to verify filtering worked\n+    response_content = response.content\n+\n+    # Jordan Mitchell's CV should mention \"software engineering intern\"\n+    assert (\n+        \"entry-level\" in response_content.lower()  # type: ignore\n+        or \"junior\" in response_content.lower()  # type: ignore\n+        or \"jordan mitchell\" in response_content.lower()  # type: ignore\n+    )\n+\n+    # Should not mention Taylor Brooks' experience as \"senior developer\"\n+    assert \"senior developer\" not in response_content.lower()  # type: ignore\n+\n+\n+def test_knowledge_base_with_run_level_filter(setup_vector_db):\n+    \"\"\"Test filtering knowledge base with filters passed at run time.\"\"\"\n+    kb = prepare_knowledge_base(setup_vector_db)\n+\n+    # Initialize agent without filters\n+    agent = Agent(knowledge=kb)\n+\n+    # Run a query with filters provided at run time\n+    response = agent.run(\n+        \"Tell me about Jordan Mitchell experience?\", knowledge_filters={\"user_id\": \"jordan_mitchell\"}, markdown=True\n+    )\n+\n+    # Check response content to verify filtering worked\n+    response_content = response.content.lower()  # type: ignore\n+\n+    # Check that we have a response with actual content\n+    assert len(response_content) > 50\n+\n+    # Should not mention Jordan Mitchell's experience\n+    assert any(term in response_content for term in [\"jordan mitchell\", \"entry-level\", \"junior\"])  # type: ignore\n"
        }
    ]
}