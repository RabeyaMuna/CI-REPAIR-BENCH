{
    "sha_fail": "9ebc254bb14ed052a0ac459d8c109ae8e0c12233",
    "changed_files": [
        {
            "commit": "9ebc254bb14ed052a0ac459d8c109ae8e0c12233",
            "file_path": "cookbook/apps/playground/user_control_flows.py",
            "diff": "diff --git a/cookbook/apps/playground/user_control_flows.py b/cookbook/apps/playground/user_control_flows.py\nnew file mode 100644\nindex 000000000..9a9030961\n--- /dev/null\n+++ b/cookbook/apps/playground/user_control_flows.py\n@@ -0,0 +1,181 @@\n+\"\"\"\ud83e\udd1d Human-in-the-Loop: Allowing users to provide input externally\n+\n+This example shows how to use the UserControlFlowTools to allow the agent to get user input dynamically.\n+If the agent doesn't have enough information to complete a task, it will use the toolkit to get the information it needs from the user.\n+\"\"\"\n+\n+import json\n+\n+import httpx\n+from agno.agent import Agent\n+from agno.models.openai import OpenAIChat\n+from agno.playground import Playground\n+from agno.storage.postgres import PostgresStorage\n+from agno.tools import tool\n+from agno.tools.toolkit import Toolkit\n+from agno.tools.user_control_flow import UserControlFlowTools\n+from agno.tools.wikipedia import WikipediaTools\n+from agno.tools.yfinance import YFinanceTools\n+\n+db_url = \"postgresql+psycopg://ai:ai@localhost:5532/ai\"\n+\n+\n+@tool(requires_confirmation=True)\n+def get_top_hackernews_stories(num_stories: int) -> str:\n+    \"\"\"Fetch top stories from Hacker News.\n+\n+    Args:\n+        num_stories (int): Number of stories to retrieve\n+\n+    Returns:\n+        str: JSON string containing story details\n+    \"\"\"\n+    # Fetch top story IDs\n+    response = httpx.get(\"https://hacker-news.firebaseio.com/v0/topstories.json\")\n+    story_ids = response.json()\n+\n+    # Yield story details\n+    all_stories = []\n+    for story_id in story_ids[:num_stories]:\n+        story_response = httpx.get(\n+            f\"https://hacker-news.firebaseio.com/v0/item/{story_id}.json\"\n+        )\n+        story = story_response.json()\n+        if \"text\" in story:\n+            story.pop(\"text\", None)\n+        all_stories.append(story)\n+    return json.dumps(all_stories)\n+\n+\n+@tool(requires_user_input=True, user_input_fields=[\"to_address\"])\n+def send_email(subject: str, body: str, to_address: str) -> str:\n+    \"\"\"\n+    Send an email.\n+\n+    Args:\n+        subject (str): The subject of the email.\n+        body (str): The body of the email.\n+        to_address (str): The address to send the email to.\n+    \"\"\"\n+    return f\"Sent email to {to_address} with subject {subject} and body {body}\"\n+\n+\n+class EmailTools(Toolkit):\n+    def __init__(self, *args, **kwargs):\n+        super().__init__(\n+            name=\"EmailTools\", tools=[self.send_email, self.get_emails], *args, **kwargs\n+        )\n+\n+    def send_email(self, subject: str, body: str, to_address: str) -> str:\n+        \"\"\"Send an email to the given address with the given subject and body.\n+\n+        Args:\n+            subject (str): The subject of the email.\n+            body (str): The body of the email.\n+            to_address (str): The address to send the email to.\n+        \"\"\"\n+        return f\"Sent email to {to_address} with subject {subject} and body {body}\"\n+\n+    def get_emails(self, date_from: str, date_to: str) -> str:\n+        \"\"\"Get all emails between the given dates.\n+\n+        Args:\n+            date_from (str): The start date (in YYYY-MM-DD format).\n+            date_to (str): The end date (in YYYY-MM-DD format).\n+        \"\"\"\n+        return [\n+            {\n+                \"subject\": \"Hello\",\n+                \"body\": \"Hello, world!\",\n+                \"to_address\": \"test@test.com\",\n+                \"date\": date_from,\n+            },\n+            {\n+                \"subject\": \"Random other email\",\n+                \"body\": \"This is a random other email\",\n+                \"to_address\": \"john@doe.com\",\n+                \"date\": date_to,\n+            },\n+        ]\n+\n+\n+double_confirmation_agent = Agent(\n+    agent_id=\"double-confirmation-agent\",\n+    model=OpenAIChat(id=\"gpt-4o-mini\"),\n+    tools=[\n+        get_top_hackernews_stories,\n+        WikipediaTools(requires_confirmation_tools=[\"search_wikipedia\"]),\n+    ],\n+    markdown=True,\n+    storage=PostgresStorage(\n+        table_name=\"hitl_sessions\", db_url=db_url, auto_upgrade_schema=True\n+    ),\n+)\n+user_input_required_agent = Agent(\n+    agent_id=\"user-input-required-agent\",\n+    model=OpenAIChat(id=\"gpt-4o-mini\"),\n+    tools=[send_email],\n+    markdown=True,\n+    storage=PostgresStorage(\n+        table_name=\"hitl_sessions\", db_url=db_url, auto_upgrade_schema=True\n+    ),\n+)\n+agentic_user_input_agent = Agent(\n+    model=OpenAIChat(id=\"gpt-4o-mini\"),\n+    agent_id=\"agentic-user-input-agent\",\n+    tools=[EmailTools(), UserControlFlowTools()],\n+    markdown=True,\n+    storage=PostgresStorage(\n+        table_name=\"hitl_sessions\", db_url=db_url, auto_upgrade_schema=True\n+    ),\n+)\n+\n+confirmation_required_agent = Agent(\n+    model=OpenAIChat(id=\"gpt-4o-mini\"),\n+    agent_id=\"confirmation-required-agent\",\n+    tools=[\n+        get_top_hackernews_stories,\n+        YFinanceTools(requires_confirmation_tools=[\"get_current_stock_price\"]),\n+    ],\n+    markdown=True,\n+    storage=PostgresStorage(\n+        table_name=\"hitl_sessions\", db_url=db_url, auto_upgrade_schema=True\n+    ),\n+)\n+combined_agent = Agent(\n+    model=OpenAIChat(id=\"gpt-4o-mini\"),\n+    agent_id=\"combined-agent\",\n+    tools=[\n+        EmailTools(),\n+        UserControlFlowTools(),\n+        send_email,\n+        get_top_hackernews_stories,\n+    ],\n+    markdown=True,\n+    storage=PostgresStorage(\n+        table_name=\"hitl_sessions\", db_url=db_url, auto_upgrade_schema=True\n+    ),\n+)\n+\n+playground = Playground(\n+    agents=[\n+        agentic_user_input_agent,\n+        confirmation_required_agent,\n+        user_input_required_agent,\n+        combined_agent,\n+        double_confirmation_agent,\n+    ],\n+    app_id=\"hitl-playground-app\",\n+    name=\"HITL Playground\",\n+    description=\"A playground for HITL\",\n+)\n+\n+app = playground.get_app()\n+\n+if __name__ == \"__main__\":\n+    playground.serve(app=\"user_control_flows:app\", reload=True)\n+\n+\n+# Send an email with the body 'What is the weather in Tokyo?\n+# Fetch the top 2 hackernews stories.\n+# Send an email with the subject 'Hello' and the body 'Hello, world!\n"
        },
        {
            "commit": "9ebc254bb14ed052a0ac459d8c109ae8e0c12233",
            "file_path": "libs/agno/agno/agent/agent.py",
            "diff": "diff --git a/libs/agno/agno/agent/agent.py b/libs/agno/agno/agent/agent.py\nindex 49a523191..d0b133e9d 100644\n--- a/libs/agno/agno/agent/agent.py\n+++ b/libs/agno/agno/agent/agent.py\n@@ -2626,7 +2626,7 @@ class Agent:\n                 else:\n                     self._reject_tool_call(run_messages, _t)\n                     _t.confirmed = False\n-                    _t.confirmation_note = \"Tool call was rejected\"\n+                    _t.confirmation_note = _t.confirmation_note or \"Tool call was rejected\"\n                     _t.tool_call_error = True\n                 _t.requires_confirmation = False\n \n@@ -2664,7 +2664,7 @@ class Agent:\n                 else:\n                     self._reject_tool_call(run_messages, _t)\n                     _t.confirmed = False\n-                    _t.confirmation_note = \"Tool call was rejected\"\n+                    _t.confirmation_note = _t.confirmation_note or \"Tool call was rejected\"\n                     _t.tool_call_error = True\n                 _t.requires_confirmation = False\n \n@@ -2701,7 +2701,7 @@ class Agent:\n                 else:\n                     self._reject_tool_call(run_messages, _t)\n                     _t.confirmed = False\n-                    _t.confirmation_note = \"Tool call was rejected\"\n+                    _t.confirmation_note = _t.confirmation_note or \"Tool call was rejected\"\n                     _t.tool_call_error = True\n                 _t.requires_confirmation = False\n \n@@ -2739,7 +2739,7 @@ class Agent:\n                 else:\n                     self._reject_tool_call(run_messages, _t)\n                     _t.confirmed = False\n-                    _t.confirmation_note = \"Tool call was rejected\"\n+                    _t.confirmation_note = _t.confirmation_note or \"Tool call was rejected\"\n                     _t.tool_call_error = True\n                 _t.requires_confirmation = False\n \n"
        }
    ]
}