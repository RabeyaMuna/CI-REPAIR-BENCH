{
    "sha_fail": "eb287cf79c1800a32bf499d4f2e9e579bfa8386c",
    "changed_files": [
        {
            "commit": "eb287cf79c1800a32bf499d4f2e9e579bfa8386c",
            "file_path": "src/open_clip/factory.py",
            "diff": "diff --git a/src/open_clip/factory.py b/src/open_clip/factory.py\nindex 971354b..7971551 100644\n--- a/src/open_clip/factory.py\n+++ b/src/open_clip/factory.py\n@@ -499,11 +499,16 @@ def create_model(\n     # Instantiate the model\n     logging.info(f\"Instantiating model architecture: {model_class.__name__}\")\n     model = model_class(**final_model_cfg, cast_dtype=cast_dtype)\n-    _set_model_device_and_precision(model, device, precision, is_timm_model)\n+\n+    # The model could be in the meta device if \n+    model_is_in_meta_device = next(model.parameters()).device.type != \"meta\"\n+\n+    if not model_is_in_meta_device:\n+        _set_model_device_and_precision(model, device, precision, is_timm_model)\n \n     # Load Full Pretrained CLIP Weights (if path exists)\n     pretrained_loaded = False\n-    if checkpoint_path:\n+    if checkpoint_path and not model_is_in_meta_device:\n         logging.info(f'Loading full pretrained weights from: {checkpoint_path}')\n         # Use the load_checkpoint helper which handles state dict loading, conversions, etc.\n         # Use strict=True by default for full model loading to catch mismatches.\n@@ -518,7 +523,7 @@ def create_model(\n \n     # Load tower-specific weights (image and text), after the full CLIP checkpoint, potentially overwriting parts.\n     pretrained_image_loaded = False # Track if specific image weights loaded\n-    if pretrained_image_path:\n+    if pretrained_image_path and not model_is_in_meta_device:\n         if os.path.isfile(pretrained_image_path):\n             logging.info(f\"Attempting to load image tower weights from: {pretrained_image_path}\")\n             try:\n@@ -547,7 +552,7 @@ def create_model(\n             logging.warning(f\"Invalid file path specified for pretrained_image_path: {pretrained_image_path}\")\n \n     pretrained_text_loaded = False # Track if specific text weights loaded\n-    if pretrained_text_path:\n+    if pretrained_text_path and not model_is_in_meta_device:\n         if os.path.isfile(pretrained_text_path):\n             logging.info(f\"Attempting to load text tower weights from: {pretrained_text_path}\")\n             try:\n@@ -585,6 +590,8 @@ def create_model(\n     elif not pretrained_loaded and partially_loaded:\n          # Some tower weights loaded\n          logging.warning(f\"Model {model_name} initialized partially.\")\n+    elif model_is_in_meta_device:\n+        logging.info(\"The model is in the 'meta' device and thus it was not initialized.\")\n     elif not pretrained_loaded and not partially_loaded:\n          # Absolutely no weights were loaded from any source\n          logging.warning(f\"No pretrained weights loaded for model '{model_name}'. Model initialized randomly.\")\n"
        }
    ]
}