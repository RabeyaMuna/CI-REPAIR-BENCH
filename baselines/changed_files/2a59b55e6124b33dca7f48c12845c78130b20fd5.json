{
    "sha_fail": "2a59b55e6124b33dca7f48c12845c78130b20fd5",
    "changed_files": [
        {
            "commit": "2a59b55e6124b33dca7f48c12845c78130b20fd5",
            "file_path": "import_export/admin.py",
            "diff": "diff --git a/import_export/admin.py b/import_export/admin.py\nindex 6e1f1c0..a1b288e 100644\n--- a/import_export/admin.py\n+++ b/import_export/admin.py\n@@ -1,6 +1,5 @@\n import logging\n import warnings\n-from contextlib import contextmanager\n \n import django\n from django import forms\n@@ -70,24 +69,6 @@ class ImportExportMixinBase:\n         return super().changelist_view(request, extra_context)\n \n \n-class FakePaginator:\n-    count = 0\n-\n-\n-def _get_paginator(request, queryset, per_page):\n-    return FakePaginator()\n-\n-\n-@contextmanager\n-def temp_attr(obj, attr_name, new_value):\n-    original_value = getattr(obj, attr_name)\n-    setattr(obj, attr_name, new_value)\n-    try:\n-        yield\n-    finally:\n-        setattr(obj, attr_name, original_value)\n-\n-\n class ImportMixin(BaseImportMixin, ImportExportMixinBase):\n     \"\"\"\n     Import mixin.\n@@ -761,12 +742,22 @@ class ExportMixin(BaseExportMixin, ImportExportMixinBase):\n         if django.VERSION >= (4, 0):\n             changelist_kwargs[\"search_help_text\"] = self.search_help_text\n \n-        # Temporarily set to False to avoid unnecessary COUNT queries.\n-        with temp_attr(self, \"show_full_result_count\", False):\n-            # Temporarily set to FakePaginator to avoid unnecessary COUNT queries.\n-            with temp_attr(self, \"get_paginator\", _get_paginator):\n-                cl = ChangeList(**changelist_kwargs)\n+        class ExportChangeList(ChangeList):\n+            def get_results(self, request):\n+                \"\"\"\n+                We override this method because we only call ChangeList.get_queryset()\n+                so we don't need anything from this method. The get_results() gets called during\n+                ChangeList.__init__() and we do want to avoid unnecessary COUNT queries.\n+                \"\"\"\n+                pass\n+\n+        cl = ExportChangeList(**changelist_kwargs)\n+\n+        # get_queryset() is already called during initialization, it is enough to get it's results\n+        if hasattr(cl, \"queryset\"):\n+            return cl.queryset\n \n+        # Fallback in case the ChangeList doesn't have queryset attribute set\n         return cl.get_queryset(request)\n \n     def get_export_data(self, file_format, queryset, *args, **kwargs):\n"
        },
        {
            "commit": "2a59b55e6124b33dca7f48c12845c78130b20fd5",
            "file_path": "tests/core/tests/test_admin_integration.py",
            "diff": "diff --git a/tests/core/tests/test_admin_integration.py b/tests/core/tests/test_admin_integration.py\nindex e74a7d2..807c8c2 100644\n--- a/tests/core/tests/test_admin_integration.py\n+++ b/tests/core/tests/test_admin_integration.py\n@@ -11,9 +11,12 @@ import tablib\n from core.admin import AuthorAdmin, BookAdmin, CustomBookAdmin, ImportMixin\n from core.models import Author, Book, Category, EBook, Parent\n from django.contrib.admin.models import DELETION, LogEntry\n+from django.contrib.admin.sites import AdminSite\n+from django.contrib.admin.views.main import ChangeList\n from django.contrib.auth.models import User\n from django.core.exceptions import PermissionDenied\n from django.http import HttpRequest\n+from django.test import RequestFactory\n from django.test.testcases import TestCase, TransactionTestCase\n from django.test.utils import override_settings\n from django.utils.translation import gettext_lazy as _\n@@ -680,9 +683,8 @@ class ExportAdminIntegrationTest(AdminTestMixin, TestCase):\n             \"file_format\": \"0\",\n         }\n         date_str = datetime.now().strftime(\"%Y-%m-%d\")\n-        with self.assertNumQueries(\n-            7\n-        ):  # Should not contain COUNT queries from ModelAdmin.get_results()\n+        # Should not contain COUNT queries from ModelAdmin.get_results()\n+        with self.assertNumQueries(5):\n             response = self.client.post(\"/admin/core/book/export/\", data)\n         self.assertEqual(response.status_code, 200)\n         self.assertTrue(response.has_header(\"Content-Disposition\"))\n@@ -697,6 +699,72 @@ class ExportAdminIntegrationTest(AdminTestMixin, TestCase):\n             response.content,\n         )\n \n+    def test_get_export_queryset(self):\n+        model_admin = BookAdmin(Book, AdminSite())\n+\n+        factory = RequestFactory()\n+        request = factory.get(\"/admin/core/book/export/\")\n+        request.user = User.objects.create_user(\"admin1\")\n+\n+        call_number = 0\n+\n+        class MyChangeList(ChangeList):\n+            def get_queryset(self, request):\n+                nonlocal call_number\n+                call_number += 1\n+                return super().get_queryset(request)\n+\n+        model_admin.get_changelist = lambda request: MyChangeList\n+\n+        with patch.object(model_admin, \"get_paginator\") as mock_get_paginator:\n+            with self.assertNumQueries(4):\n+                queryset = model_admin.get_export_queryset(request)\n+\n+            mock_get_paginator.assert_not_called()\n+            self.assertEqual(call_number, 1)\n+\n+        self.assertEqual(queryset.count(), Book.objects.count())\n+\n+    def test_get_export_queryset_no_queryset_init(self):\n+        \"\"\"Test if user has own ChangeList which doesn't store queryset diring init\"\"\"\n+        model_admin = BookAdmin(Book, AdminSite())\n+\n+        factory = RequestFactory()\n+        request = factory.get(\"/admin/core/book/export/\")\n+        request.user = User.objects.create_user(\"admin1\")\n+\n+        call_number = 0\n+\n+        class MyChangeList(ChangeList):\n+            def __init__(self, *args, **kwargs):\n+                self.filter_params = {}\n+                self.model_admin = kwargs.pop(\"model_admin\")\n+                self.list_filter = kwargs.pop(\"list_filter\")\n+                self.model = kwargs.pop(\"model\")\n+                self.date_hierarchy = kwargs.pop(\"date_hierarchy\")\n+                self.root_queryset = self.model_admin.get_queryset(request)\n+                self.list_select_related = kwargs.pop(\"list_select_related\")\n+                self.list_display = kwargs.pop(\"list_display\")\n+                self.lookup_opts = self.model._meta\n+                self.params = {}\n+                self.query = \"\"\n+\n+            def get_queryset(self, request):\n+                nonlocal call_number\n+                call_number += 1\n+                return super().get_queryset(request)\n+\n+        model_admin.get_changelist = lambda request: MyChangeList\n+\n+        with patch.object(model_admin, \"get_paginator\") as mock_get_paginator:\n+            with self.assertNumQueries(4):\n+                queryset = model_admin.get_export_queryset(request)\n+\n+            mock_get_paginator.assert_not_called()\n+            self.assertEqual(call_number, 1)\n+\n+        self.assertEqual(queryset.count(), Book.objects.count())\n+\n     def test_export_second_resource(self):\n         response = self.client.get(\"/admin/core/book/export/\")\n         self.assertEqual(response.status_code, 200)\n"
        }
    ]
}