{
    "sha_fail": "a0593ec1c9613ae8ab78fddd30e47114ded16f00",
    "changed_files": [
        {
            "commit": "a0593ec1c9613ae8ab78fddd30e47114ded16f00",
            "file_path": "lightrag/kg/postgres_impl.py",
            "diff": "diff --git a/lightrag/kg/postgres_impl.py b/lightrag/kg/postgres_impl.py\nindex 74034877..4663aadb 100644\n--- a/lightrag/kg/postgres_impl.py\n+++ b/lightrag/kg/postgres_impl.py\n@@ -4578,50 +4578,86 @@ SQL_TEMPLATES = {\n                       update_time = EXCLUDED.update_time\n                      \"\"\",\n     \"relationships\": \"\"\"\n-        WITH relevant_chunks AS (\n-            SELECT id as chunk_id\n-            FROM LIGHTRAG_VDB_CHUNKS\n-            WHERE $2::varchar[] IS NULL OR full_doc_id = ANY($2::varchar[])\n-        )\n-        SELECT r.source_id as src_id, r.target_id as tgt_id,\n-               EXTRACT(EPOCH FROM r.create_time)::BIGINT as created_at\n-        FROM LIGHTRAG_VDB_RELATION r\n-        JOIN relevant_chunks c ON c.chunk_id = ANY(r.chunk_ids)\n-        WHERE r.workspace = $1\n-          AND r.content_vector <=> '[{embedding_string}]'::vector < $3\n-        ORDER BY r.content_vector <=> '[{embedding_string}]'::vector\n-        LIMIT $4\n-    \"\"\",\n+                     WITH relevant_chunks AS (SELECT id as chunk_id\n+                                              FROM LIGHTRAG_VDB_CHUNKS\n+                                              WHERE $2\n+                         :: varchar [] IS NULL OR full_doc_id = ANY ($2:: varchar [])\n+                         )\n+                        , rc AS (\n+                     SELECT array_agg(chunk_id) AS chunk_arr\n+                     FROM relevant_chunks\n+                         ), cand AS (\n+                     SELECT\n+                         r.id, r.source_id AS src_id, r.target_id AS tgt_id, r.chunk_ids, r.create_time, r.content_vector <=> '[{embedding_string}]'::vector AS dist\n+                     FROM LIGHTRAG_VDB_RELATION r\n+                     WHERE r.workspace = $1\n+                     ORDER BY r.content_vector <=> '[{embedding_string}]'::vector\n+                         LIMIT ($4 * 50)\n+                         )\n+                     SELECT c.src_id,\n+                            c.tgt_id,\n+                            EXTRACT(EPOCH FROM c.create_time) ::BIGINT AS created_at\n+                     FROM cand c\n+                              JOIN rc ON TRUE\n+                     WHERE c.dist < $3\n+                       AND c.chunk_ids && (rc.chunk_arr::varchar[])\n+                     ORDER BY c.dist, c.id \n+                         LIMIT $4;\n+                     \"\"\",\n     \"entities\": \"\"\"\n-        WITH relevant_chunks AS (\n-            SELECT id as chunk_id\n-            FROM LIGHTRAG_VDB_CHUNKS\n-            WHERE $2::varchar[] IS NULL OR full_doc_id = ANY($2::varchar[])\n-        )\n-        SELECT e.entity_name,\n-               EXTRACT(EPOCH FROM e.create_time)::BIGINT as created_at\n-        FROM LIGHTRAG_VDB_ENTITY e\n-        JOIN relevant_chunks c ON c.chunk_id = ANY(e.chunk_ids)\n-        WHERE e.workspace = $1\n-          AND e.content_vector <=> '[{embedding_string}]'::vector < $3\n-        ORDER BY e.content_vector <=> '[{embedding_string}]'::vector\n-        LIMIT $4\n-    \"\"\",\n+                WITH relevant_chunks AS (SELECT id as chunk_id\n+                                         FROM LIGHTRAG_VDB_CHUNKS\n+                                         WHERE $2\n+                    :: varchar [] IS NULL OR full_doc_id = ANY ($2:: varchar [])\n+                    )\n+                   , rc AS (\n+                SELECT array_agg(chunk_id) AS chunk_arr\n+                FROM relevant_chunks\n+                    ), cand AS (\n+                SELECT\n+                    e.id, e.entity_name, e.chunk_ids, e.create_time, e.content_vector <=> '[{embedding_string}]'::vector AS dist\n+                FROM LIGHTRAG_VDB_ENTITY e\n+                WHERE e.workspace = $1\n+                ORDER BY e.content_vector <=> '[{embedding_string}]'::vector\n+                    LIMIT ($4 * 50)\n+                    )\n+                SELECT c.entity_name,\n+                       EXTRACT(EPOCH FROM c.create_time) ::BIGINT AS created_at\n+                FROM cand c\n+                         JOIN rc ON TRUE\n+                WHERE c.dist < $3\n+                  AND c.chunk_ids && (rc.chunk_arr::varchar[])\n+                ORDER BY c.dist, c.id \n+                    LIMIT $4;\n+                \"\"\",\n     \"chunks\": \"\"\"\n-        WITH relevant_chunks AS (\n-            SELECT id as chunk_id\n-            FROM LIGHTRAG_VDB_CHUNKS\n-            WHERE $2::varchar[] IS NULL OR full_doc_id = ANY($2::varchar[])\n-        )\n-        SELECT id, content, file_path,\n-               EXTRACT(EPOCH FROM create_time)::BIGINT as created_at\n-        FROM LIGHTRAG_VDB_CHUNKS\n-        WHERE workspace = $1\n-          AND id IN (SELECT chunk_id FROM relevant_chunks)\n-          AND content_vector <=> '[{embedding_string}]'::vector < $3\n-        ORDER BY content_vector <=> '[{embedding_string}]'::vector\n-        LIMIT $4\n-    \"\"\",\n+              WITH relevant_chunks AS (SELECT id as chunk_id\n+                                       FROM LIGHTRAG_VDB_CHUNKS\n+                                       WHERE $2\n+                  :: varchar [] IS NULL OR full_doc_id = ANY ($2:: varchar [])\n+                  )\n+                 , rc AS (\n+              SELECT array_agg(chunk_id) AS chunk_arr\n+              FROM relevant_chunks\n+                  ), cand AS (\n+              SELECT\n+                  id, content, file_path, create_time, content_vector <=> '[{embedding_string}]'::vector AS dist\n+              FROM LIGHTRAG_VDB_CHUNKS\n+              WHERE workspace = $1\n+              ORDER BY content_vector <=> '[{embedding_string}]'::vector\n+                  LIMIT ($4 * 50)\n+                  )\n+              SELECT c.id,\n+                     c.content,\n+                     c.file_path,\n+                     EXTRACT(EPOCH FROM c.create_time) ::BIGINT AS created_at\n+              FROM cand c\n+                       JOIN rc ON TRUE\n+              WHERE c.dist < $3\n+                AND c.id = ANY (rc.chunk_arr)\n+              ORDER BY c.dist, c.id\n+                  LIMIT $4;\n+              \"\"\",\n     # DROP tables\n     \"drop_specifiy_table_workspace\": \"\"\"\n         DELETE FROM {table_name} WHERE workspace=$1\n"
        }
    ]
}