{
    "sha_fail": "5fea24b4a3fc4952e83474db5e7dc05af9ec76f6",
    "changed_files": [
        {
            "commit": "5fea24b4a3fc4952e83474db5e7dc05af9ec76f6",
            "file_path": "tests/common.py",
            "diff": "diff --git a/tests/common.py b/tests/common.py\nindex 23c9b68..7aabd55 100644\n--- a/tests/common.py\n+++ b/tests/common.py\n@@ -8,25 +8,24 @@ import json\n import os\n from typing import Any\n \n-from aiohttp import ClientWebSocketResponse\n+from aiohttp import ClientSession, ClientWebSocketResponse\n+from aiohttp.typedefs import StrOrURL\n from homeassistant import auth, config_entries, core as ha\n-from homeassistant.auth import (\n-    auth_store,\n-    models as auth_models,\n-    permissions as auth_permissions,\n-)\n+from homeassistant.auth import auth_store, models as auth_models\n from homeassistant.components.http import (\n     CONFIG_SCHEMA as HTTP_CONFIG_SCHEMA,\n     async_setup as http_async_setup,\n )\n from homeassistant.const import EVENT_HOMEASSISTANT_CLOSE\n from homeassistant.helpers import storage\n+from homeassistant.helpers.aiohttp_client import async_get_clientsession\n from homeassistant.helpers.device_registry import DeviceRegistry\n from homeassistant.helpers.entity_registry import EntityRegistry\n from homeassistant.helpers.issue_registry import IssueRegistry\n from homeassistant.setup import async_setup_component\n import homeassistant.util.dt as date_util\n from homeassistant.util.unit_system import METRIC_SYSTEM\n+from yarl import URL\n \n from custom_components.hacs.base import HacsBase\n from custom_components.hacs.repositories.base import HacsManifest, HacsRepository\n@@ -312,3 +311,57 @@ class WSClient:\n     async def send_and_receive_json(self, type: str, payload: dict[str, Any]) -> dict[str, Any]:\n         await self.send_json(type=type, payload=payload)\n         return await self.client.receive_json()\n+\n+\n+class MockedResponse:\n+    def __init__(self, **kwargs) -> None:\n+        self.status = kwargs.get(\"status\", 200)\n+        self.read = kwargs.get(\"read\", AsyncMock())\n+        self.json = kwargs.get(\"json\", AsyncMock())\n+        self.exception = kwargs.get(\"exception\", None)\n+\n+\n+class ResponseMocker:\n+    responses: dict[str, MockedResponse] = {}\n+\n+    def add(self, url: str, response: MockedResponse) -> None:\n+        self.responses[url] = response\n+\n+    def get(self, url: str) -> MockedResponse:\n+        return self.responses.pop(url, None)\n+\n+\n+async def client_session_proxy(hass: ha.HomeAssistant) -> ClientSession:\n+    \"\"\"Create a mocked client session.\"\"\"\n+    base = async_get_clientsession(hass)\n+    response_mocker = ResponseMocker()\n+\n+    async def _request(method: str, str_or_url: StrOrURL, *args, **kwargs):\n+        url = URL(str_or_url)\n+        fp = os.path.join(\n+            os.path.dirname(__file__),\n+            f\"fixtures/proxy/{url.host}{url.path}{'.json' if url.host == 'api.github.com' else ''}\",\n+        )\n+        print(f\"Using fixture {fp} for request to {url.host}\")\n+\n+        if (resp := response_mocker.get(str_or_url)) is not None:\n+            if resp.exception:\n+                raise resp.exception\n+            return resp\n+\n+        if not os.path.exists(fp):\n+            raise AssertionError(f\"Missing fixture for proxy/{url.host}{url.path}\")\n+\n+        async def read():\n+            with open(fp, encoding=\"utf-8\") as fptr:\n+                return fptr.read().encode(\"utf-8\")\n+\n+        async def json():\n+            with open(fp, encoding=\"utf-8\") as fptr:\n+                return json.loads(fptr.read())\n+\n+        return AsyncMock(status=200, url=url, read=read, json=json)\n+\n+    base._request = _request\n+\n+    return base\n"
        },
        {
            "commit": "5fea24b4a3fc4952e83474db5e7dc05af9ec76f6",
            "file_path": "tests/repositories/test_get_documentation.py",
            "diff": "diff --git a/tests/repositories/test_get_documentation.py b/tests/repositories/test_get_documentation.py\nnew file mode 100644\nindex 0000000..e289d29\n--- /dev/null\n+++ b/tests/repositories/test_get_documentation.py\n@@ -0,0 +1,25 @@\n+\n+from typing import Any\n+import pytest\n+from custom_components.hacs.base import HacsBase\n+from custom_components.hacs.repositories.base import HacsRepository\n+\n+from tests.common import client_session_proxy\n+\n+\n+\n+@pytest.mark.parametrize(\"data,result\", [\n+    ({\"installed\": True, \"installed_version\": \"1.0.0\"}, \"Example readme file\"),\n+    ({\"installed\": False, \"last_version\": \"2.0.0\"}, \"Example readme file\")\n+])\n+@pytest.mark.asyncio\n+async def test_validate_repository(hacs: HacsBase, data: dict[str, Any], result: str):\n+    repository = HacsRepository(hacs=hacs)\n+    repository.data.full_name = \"octocat/integration\"\n+    for key, value in data.items():\n+        setattr(repository.data, key, value)\n+\n+    hacs.session = await client_session_proxy(hacs.hass)\n+    docs = await repository.get_documentation(filename=\"README.md\")\n+\n+    assert result in docs\n"
        },
        {
            "commit": "5fea24b4a3fc4952e83474db5e7dc05af9ec76f6",
            "file_path": "tests/repositories/test_get_hacs_json.py",
            "diff": "diff --git a/tests/repositories/test_get_hacs_json.py b/tests/repositories/test_get_hacs_json.py\nnew file mode 100644\nindex 0000000..495f346\n--- /dev/null\n+++ b/tests/repositories/test_get_hacs_json.py\n@@ -0,0 +1,25 @@\n+\n+import pytest\n+from custom_components.hacs.base import HacsBase\n+from custom_components.hacs.repositories.base import HacsRepository\n+\n+from tests.common import client_session_proxy\n+\n+\n+\n+@pytest.mark.parametrize(\"version,name\", [\n+    (\"1.0.0\", \"Proxy integration\"),\n+    (\"99.99.99\", None)\n+])\n+@pytest.mark.asyncio\n+async def test_validate_repository(hacs: HacsBase, version: str, name: str | None):\n+    repository = HacsRepository(hacs=hacs)\n+    repository.data.full_name = \"octocat/integration\"\n+\n+    hacs.session = await client_session_proxy(hacs.hass)\n+    manifest = await repository.get_hacs_json(version=version)\n+\n+    if name:\n+        assert manifest.name == name\n+    else:\n+        assert manifest is None\n"
        }
    ]
}