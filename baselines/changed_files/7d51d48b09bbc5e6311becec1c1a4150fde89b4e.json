{
    "sha_fail": "7d51d48b09bbc5e6311becec1c1a4150fde89b4e",
    "changed_files": [
        {
            "commit": "7d51d48b09bbc5e6311becec1c1a4150fde89b4e",
            "file_path": "cookbook/tools/azure_openai_tools.py",
            "diff": "diff --git a/cookbook/tools/azure_openai_tools.py b/cookbook/tools/azure_openai_tools.py\nnew file mode 100644\nindex 000000000..54764ea01\n--- /dev/null\n+++ b/cookbook/tools/azure_openai_tools.py\n@@ -0,0 +1,183 @@\n+\"\"\"Example showing how to use Azure OpenAI Tools with Agno.\n+\n+Requirements:\n+1. Azure OpenAI service setup with DALL-E deployment and chat model deployment\n+2. Environment variables:\n+   - AZURE_OPENAI_API_KEY - Your Azure OpenAI API key\n+   - AZURE_OPENAI_ENDPOINT - The Azure OpenAI endpoint URL\n+   - AZURE_OPENAI_IMAGE_DEPLOYMENT - The deployment name for DALL-E\n+   - AZURE_OPENAI_LLM_DEPLOYMENT - The deployment name for the language model\n+   - OPENAI_API_KEY (for standard OpenAI example)\n+\n+The script will automatically run only the examples for which you have the necessary\n+environment variables set.\n+\n+Run `pip install agno` to install dependencies.\n+\"\"\"\n+\n+from pathlib import Path\n+from os import getenv\n+import sys\n+\n+from agno.agent import Agent\n+from agno.models.azure import AzureOpenAI\n+from agno.models.openai import OpenAIChat\n+from agno.tools.azure_openai import AzureOpenAITools\n+from agno.utils.media import download_image\n+\n+# Check for base requirements first - needed for all examples\n+# Exit early if base requirements aren't met\n+if not bool(\n+    getenv(\"AZURE_OPENAI_API_KEY\")\n+    and getenv(\"AZURE_OPENAI_ENDPOINT\")\n+    and getenv(\"AZURE_OPENAI_IMAGE_DEPLOYMENT\")\n+):\n+    print(\"Error: Missing base Azure OpenAI requirements.\")\n+    print(\"Required for all examples:\")\n+    print(\"- AZURE_OPENAI_API_KEY\")\n+    print(\"- AZURE_OPENAI_ENDPOINT\")\n+    print(\"- AZURE_OPENAI_IMAGE_DEPLOYMENT\")\n+    sys.exit(1)\n+\n+common_instructions = [\n+    \"You are an AI artist specializing in creating images based on user descriptions.\",\n+    \"Use the generate_image tool to create detailed visualizations of user requests.\",\n+    \"Provide creative suggestions to enhance the images if needed.\",\n+]\n+\n+# Example 1: Standard OpenAI model with Azure OpenAI Tools\n+if bool(getenv(\"OPENAI_API_KEY\")):\n+    print(\"Running Example 1: Standard OpenAI model with Azure OpenAI Tools\")\n+    print(\n+        \"This approach uses OpenAI for the agent's model but Azure for image generation.\\n\"\n+    )\n+\n+    standard_agent = Agent(\n+        model=OpenAIChat(id=\"gpt-4o\"),  # Using standard OpenAI for the agent\n+        tools=[AzureOpenAITools()],  # Using Azure OpenAI for image generation\n+        name=\"Mixed OpenAI Generator\",\n+        description=\"An AI assistant that uses standard OpenAI for chat and Azure OpenAI for image generation\",\n+        instructions=common_instructions,\n+        show_tool_calls=True,\n+    )\n+\n+    # Generate an image with the standard OpenAI model and Azure tools\n+    try:\n+        standard_agent.print_response(\n+            \"Generate an image of a futuristic city with flying cars and tall skyscrapers\",\n+            markdown=True,\n+        )\n+    except Exception as e:\n+        print(f\"Error in Example 1: {e}\")\n+else:\n+    print(\"Skipping Example 1: Missing required environment variables.\")\n+    print(\"Required: OPENAI_API_KEY\")\n+\n+if bool(getenv(\"AZURE_OPENAI_LLM_DEPLOYMENT\")):\n+    print(\"\\nRunning Example 2: Full Azure OpenAI setup\")\n+    print(\n+        \"This approach uses Azure OpenAI for both the agent's model and image generation.\\n\"\n+    )\n+\n+    # Create an AzureOpenAI model using Azure credentials\n+    azure_endpoint = getenv(\"AZURE_OPENAI_ENDPOINT\")\n+    azure_api_key = getenv(\"AZURE_OPENAI_API_KEY\")\n+    azure_deployment = getenv(\"AZURE_OPENAI_LLM_DEPLOYMENT\")\n+\n+    # Explicitly pass all parameters to make debugging easier\n+    azure_model = AzureOpenAI(\n+        azure_endpoint=azure_endpoint,\n+        azure_deployment=azure_deployment,\n+        api_key=azure_api_key,\n+        id=azure_deployment,  # Using the deployment name as the model ID\n+    )\n+\n+    # Create an agent with Azure OpenAI model and tools\n+    azure_agent = Agent(\n+        model=azure_model,  # Using Azure OpenAI for the agent\n+        tools=[AzureOpenAITools()],  # Using Azure OpenAI for image generation\n+        name=\"Full Azure OpenAI Generator\",\n+        description=\"An AI assistant that uses Azure OpenAI for both chat and image generation\",\n+        instructions=common_instructions,\n+        show_tool_calls=True,\n+    )\n+\n+    # Generate an image with the full Azure setup\n+    try:\n+        azure_agent.print_response(\n+            \"Generate an image of a serene Japanese garden with cherry blossoms\",\n+            markdown=True,\n+        )\n+    except Exception as e:\n+        print(f\"Error in Example 2: {e}\")\n+\n+    print(\"\\nRunning Example 3: Automatic parameter enforcement demo\")\n+    print(\n+        \"This example demonstrates how invalid parameters are automatically corrected.\\n\"\n+    )\n+\n+    # Print available image properties for reference\n+    print(\"Valid image properties:\")\n+    print(\"- Models: dall-e-3, dall-e-2\")\n+    print(\"- Sizes: 256x256, 512x512, 1024x1024, 1792x1024, 1024x1792\")\n+    print(\"- Styles: vivid, natural\\n\")\n+\n+    # Create AzureOpenAITools with explicit parameters\n+    azure_tools = AzureOpenAITools(\n+        api_key=getenv(\"AZURE_OPENAI_API_KEY\"),\n+        azure_endpoint=getenv(\"AZURE_OPENAI_ENDPOINT\"),\n+        dalle_deployment=getenv(\"AZURE_OPENAI_IMAGE_DEPLOYMENT\"),\n+        dalle_model=\"dall-e-3\",  # Explicitly set the model\n+    )\n+\n+    # Create custom Azure OpenAI model\n+    custom_model = AzureOpenAI(\n+        azure_endpoint=getenv(\"AZURE_OPENAI_ENDPOINT\"),\n+        azure_deployment=getenv(\"AZURE_OPENAI_LLM_DEPLOYMENT\"),\n+        api_key=getenv(\"AZURE_OPENAI_API_KEY\"),\n+        id=getenv(\"AZURE_OPENAI_LLM_DEPLOYMENT\"),\n+    )\n+\n+    custom_agent = Agent(\n+        model=custom_model,  # Using Azure OpenAI for the agent model\n+        tools=[azure_tools],\n+        name=\"Parameter Enforcement Demo\",\n+        description=\"An AI assistant demonstrating automatic parameter enforcement\",\n+        instructions=common_instructions,\n+        show_tool_calls=True,\n+    )\n+\n+    # Generate an image - we'll instruct about invalid parameters in the prompt\n+    try:\n+        prompt = \"\"\"Create a panoramic nature scene showing a peaceful mountain lake at sunset.\n+\n+For this example, try using a mix of valid and invalid parameters to demonstrate enforcement:\n+1. Use a valid size='512x512' (this will work as-is)\n+2. Try using model='dall-e-4' (invalid model that will be corrected to dall-e-3)\n+3. Try using n=3 (invalid for dall-e-3, will be corrected to n=1)\n+\n+This demonstrates how the tool intelligently handles parameters - it keeps valid ones you specify\n+while automatically correcting invalid ones to ensure the request succeeds.\n+\n+Note: The tool has built-in parameter enforcement that will automatically correct\n+any invalid parameters to valid values, so your requests will still work.\"\"\"\n+\n+        response = custom_agent.run(prompt, markdown=True)\n+\n+        # Save the generated image\n+        if response.images:\n+            output_dir = Path(__file__).parent.joinpath(\"tmp\")\n+            output_dir.mkdir(exist_ok=True)\n+            download_image(\n+                url=response.images[0].url,\n+                output_path=output_dir.joinpath(\"azure_nature.jpg\"),\n+            )\n+            print(f\"Image saved to {output_dir.joinpath('azure_nature.jpg')}\")\n+\n+            # Verify the number of images generated\n+            print(f\"Number of images generated: {len(response.images)}\")\n+    except Exception as e:\n+        print(f\"Error in Example 3: {e}\")\n+else:\n+    print(\"\\nSkipping Example 2 and 3: Missing required environment variables.\")\n+    print(\"Required: AZURE_OPENAI_LLM_DEPLOYMENT\\n\")\n"
        },
        {
            "commit": "7d51d48b09bbc5e6311becec1c1a4150fde89b4e",
            "file_path": "evals/accuracy/openai/calculator.py",
            "diff": "diff --git a/evals/accuracy/openai/calculator.py b/evals/accuracy/openai/calculator.py\nindex bf58a07cd..ed7265b30 100644\n--- a/evals/accuracy/openai/calculator.py\n+++ b/evals/accuracy/openai/calculator.py\n@@ -36,6 +36,21 @@ def factorial():\n     assert result is not None and result.avg_score >= 8\n \n \n+def which_is_bigger_911_or_99():\n+    evaluation = AccuracyEval(\n+        agent=Agent(\n+            model=OpenAIChat(id=\"gpt-4o-mini\"),\n+            tools=[CalculatorTools(enable_all=True)],\n+        ),\n+        question=\"Which is bigger 9.11 or 9.9?\",\n+        expected_answer=\"9.9\",\n+        evaluator_context=\"Its ok if the Agent returns reasoning, but the answer must be 9.9\",\n+        num_iterations=1\n+    )\n+    result: Optional[AccuracyResult] = evaluation.run(print_results=True)\n+\n+    assert result is not None and result.avg_score >= 8\n+\n+\n if __name__ == \"__main__\":\n-    multiply_and_exponentiate()\n-    # factorial()\n+    which_is_bigger_911_or_99()\n"
        },
        {
            "commit": "7d51d48b09bbc5e6311becec1c1a4150fde89b4e",
            "file_path": "libs/agno/agno/tools/azure_openai.py",
            "diff": "diff --git a/libs/agno/agno/tools/azure_openai.py b/libs/agno/agno/tools/azure_openai.py\nnew file mode 100644\nindex 000000000..f800c6424\n--- /dev/null\n+++ b/libs/agno/agno/tools/azure_openai.py\n@@ -0,0 +1,174 @@\n+from os import getenv\n+from typing import Any, Dict, Literal, Optional\n+from uuid import uuid4\n+\n+from requests import post\n+\n+from agno.agent import Agent\n+from agno.media import ImageArtifact\n+from agno.tools import Toolkit\n+from agno.utils.log import log_debug, logger\n+\n+\n+class AzureOpenAITools(Toolkit):\n+    \"\"\"Toolkit for Azure OpenAI services.\n+\n+    Currently supports:\n+    - DALL-E image generation\n+    \"\"\"\n+\n+    # Define valid parameter options as class constants\n+    VALID_MODELS = [\"dall-e-3\", \"dall-e-2\"]\n+    VALID_SIZES = [\"256x256\", \"512x512\", \"1024x1024\", \"1792x1024\", \"1024x1792\"]\n+    VALID_QUALITIES = [\"standard\", \"hd\"]\n+    VALID_STYLES = [\"vivid\", \"natural\"]\n+\n+    def __init__(\n+        self,\n+        api_key: Optional[str] = None,\n+        azure_endpoint: Optional[str] = None,\n+        api_version: Optional[str] = None,\n+        dalle_deployment: Optional[str] = None,\n+        dalle_model: str = \"dall-e-3\",\n+    ):\n+        super().__init__(name=\"azure_openai\")\n+\n+        # Set credentials from parameters or environment variables\n+        self.api_key = api_key or getenv(\"AZURE_OPENAI_API_KEY\")\n+        self.azure_endpoint = azure_endpoint or getenv(\"AZURE_OPENAI_ENDPOINT\")\n+        self.api_version = api_version or getenv(\"AZURE_OPENAI_API_VERSION\") or \"2023-12-01-preview\"\n+\n+        # Log warnings for missing credentials\n+        if not self.api_key:\n+            logger.error(\"AZURE_OPENAI_API_KEY not set\")\n+        if not self.azure_endpoint:\n+            logger.error(\"AZURE_OPENAI_ENDPOINT not set\")\n+\n+        # Initialize DALL-E parameters\n+        self.dalle_deployment = dalle_deployment or getenv(\"AZURE_OPENAI_IMAGE_DEPLOYMENT\")\n+        self.dalle_model = dalle_model\n+\n+        # Validate DALL-E parameters\n+        if self.dalle_deployment and self.dalle_model in self.VALID_MODELS:\n+            # Create and store the base URL\n+            self.dalle_base_url = f\"{self.azure_endpoint}/openai/deployments/{self.dalle_deployment}/images/generations?api-version={self.api_version}\"\n+            # Register the DALL-E tool\n+            self.register(self.generate_image)\n+            logger.info(\"DALL-E tool initialized successfully\")\n+        else:\n+            logger.error(\"Missing required DALL-E parameters or invalid model\")\n+\n+    def _enforce_valid_dalle_parameters(self, params: Dict[str, Any]) -> Dict[str, Any]:\n+        \"\"\"Enforce valid parameters by replacing invalid ones with defaults.\"\"\"\n+        enforced = params.copy()\n+\n+        # Validate size\n+        if params.get(\"size\") not in self.VALID_SIZES:\n+            enforced[\"size\"] = \"1024x1024\"\n+            log_debug(f\"Enforcing valid size: '{params.get('size')}' -> '1024x1024'\")\n+\n+        # Validate quality\n+        if params.get(\"quality\") not in self.VALID_QUALITIES:\n+            enforced[\"quality\"] = \"standard\"\n+            log_debug(f\"Enforcing valid quality: '{params.get('quality')}' -> 'standard'\")\n+\n+        # Validate style\n+        if params.get(\"style\") not in self.VALID_STYLES:\n+            enforced[\"style\"] = \"vivid\"\n+            log_debug(f\"Enforcing valid style: '{params.get('style')}' -> 'vivid'\")\n+\n+        # Validate number of images\n+        if not isinstance(params.get(\"n\"), int) or params.get(\"n\", 0) <= 0:\n+            enforced[\"n\"] = 1\n+            log_debug(f\"Enforcing valid n: '{params.get('n')}' -> 1\")\n+\n+        # Special case: dall-e-3 only supports n=1\n+        if enforced.get(\"model\") == \"dall-e-3\" and enforced.get(\"n\", 1) > 1:\n+            enforced[\"n\"] = 1\n+            log_debug(\"Enforcing n=1 for dall-e-3 model\")\n+\n+        return enforced\n+\n+    def generate_image(\n+        self,\n+        agent: Agent,\n+        prompt: str,\n+        n: int = 1,\n+        size: Optional[Literal[\"256x256\", \"512x512\", \"1024x1024\", \"1792x1024\", \"1024x1792\"]] = \"1024x1024\",\n+        quality: Literal[\"standard\", \"hd\"] = \"standard\",\n+        style: Literal[\"vivid\", \"natural\"] = \"vivid\",\n+    ) -> str:\n+        \"\"\"Generate an image using Azure OpenAI DALL-E.\n+\n+        Args:\n+            agent: The agent instance for adding images\n+            prompt: Text description of the desired image\n+            n: Number of images to generate (default: 1).\n+                Note: dall-e-3 only supports n=1, while dall-e-2 supports multiple images.\n+            size: Image size.\n+                Valid options: \"256x256\", \"512x512\", \"1024x1024\", \"1792x1024\", \"1024x1792\" (default: \"1024x1024\")\n+                Note: Not all sizes are available for all models.\n+            quality: Image quality.\n+                Valid options: \"standard\" or \"hd\" (default: \"standard\")\n+                Note: \"hd\" quality is only available for dall-e-3.\n+            style: Image style.\n+                Valid options: \"vivid\" or \"natural\" (default: \"vivid\")\n+                Note: \"vivid\" produces more dramatic images, while \"natural\" produces more realistic ones.\n+\n+        Returns:\n+            A message with image URLs or an error message\n+\n+        Note:\n+            Invalid parameters will be automatically corrected to valid values. For example:\n+            - Invalid sizes will be changed to \"1024x1024\"\n+            - Invalid quality values will be changed to \"standard\"\n+            - Invalid style values will be changed to \"vivid\"\n+            - For dall-e-3, n will always be set to 1\n+        \"\"\"\n+        # Check if DALL-E is properly initialized\n+        if not hasattr(self, \"dalle_base_url\"):\n+            return \"DALL-E tool not properly initialized. Please check your configuration.\"\n+\n+        # Enforce valid parameters\n+        params = self._enforce_valid_dalle_parameters(\n+            {\n+                \"n\": n,\n+                \"size\": size,\n+                \"quality\": quality,\n+                \"style\": style,\n+            }\n+        )\n+\n+        # Add prompt and model to params - this wasn't included in enforcement because it doesn't need validation\n+        params[\"prompt\"] = prompt\n+        params[\"model\"] = self.dalle_model\n+\n+        try:\n+            # Make API request using stored base URL\n+            headers = {\"api-key\": self.api_key, \"Content-Type\": \"application/json\"}\n+            response = post(self.dalle_base_url, headers=headers, json=params)\n+\n+            if response.status_code != 200:\n+                return f\"Error {response.status_code}: {response.text}\"\n+\n+            # Process results\n+            data = response.json()\n+            log_debug(\"Image generated successfully\")\n+\n+            # Add images to agent\n+            response_str = \"\"\n+            for img in data.get(\"data\", []):\n+                image_url = img.get(\"url\")\n+                revised_prompt = img.get(\"revised_prompt\")\n+\n+                # Add image to agent\n+                agent.add_image(\n+                    ImageArtifact(id=str(uuid4()), url=image_url, original_prompt=prompt, revised_prompt=revised_prompt)\n+                )\n+\n+                response_str += f\"Image has been generated at the URL {image_url}\\n\"\n+            return response_str\n+\n+        except Exception as e:\n+            logger.error(f\"Failed to generate image: {e}\")\n+            return f\"Error: {e}\"\n"
        },
        {
            "commit": "7d51d48b09bbc5e6311becec1c1a4150fde89b4e",
            "file_path": "libs/agno/tests/unit/tools/test_azure_openai_tools.py",
            "diff": "diff --git a/libs/agno/tests/unit/tools/test_azure_openai_tools.py b/libs/agno/tests/unit/tools/test_azure_openai_tools.py\nnew file mode 100644\nindex 000000000..6d4c9c164\n--- /dev/null\n+++ b/libs/agno/tests/unit/tools/test_azure_openai_tools.py\n@@ -0,0 +1,218 @@\n+\"\"\"Unit tests for AzureOpenAITools class.\"\"\"\n+\n+from unittest.mock import MagicMock, patch\n+\n+import pytest\n+\n+from agno.agent import Agent\n+from agno.tools.azure_openai import AzureOpenAITools\n+\n+\n+@pytest.fixture\n+def mock_agent():\n+    \"\"\"Create a mock Agent instance.\"\"\"\n+    agent = MagicMock(spec=Agent)\n+    return agent\n+\n+\n+@pytest.fixture\n+def azure_openai_tools():\n+    \"\"\"Create an AzureOpenAITools instance with mocked credentials.\"\"\"\n+    with patch.dict(\n+        \"os.environ\",\n+        {\n+            \"AZURE_OPENAI_API_KEY\": \"test_api_key\",\n+            \"AZURE_OPENAI_ENDPOINT\": \"https://test-endpoint.openai.azure.com/\",\n+            \"AZURE_OPENAI_IMAGE_DEPLOYMENT\": \"test-deployment\",\n+            \"AZURE_OPENAI_API_VERSION\": \"2023-12-01-preview\",\n+        },\n+    ):\n+        return AzureOpenAITools()\n+\n+\n+def test_initialization():\n+    \"\"\"Test initialization with parameters.\"\"\"\n+    with patch.dict(\n+        \"os.environ\",\n+        {\n+            \"AZURE_OPENAI_API_KEY\": \"\",\n+            \"AZURE_OPENAI_ENDPOINT\": \"\",\n+        },\n+    ):\n+        tools = AzureOpenAITools(\n+            api_key=\"custom_api_key\",\n+            azure_endpoint=\"https://custom-endpoint.openai.azure.com/\",\n+            api_version=\"2023-05-15\",\n+            dalle_deployment=\"custom-deployment\",\n+            dalle_model=\"dall-e-3\",\n+        )\n+\n+        assert tools.api_key == \"custom_api_key\"\n+        assert tools.azure_endpoint == \"https://custom-endpoint.openai.azure.com/\"\n+        assert tools.api_version == \"2023-05-15\"\n+        assert tools.dalle_deployment == \"custom-deployment\"\n+        assert tools.dalle_model == \"dall-e-3\"\n+\n+\n+def test_initialization_with_env_vars():\n+    \"\"\"Test initialization with environment variables.\"\"\"\n+    with patch.dict(\n+        \"os.environ\",\n+        {\n+            \"AZURE_OPENAI_API_KEY\": \"env_api_key\",\n+            \"AZURE_OPENAI_ENDPOINT\": \"https://env-endpoint.openai.azure.com/\",\n+            \"AZURE_OPENAI_API_VERSION\": \"2023-07-01-preview\",\n+            \"AZURE_OPENAI_IMAGE_DEPLOYMENT\": \"env-deployment\",\n+        },\n+    ):\n+        tools = AzureOpenAITools()\n+\n+        assert tools.api_key == \"env_api_key\"\n+        assert tools.azure_endpoint == \"https://env-endpoint.openai.azure.com/\"\n+        assert tools.api_version == \"2023-07-01-preview\"\n+        assert tools.dalle_deployment == \"env-deployment\"\n+        assert tools.dalle_model == \"dall-e-3\"  # Default value\n+\n+\n+def test_tools_registration(azure_openai_tools):\n+    \"\"\"Test that the proper tools are registered.\"\"\"\n+    # The generate_image function should be registered\n+    function_names = [func.name for func in azure_openai_tools.functions.values()]\n+    assert \"generate_image\" in function_names\n+\n+\n+@patch(\"agno.tools.azure_openai.post\")\n+def test_generate_image_success(mock_post, azure_openai_tools, mock_agent):\n+    \"\"\"Test successful image generation.\"\"\"\n+    # Configure the mock response\n+    mock_response = MagicMock()\n+    mock_response.status_code = 200\n+    mock_response.json.return_value = {\n+        \"data\": [{\"url\": \"https://test-image-url.com/image.png\", \"revised_prompt\": \"A revised prompt for the image\"}]\n+    }\n+    mock_post.return_value = mock_response\n+\n+    # Call the generate_image function\n+    result = azure_openai_tools.generate_image(agent=mock_agent, prompt=\"A test prompt\", size=\"1024x1024\")\n+\n+    # Verify the API call\n+    mock_post.assert_called_once()\n+    args, kwargs = mock_post.call_args\n+    # Check URL with more flexible assertion to accommodate potential double slashes\n+    assert \"test-endpoint.openai.azure.com\" in args[0]\n+    assert \"openai/deployments/test-deployment/images/generations\" in args[0]\n+    assert \"api-version=\" in args[0]\n+    assert kwargs[\"headers\"][\"api-key\"] == \"test_api_key\"\n+\n+    # Check the enforced parameters in the JSON payload\n+    assert kwargs[\"json\"][\"model\"] == \"dall-e-3\"\n+    assert kwargs[\"json\"][\"size\"] == \"1024x1024\"\n+    assert kwargs[\"json\"][\"style\"] == \"vivid\"  # Default value\n+    assert kwargs[\"json\"][\"quality\"] == \"standard\"  # Default value\n+    assert kwargs[\"json\"][\"n\"] == 1  # Default value\n+\n+    # Verify the agent interaction\n+    mock_agent.add_image.assert_called_once()\n+\n+    # Check the return string\n+    assert \"https://test-image-url.com/image.png\" in result\n+\n+\n+@patch(\"agno.tools.azure_openai.post\")\n+def test_generate_image_with_custom_parameters(mock_post, azure_openai_tools, mock_agent):\n+    \"\"\"Test image generation with custom parameters.\"\"\"\n+    # Configure the mock response\n+    mock_response = MagicMock()\n+    mock_response.status_code = 200\n+    mock_response.json.return_value = {\n+        \"data\": [{\"url\": \"https://test-image-url.com/image.png\", \"revised_prompt\": \"A revised prompt for the image\"}]\n+    }\n+    mock_post.return_value = mock_response\n+\n+    # Call the generate_image function with custom parameters\n+    azure_openai_tools.generate_image(\n+        agent=mock_agent, prompt=\"A test prompt\", size=\"1792x1024\", quality=\"hd\", style=\"vivid\"\n+    )\n+\n+    # Verify the API call uses the correct deployment\n+    mock_post.assert_called_once()\n+    args, kwargs = mock_post.call_args\n+    # Check URL with more flexible assertion to accommodate potential double slashes\n+    assert \"test-endpoint.openai.azure.com\" in args[0]\n+    assert \"openai/deployments/test-deployment/images/generations\" in args[0]\n+    assert \"api-version=\" in args[0]\n+\n+    # Verify all parameters are correctly passed\n+    assert kwargs[\"json\"][\"prompt\"] == \"A test prompt\"\n+    assert kwargs[\"json\"][\"model\"] == \"dall-e-3\"\n+    assert kwargs[\"json\"][\"quality\"] == \"hd\"\n+    assert kwargs[\"json\"][\"style\"] == \"vivid\"\n+    assert kwargs[\"json\"][\"size\"] == \"1792x1024\"\n+    assert kwargs[\"json\"][\"n\"] == 1  # Default for dall-e-3\n+\n+\n+@patch(\"agno.tools.azure_openai.post\")\n+def test_generate_image_failure(mock_post, azure_openai_tools, mock_agent):\n+    \"\"\"Test image generation failure handling.\"\"\"\n+    # Configure the mock response for a failed API call\n+    mock_response = MagicMock()\n+    mock_response.status_code = 400\n+    mock_response.text = \"Bad Request: Invalid prompt\"\n+    mock_post.return_value = mock_response\n+\n+    # Call the generate_image function\n+    result = azure_openai_tools.generate_image(agent=mock_agent, prompt=\"A test prompt\")\n+\n+    # Verify the error is properly handled\n+    assert \"Error\" in result\n+    assert \"400\" in result\n+    assert \"Bad Request: Invalid prompt\" in result\n+\n+    # Make sure no image was added to the agent\n+    mock_agent.add_image.assert_not_called()\n+\n+\n+def test_generate_image_missing_credentials(azure_openai_tools, mock_agent):\n+    \"\"\"Test image generation with missing credentials.\"\"\"\n+    # Remove the required environment variables\n+    with patch.dict(\n+        \"os.environ\",\n+        {\"AZURE_OPENAI_API_KEY\": \"\", \"AZURE_OPENAI_ENDPOINT\": \"\", \"AZURE_OPENAI_IMAGE_DEPLOYMENT\": \"\"},\n+        clear=True,\n+    ):\n+        # Reset the tool with empty credentials\n+        azure_openai_tools.api_key = None\n+        azure_openai_tools.azure_endpoint = None\n+        azure_openai_tools.dalle_deployment = None\n+\n+        # Call the generate_image function\n+        result = azure_openai_tools.generate_image(agent=mock_agent, prompt=\"A test prompt\")\n+\n+    # Verify the error message\n+    assert \"not properly initialized\" in result\n+\n+    # Make sure no API call was made and no image was added\n+    mock_agent.add_image.assert_not_called()\n+\n+\n+def test_invalid_parameters(azure_openai_tools, mock_agent):\n+    \"\"\"Test automatic correction of invalid parameters.\"\"\"\n+    # Setup mock response for successful API call\n+    with patch(\"agno.tools.azure_openai.post\") as mock_post:\n+        mock_response = MagicMock()\n+        mock_response.status_code = 200\n+        mock_response.json.return_value = {\n+            \"data\": [\n+                {\"url\": \"https://test-image-url.com/image.png\", \"revised_prompt\": \"A revised prompt for the image\"}\n+            ]\n+        }\n+        mock_post.return_value = mock_response\n+\n+        # Test with invalid size - should be corrected to 1024x1024\n+        azure_openai_tools.generate_image(agent=mock_agent, prompt=\"A test prompt for size\", size=\"invalid-size\")\n+\n+        # Verify the API call used the corrected size\n+        args, kwargs = mock_post.call_args\n+        assert kwargs[\"json\"][\"prompt\"] == \"A test prompt for size\"\n+        assert kwargs[\"json\"][\"size\"] == \"1024x1024\"\n+        assert kwargs[\"json\"][\"model\"] == \"dall-e-3\"  # Default model\n"
        }
    ]
}