{
    "sha_fail": "16c48e2d1190bbc6fd907ae612921df5dd3f42f4",
    "changed_files": [
        {
            "commit": "16c48e2d1190bbc6fd907ae612921df5dd3f42f4",
            "file_path": "starlette/middleware/cors.py",
            "diff": "diff --git a/starlette/middleware/cors.py b/starlette/middleware/cors.py\nindex 36ba9f9..4964576 100644\n--- a/starlette/middleware/cors.py\n+++ b/starlette/middleware/cors.py\n@@ -2,13 +2,13 @@ from __future__ import annotations\n \n import functools\n import re\n-from collections.abc import Sequence\n+from collections.abc import Collection\n \n from starlette.datastructures import Headers, MutableHeaders\n from starlette.responses import PlainTextResponse, Response\n from starlette.types import ASGIApp, Message, Receive, Scope, Send\n \n-ALL_METHODS = (\"DELETE\", \"GET\", \"HEAD\", \"OPTIONS\", \"PATCH\", \"POST\", \"PUT\")\n+ALL_METHODS = {\"DELETE\", \"GET\", \"HEAD\", \"OPTIONS\", \"PATCH\", \"POST\", \"PUT\"}\n SAFELISTED_HEADERS = {\"Accept\", \"Accept-Language\", \"Content-Language\", \"Content-Type\"}\n \n \n@@ -16,60 +16,57 @@ class CORSMiddleware:\n     def __init__(\n         self,\n         app: ASGIApp,\n-        allow_origins: Sequence[str] = (),\n-        allow_methods: Sequence[str] = (\"GET\",),\n-        allow_headers: Sequence[str] = (),\n+        allow_origins: Collection[str] = {},\n+        allow_methods: Collection[str] = {\"GET\"},\n+        allow_headers: Collection[str] = {},\n         allow_credentials: bool = False,\n         allow_origin_regex: str | None = None,\n         allow_private_network: bool = False,\n-        expose_headers: Sequence[str] = (),\n+        expose_headers: Collection[str] = {},\n         max_age: int = 600,\n     ) -> None:\n         if \"*\" in allow_methods:\n             allow_methods = ALL_METHODS\n \n-        compiled_allow_origin_regex = None\n-        if allow_origin_regex is not None:\n-            compiled_allow_origin_regex = re.compile(allow_origin_regex)\n-\n         allow_all_origins = \"*\" in allow_origins\n         allow_all_headers = \"*\" in allow_headers\n-        preflight_explicit_allow_origin = not allow_all_origins or allow_credentials\n+        explicit_allow_origin = allow_credentials or not allow_all_origins\n+        allow_headers = SAFELISTED_HEADERS.union(allow_headers)\n \n         simple_headers: dict[str, str] = {}\n-        if allow_all_origins:\n+        if not explicit_allow_origin:\n             simple_headers[\"Access-Control-Allow-Origin\"] = \"*\"\n         if allow_credentials:\n             simple_headers[\"Access-Control-Allow-Credentials\"] = \"true\"\n         if expose_headers:\n             simple_headers[\"Access-Control-Expose-Headers\"] = \", \".join(expose_headers)\n \n-        preflight_headers: dict[str, str] = {}\n-        if preflight_explicit_allow_origin:\n-            # The origin value will be set in preflight_response() if it is allowed.\n-            preflight_headers[\"Vary\"] = \"Origin\"\n-        else:\n+        preflight_headers: dict[str, str] = {\n+            \"Access-Control-Allow-Methods\": \", \".join(allow_methods),\n+            \"Access-Control-Max-Age\": str(max_age),\n+        }\n+        if not explicit_allow_origin:\n             preflight_headers[\"Access-Control-Allow-Origin\"] = \"*\"\n-        preflight_headers.update(\n-            {\n-                \"Access-Control-Allow-Methods\": \", \".join(allow_methods),\n-                \"Access-Control-Max-Age\": str(max_age),\n-            }\n-        )\n-        allow_headers = sorted(SAFELISTED_HEADERS | set(allow_headers))\n-        if allow_headers and not allow_all_headers:\n-            preflight_headers[\"Access-Control-Allow-Headers\"] = \", \".join(allow_headers)\n+        if not allow_all_headers:\n+            preflight_headers[\"Access-Control-Allow-Headers\"] = \", \".join(sorted(allow_headers))\n         if allow_credentials:\n             preflight_headers[\"Access-Control-Allow-Credentials\"] = \"true\"\n \n+        preflight_vary: list[str] = [\"Access-Control-Request-Headers\", \"Access-Control-Request-Private-Network\"]\n+        if allow_methods != ALL_METHODS:\n+            preflight_vary.append(\"Access-Control-Request-Method\")\n+        if explicit_allow_origin:\n+            preflight_vary.append(\"Origin\")\n+        preflight_headers[\"Vary\"] = \", \".join(preflight_vary)\n+\n         self.app = app\n         self.allow_origins = allow_origins\n         self.allow_methods = allow_methods\n-        self.allow_headers = [h.lower() for h in allow_headers]\n+        self.allow_headers = {h.lower() for h in allow_headers}\n         self.allow_all_origins = allow_all_origins\n         self.allow_all_headers = allow_all_headers\n-        self.preflight_explicit_allow_origin = preflight_explicit_allow_origin\n-        self.allow_origin_regex = compiled_allow_origin_regex\n+        self.explicit_allow_origin = explicit_allow_origin\n+        self.allow_origin_regex = re.compile(allow_origin_regex) if allow_origin_regex is not None else None\n         self.allow_private_network = allow_private_network\n         self.simple_headers = simple_headers\n         self.preflight_headers = preflight_headers\n@@ -79,15 +76,13 @@ class CORSMiddleware:\n             await self.app(scope, receive, send)\n             return\n \n-        method = scope[\"method\"]\n         headers = Headers(scope=scope)\n-        origin = headers.get(\"origin\")\n \n-        if origin is None:\n+        if \"origin\" not in headers:\n             await self.app(scope, receive, send)\n             return\n \n-        if method == \"OPTIONS\" and \"access-control-request-method\" in headers:\n+        if scope[\"method\"] == \"OPTIONS\" and \"access-control-request-method\" in headers:\n             response = self.preflight_response(request_headers=headers)\n             await response(scope, receive, send)\n             return\n@@ -95,13 +90,14 @@ class CORSMiddleware:\n         await self.simple_response(scope, receive, send, request_headers=headers)\n \n     def is_allowed_origin(self, origin: str) -> bool:\n-        if self.allow_all_origins:\n+        if origin in self.allow_origins:\n             return True\n-\n+        if origin == \"null\":\n+            return False\n         if self.allow_origin_regex is not None and self.allow_origin_regex.fullmatch(origin):\n             return True\n \n-        return origin in self.allow_origins\n+        return self.allow_all_origins\n \n     def preflight_response(self, request_headers: Headers) -> Response:\n         requested_origin = request_headers[\"origin\"]\n@@ -112,8 +108,8 @@ class CORSMiddleware:\n         headers = dict(self.preflight_headers)\n         failures: list[str] = []\n \n-        if self.is_allowed_origin(origin=requested_origin):\n-            if self.preflight_explicit_allow_origin:\n+        if self.is_allowed_origin(requested_origin):\n+            if self.explicit_allow_origin:\n                 # The \"else\" case is already accounted for in self.preflight_headers\n                 # and the value would be \"*\".\n                 headers[\"Access-Control-Allow-Origin\"] = requested_origin\n@@ -123,13 +119,12 @@ class CORSMiddleware:\n         if requested_method not in self.allow_methods:\n             failures.append(\"method\")\n \n-        # If we allow all headers, then we have to mirror back any requested\n-        # headers in the response.\n+        # When allow_headers is wildcard, mirror any requested headers.\n         if self.allow_all_headers and requested_headers is not None:\n             headers[\"Access-Control-Allow-Headers\"] = requested_headers\n         elif requested_headers is not None:\n-            for header in [h.lower() for h in requested_headers.split(\",\")]:\n-                if header.strip() not in self.allow_headers:\n+            for header in requested_headers.split(\",\"):\n+                if header.strip().lower() not in self.allow_headers:\n                     failures.append(\"headers\")\n                     break\n \n@@ -159,23 +154,15 @@ class CORSMiddleware:\n \n         message.setdefault(\"headers\", [])\n         headers = MutableHeaders(scope=message)\n-        headers.update(self.simple_headers)\n         origin = request_headers[\"Origin\"]\n-        has_cookie = \"cookie\" in request_headers\n \n-        # If request includes any cookie headers, then we must respond\n-        # with the specific origin instead of '*'.\n-        if self.allow_all_origins and has_cookie:\n-            self.allow_explicit_origin(headers, origin)\n+        if self.explicit_allow_origin:\n+            headers.add_vary_header(\"Origin\")\n \n-        # If we only allow specific origins, then we have to mirror back\n-        # the Origin header in the response.\n-        elif not self.allow_all_origins and self.is_allowed_origin(origin=origin):\n-            self.allow_explicit_origin(headers, origin)\n+        if self.is_allowed_origin(origin):\n+            headers.update(self.simple_headers)\n \n-        await send(message)\n+            if self.explicit_allow_origin:\n+                headers[\"Access-Control-Allow-Origin\"] = origin\n \n-    @staticmethod\n-    def allow_explicit_origin(headers: MutableHeaders, origin: str) -> None:\n-        headers[\"Access-Control-Allow-Origin\"] = origin\n-        headers.add_vary_header(\"Origin\")\n+        await send(message)\n"
        },
        {
            "commit": "16c48e2d1190bbc6fd907ae612921df5dd3f42f4",
            "file_path": "tests/middleware/test_cors.py",
            "diff": "diff --git a/tests/middleware/test_cors.py b/tests/middleware/test_cors.py\nindex cbee7d6..f2c5fa2 100644\n--- a/tests/middleware/test_cors.py\n+++ b/tests/middleware/test_cors.py\n@@ -1,12 +1,25 @@\n+from httpx import Response\n+\n from starlette.applications import Starlette\n from starlette.middleware import Middleware\n-from starlette.middleware.cors import CORSMiddleware\n+from starlette.middleware.cors import ALL_METHODS, CORSMiddleware\n from starlette.requests import Request\n from starlette.responses import PlainTextResponse\n from starlette.routing import Route\n from tests.types import TestClientFactory\n \n \n+def assert_vary(response: Response, expected: set[str] | None) -> None:\n+    vary_header = response.headers.get(\"vary\")\n+    if expected is None:\n+        assert vary_header is None\n+        return\n+\n+    assert vary_header is not None\n+    actual = {value.strip() for value in vary_header.split(\",\") if value.strip()}\n+    assert actual == expected\n+\n+\n def test_cors_allow_all(\n     test_client_factory: TestClientFactory,\n ) -> None:\n@@ -37,29 +50,25 @@ def test_cors_allow_all(\n     }\n     response = client.options(\"/\", headers=headers)\n     assert response.status_code == 200\n-    assert response.text == \"OK\"\n     assert response.headers[\"access-control-allow-origin\"] == \"https://example.org\"\n     assert response.headers[\"access-control-allow-headers\"] == \"X-Example\"\n     assert response.headers[\"access-control-allow-credentials\"] == \"true\"\n-    assert response.headers[\"vary\"] == \"Origin\"\n+    assert_vary(\n+        response,\n+        {\"Access-Control-Request-Headers\", \"Access-Control-Request-Private-Network\", \"Origin\"},\n+    )\n+    allowed_methods = {method.strip() for method in response.headers[\"access-control-allow-methods\"].split(\",\")}\n+    assert allowed_methods == ALL_METHODS\n \n     # Test standard response\n     headers = {\"Origin\": \"https://example.org\"}\n     response = client.get(\"/\", headers=headers)\n     assert response.status_code == 200\n     assert response.text == \"Homepage\"\n-    assert response.headers[\"access-control-allow-origin\"] == \"*\"\n-    assert response.headers[\"access-control-expose-headers\"] == \"X-Status\"\n-    assert response.headers[\"access-control-allow-credentials\"] == \"true\"\n-\n-    # Test standard credentialed response\n-    headers = {\"Origin\": \"https://example.org\", \"Cookie\": \"star_cookie=sugar\"}\n-    response = client.get(\"/\", headers=headers)\n-    assert response.status_code == 200\n-    assert response.text == \"Homepage\"\n     assert response.headers[\"access-control-allow-origin\"] == \"https://example.org\"\n     assert response.headers[\"access-control-expose-headers\"] == \"X-Status\"\n     assert response.headers[\"access-control-allow-credentials\"] == \"true\"\n+    assert_vary(response, {\"Origin\"})\n \n     # Test non-CORS response\n     response = client.get(\"/\")\n@@ -101,7 +110,10 @@ def test_cors_allow_all_except_credentials(\n     assert response.headers[\"access-control-allow-origin\"] == \"*\"\n     assert response.headers[\"access-control-allow-headers\"] == \"X-Example\"\n     assert \"access-control-allow-credentials\" not in response.headers\n-    assert \"vary\" not in response.headers\n+    assert_vary(\n+        response,\n+        {\"Access-Control-Request-Headers\", \"Access-Control-Request-Private-Network\"},\n+    )\n \n     # Test standard response\n     headers = {\"Origin\": \"https://example.org\"}\n@@ -111,6 +123,7 @@ def test_cors_allow_all_except_credentials(\n     assert response.headers[\"access-control-allow-origin\"] == \"*\"\n     assert response.headers[\"access-control-expose-headers\"] == \"X-Status\"\n     assert \"access-control-allow-credentials\" not in response.headers\n+    assert_vary(response, None)\n \n     # Test non-CORS response\n     response = client.get(\"/\")\n@@ -146,12 +159,20 @@ def test_cors_allow_specific_origin(\n     }\n     response = client.options(\"/\", headers=headers)\n     assert response.status_code == 200\n-    assert response.text == \"OK\"\n     assert response.headers[\"access-control-allow-origin\"] == \"https://example.org\"\n-    assert response.headers[\"access-control-allow-headers\"] == (\n-        \"Accept, Accept-Language, Content-Language, Content-Type, X-Example\"\n-    )\n+    allowed_headers = {h.strip() for h in response.headers[\"access-control-allow-headers\"].split(\",\")}\n+    assert allowed_headers == {\"Accept\", \"Accept-Language\", \"Content-Language\", \"Content-Type\", \"X-Example\"}\n     assert \"access-control-allow-credentials\" not in response.headers\n+    assert_vary(\n+        response,\n+        {\n+            \"Access-Control-Request-Headers\",\n+            \"Access-Control-Request-Private-Network\",\n+            \"Access-Control-Request-Method\",\n+            \"Origin\",\n+        },\n+    )\n+    assert response.headers[\"access-control-allow-methods\"] == \"GET\"\n \n     # Test standard response\n     headers = {\"Origin\": \"https://example.org\"}\n@@ -160,6 +181,15 @@ def test_cors_allow_specific_origin(\n     assert response.text == \"Homepage\"\n     assert response.headers[\"access-control-allow-origin\"] == \"https://example.org\"\n     assert \"access-control-allow-credentials\" not in response.headers\n+    assert_vary(response, {\"Origin\"})\n+\n+    # Test disallowed standard response\n+    headers = {\"Origin\": \"https://another.org\"}\n+    response = client.get(\"/\", headers=headers)\n+    assert response.status_code == 200\n+    assert response.text == \"Homepage\"\n+    assert \"access-control-allow-origin\" not in response.headers\n+    assert_vary(response, {\"Origin\"})\n \n     # Test non-CORS response\n     response = client.get(\"/\")\n@@ -197,6 +227,15 @@ def test_cors_disallowed_preflight(\n     assert response.status_code == 400\n     assert response.text == \"Disallowed CORS origin, method, headers\"\n     assert \"access-control-allow-origin\" not in response.headers\n+    assert_vary(\n+        response,\n+        {\n+            \"Access-Control-Request-Headers\",\n+            \"Access-Control-Request-Private-Network\",\n+            \"Access-Control-Request-Method\",\n+            \"Origin\",\n+        },\n+    )\n \n     # Bug specific test, https://github.com/Kludex/starlette/pull/1199\n     # Test preflight response text with multiple disallowed headers\n@@ -209,41 +248,6 @@ def test_cors_disallowed_preflight(\n     assert response.text == \"Disallowed CORS headers\"\n \n \n-def test_preflight_allows_request_origin_if_origins_wildcard_and_credentials_allowed(\n-    test_client_factory: TestClientFactory,\n-) -> None:\n-    def homepage(request: Request) -> None:\n-        return  # pragma: no cover\n-\n-    app = Starlette(\n-        routes=[Route(\"/\", endpoint=homepage)],\n-        middleware=[\n-            Middleware(\n-                CORSMiddleware,\n-                allow_origins=[\"*\"],\n-                allow_methods=[\"POST\"],\n-                allow_credentials=True,\n-            )\n-        ],\n-    )\n-\n-    client = test_client_factory(app)\n-\n-    # Test pre-flight response\n-    headers = {\n-        \"Origin\": \"https://example.org\",\n-        \"Access-Control-Request-Method\": \"POST\",\n-    }\n-    response = client.options(\n-        \"/\",\n-        headers=headers,\n-    )\n-    assert response.status_code == 200\n-    assert response.headers[\"access-control-allow-origin\"] == \"https://example.org\"\n-    assert response.headers[\"access-control-allow-credentials\"] == \"true\"\n-    assert response.headers[\"vary\"] == \"Origin\"\n-\n-\n def test_cors_preflight_allow_all_methods(\n     test_client_factory: TestClientFactory,\n ) -> None:\n@@ -262,10 +266,11 @@ def test_cors_preflight_allow_all_methods(\n         \"Access-Control-Request-Method\": \"POST\",\n     }\n \n+    response = client.options(\"/\", headers=headers)\n+    assert response.status_code == 200\n+    allowed_methods = {m.strip() for m in response.headers[\"access-control-allow-methods\"].split(\",\")}\n     for method in (\"DELETE\", \"GET\", \"HEAD\", \"OPTIONS\", \"PATCH\", \"POST\", \"PUT\"):\n-        response = client.options(\"/\", headers=headers)\n-        assert response.status_code == 200\n-        assert method in response.headers[\"access-control-allow-methods\"]\n+        assert method in allowed_methods\n \n \n def test_cors_allow_all_methods(\n@@ -324,14 +329,7 @@ def test_cors_allow_origin_regex(\n     assert response.text == \"Homepage\"\n     assert response.headers[\"access-control-allow-origin\"] == \"https://example.org\"\n     assert response.headers[\"access-control-allow-credentials\"] == \"true\"\n-\n-    # Test standard credentialed response\n-    headers = {\"Origin\": \"https://example.org\", \"Cookie\": \"star_cookie=sugar\"}\n-    response = client.get(\"/\", headers=headers)\n-    assert response.status_code == 200\n-    assert response.text == \"Homepage\"\n-    assert response.headers[\"access-control-allow-origin\"] == \"https://example.org\"\n-    assert response.headers[\"access-control-allow-credentials\"] == \"true\"\n+    assert_vary(response, {\"Origin\"})\n \n     # Test disallowed standard response\n     # Note that enforcement is a browser concern. The disallowed-ness is reflected\n@@ -341,6 +339,7 @@ def test_cors_allow_origin_regex(\n     assert response.status_code == 200\n     assert response.text == \"Homepage\"\n     assert \"access-control-allow-origin\" not in response.headers\n+    assert_vary(response, {\"Origin\"})\n \n     # Test pre-flight response\n     headers = {\n@@ -350,12 +349,19 @@ def test_cors_allow_origin_regex(\n     }\n     response = client.options(\"/\", headers=headers)\n     assert response.status_code == 200\n-    assert response.text == \"OK\"\n     assert response.headers[\"access-control-allow-origin\"] == \"https://another.com\"\n-    assert response.headers[\"access-control-allow-headers\"] == (\n-        \"Accept, Accept-Language, Content-Language, Content-Type, X-Example\"\n-    )\n+    allowed_headers = {h.strip() for h in response.headers[\"access-control-allow-headers\"].split(\",\")}\n+    assert allowed_headers == {\"Accept\", \"Accept-Language\", \"Content-Language\", \"Content-Type\", \"X-Example\"}\n     assert response.headers[\"access-control-allow-credentials\"] == \"true\"\n+    assert_vary(\n+        response,\n+        {\n+            \"Access-Control-Request-Headers\",\n+            \"Access-Control-Request-Private-Network\",\n+            \"Access-Control-Request-Method\",\n+            \"Origin\",\n+        },\n+    )\n \n     # Test disallowed pre-flight response\n     headers = {\n@@ -395,6 +401,7 @@ def test_cors_allow_origin_regex_fullmatch(\n     assert response.text == \"Homepage\"\n     assert response.headers[\"access-control-allow-origin\"] == \"https://subdomain.example.org\"\n     assert \"access-control-allow-credentials\" not in response.headers\n+    assert_vary(response, {\"Origin\"})\n \n     # Test disallowed standard response\n     headers = {\"Origin\": \"https://subdomain.example.org.hacker.com\"}\n@@ -402,100 +409,93 @@ def test_cors_allow_origin_regex_fullmatch(\n     assert response.status_code == 200\n     assert response.text == \"Homepage\"\n     assert \"access-control-allow-origin\" not in response.headers\n+    assert_vary(response, {\"Origin\"})\n \n \n-def test_cors_credentialed_requests_return_specific_origin(\n+def test_cors_vary_header_behavior(\n     test_client_factory: TestClientFactory,\n ) -> None:\n     def homepage(request: Request) -> PlainTextResponse:\n-        return PlainTextResponse(\"Homepage\", status_code=200)\n+        return PlainTextResponse(\"Homepage\", status_code=200, headers={\"Vary\": \"Accept-Encoding\"})\n \n-    app = Starlette(\n+    # Test 1: Specific origins add Vary: Origin\n+    app_specific = Starlette(\n         routes=[Route(\"/\", endpoint=homepage)],\n-        middleware=[Middleware(CORSMiddleware, allow_origins=[\"*\"])],\n+        middleware=[Middleware(CORSMiddleware, allow_origins=[\"https://example.org\"])],\n     )\n-    client = test_client_factory(app)\n+    client = test_client_factory(app_specific)\n \n-    # Test credentialed request\n-    headers = {\"Origin\": \"https://example.org\", \"Cookie\": \"star_cookie=sugar\"}\n-    response = client.get(\"/\", headers=headers)\n+    response = client.get(\"/\", headers={\"Origin\": \"https://example.org\"})\n     assert response.status_code == 200\n-    assert response.text == \"Homepage\"\n     assert response.headers[\"access-control-allow-origin\"] == \"https://example.org\"\n-    assert \"access-control-allow-credentials\" not in response.headers\n-\n-\n-def test_cors_vary_header_defaults_to_origin(\n-    test_client_factory: TestClientFactory,\n-) -> None:\n-    def homepage(request: Request) -> PlainTextResponse:\n-        return PlainTextResponse(\"Homepage\", status_code=200)\n+    assert_vary(response, {\"Accept-Encoding\", \"Origin\"})\n \n-    app = Starlette(\n+    # Test 2: Wildcard without credentials does not add Vary: Origin\n+    app_wildcard = Starlette(\n         routes=[Route(\"/\", endpoint=homepage)],\n-        middleware=[Middleware(CORSMiddleware, allow_origins=[\"https://example.org\"])],\n+        middleware=[Middleware(CORSMiddleware, allow_origins=[\"*\"])],\n     )\n+    client = test_client_factory(app_wildcard)\n \n-    headers = {\"Origin\": \"https://example.org\"}\n-\n-    client = test_client_factory(app)\n-\n-    response = client.get(\"/\", headers=headers)\n+    response = client.get(\"/\", headers={\"Origin\": \"https://someplace.org\"})\n     assert response.status_code == 200\n-    assert response.headers[\"vary\"] == \"Origin\"\n-\n-\n-def test_cors_vary_header_is_not_set_for_non_credentialed_request(\n-    test_client_factory: TestClientFactory,\n-) -> None:\n-    def homepage(request: Request) -> PlainTextResponse:\n-        return PlainTextResponse(\"Homepage\", status_code=200, headers={\"Vary\": \"Accept-Encoding\"})\n+    assert response.headers[\"access-control-allow-origin\"] == \"*\"\n+    assert_vary(response, {\"Accept-Encoding\"})\n \n-    app = Starlette(\n+    # Test 3: Wildcard with credentials adds Vary: Origin\n+    app_wildcard_creds = Starlette(\n         routes=[Route(\"/\", endpoint=homepage)],\n-        middleware=[Middleware(CORSMiddleware, allow_origins=[\"*\"])],\n+        middleware=[Middleware(CORSMiddleware, allow_origins=[\"*\"], allow_credentials=True)],\n     )\n-    client = test_client_factory(app)\n+    client = test_client_factory(app_wildcard_creds)\n \n-    response = client.get(\"/\", headers={\"Origin\": \"https://someplace.org\"})\n+    response = client.get(\"/\", headers={\"Cookie\": \"foo=bar\", \"Origin\": \"https://someplace.org\"})\n     assert response.status_code == 200\n-    assert response.headers[\"vary\"] == \"Accept-Encoding\"\n+    assert response.headers[\"access-control-allow-origin\"] == \"https://someplace.org\"\n+    assert response.headers[\"access-control-allow-credentials\"] == \"true\"\n+    assert_vary(response, {\"Accept-Encoding\", \"Origin\"})\n \n \n-def test_cors_vary_header_is_properly_set_for_credentialed_request(\n+def test_cors_preflight_vary_with_wildcard_origins_specific_methods(\n     test_client_factory: TestClientFactory,\n ) -> None:\n     def homepage(request: Request) -> PlainTextResponse:\n-        return PlainTextResponse(\"Homepage\", status_code=200, headers={\"Vary\": \"Accept-Encoding\"})\n+        pass  # pragma: no cover\n \n     app = Starlette(\n         routes=[Route(\"/\", endpoint=homepage)],\n-        middleware=[Middleware(CORSMiddleware, allow_origins=[\"*\"])],\n+        middleware=[Middleware(CORSMiddleware, allow_origins=[\"*\"], allow_methods=[\"GET\", \"POST\"])],\n     )\n     client = test_client_factory(app)\n \n-    response = client.get(\"/\", headers={\"Cookie\": \"foo=bar\", \"Origin\": \"https://someplace.org\"})\n+    # Preflight Vary should include Request-Method even with wildcard origins when methods are restricted\n+    response = client.options(\"/\", headers={\"Origin\": \"https://example.org\", \"Access-Control-Request-Method\": \"POST\"})\n     assert response.status_code == 200\n-    assert response.headers[\"vary\"] == \"Accept-Encoding, Origin\"\n+    assert_vary(\n+        response,\n+        {\"Access-Control-Request-Headers\", \"Access-Control-Request-Private-Network\", \"Access-Control-Request-Method\"},\n+    )\n \n \n-def test_cors_vary_header_is_properly_set_when_allow_origins_is_not_wildcard(\n+def test_cors_preflight_vary_with_specific_origins_wildcard_methods(\n     test_client_factory: TestClientFactory,\n ) -> None:\n     def homepage(request: Request) -> PlainTextResponse:\n-        return PlainTextResponse(\"Homepage\", status_code=200, headers={\"Vary\": \"Accept-Encoding\"})\n+        pass  # pragma: no cover\n \n     app = Starlette(\n-        routes=[\n-            Route(\"/\", endpoint=homepage),\n-        ],\n-        middleware=[Middleware(CORSMiddleware, allow_origins=[\"https://example.org\"])],\n+        routes=[Route(\"/\", endpoint=homepage)],\n+        middleware=[Middleware(CORSMiddleware, allow_origins=[\"https://example.org\"], allow_methods=[\"*\"])],\n     )\n     client = test_client_factory(app)\n \n-    response = client.get(\"/\", headers={\"Origin\": \"https://example.org\"})\n+    # Preflight Vary should NOT include Request-Method when methods are unrestricted\n+    response = client.options(\"/\", headers={\"Origin\": \"https://example.org\", \"Access-Control-Request-Method\": \"POST\"})\n     assert response.status_code == 200\n-    assert response.headers[\"vary\"] == \"Accept-Encoding, Origin\"\n+    assert_vary(\n+        response,\n+        {\"Access-Control-Request-Headers\", \"Access-Control-Request-Private-Network\", \"Origin\"},\n+    )\n \n \n def test_cors_allowed_origin_does_not_leak_between_credentialed_requests(\n@@ -514,22 +514,26 @@ def test_cors_allowed_origin_does_not_leak_between_credentialed_requests(\n                 allow_origins=[\"*\"],\n                 allow_headers=[\"*\"],\n                 allow_methods=[\"*\"],\n+                allow_credentials=True,\n             )\n         ],\n     )\n \n     client = test_client_factory(app)\n-    response = client.get(\"/\", headers={\"Origin\": \"https://someplace.org\"})\n-    assert response.headers[\"access-control-allow-origin\"] == \"*\"\n-    assert \"access-control-allow-credentials\" not in response.headers\n+    first_origin = \"https://first.example\"\n+    second_origin = \"https://second.example\"\n \n-    response = client.get(\"/\", headers={\"Cookie\": \"foo=bar\", \"Origin\": \"https://someplace.org\"})\n-    assert response.headers[\"access-control-allow-origin\"] == \"https://someplace.org\"\n-    assert \"access-control-allow-credentials\" not in response.headers\n+    response = client.get(\"/\", headers={\"Origin\": first_origin})\n+    assert response.headers[\"access-control-allow-origin\"] == first_origin\n+    assert response.headers[\"access-control-allow-credentials\"] == \"true\"\n \n-    response = client.get(\"/\", headers={\"Origin\": \"https://someplace.org\"})\n-    assert response.headers[\"access-control-allow-origin\"] == \"*\"\n-    assert \"access-control-allow-credentials\" not in response.headers\n+    response = client.get(\"/\", headers={\"Cookie\": \"foo=bar\", \"Origin\": second_origin})\n+    assert response.headers[\"access-control-allow-origin\"] == second_origin\n+    assert response.headers[\"access-control-allow-credentials\"] == \"true\"\n+\n+    response = client.get(\"/\", headers={\"Origin\": first_origin})\n+    assert response.headers[\"access-control-allow-origin\"] == first_origin\n+    assert response.headers[\"access-control-allow-credentials\"] == \"true\"\n \n \n def test_cors_private_network_access_allowed(test_client_factory: TestClientFactory) -> None:\n@@ -558,12 +562,20 @@ def test_cors_private_network_access_allowed(test_client_factory: TestClientFact\n     assert response.status_code == 200\n     assert response.text == \"OK\"\n     assert response.headers[\"access-control-allow-private-network\"] == \"true\"\n+    assert_vary(\n+        response,\n+        {\"Access-Control-Request-Headers\", \"Access-Control-Request-Private-Network\"},\n+    )\n \n     # Test preflight without Private Network Access request\n     response = client.options(\"/\", headers=headers_without_pna)\n     assert response.status_code == 200\n     assert response.text == \"OK\"\n     assert \"access-control-allow-private-network\" not in response.headers\n+    assert_vary(\n+        response,\n+        {\"Access-Control-Request-Headers\", \"Access-Control-Request-Private-Network\"},\n+    )\n \n     # The access-control-allow-private-network header is not set for non-preflight requests\n     response = client.get(\"/\", headers=headers_with_pna)\n@@ -605,3 +617,220 @@ def test_cors_private_network_access_disallowed(test_client_factory: TestClientF\n     assert response.status_code == 400\n     assert response.text == \"Disallowed CORS private-network\"\n     assert \"access-control-allow-private-network\" not in response.headers\n+    assert_vary(\n+        response,\n+        {\"Access-Control-Request-Headers\", \"Access-Control-Request-Private-Network\"},\n+    )\n+\n+\n+def test_cors_null_origin_rejection(test_client_factory: TestClientFactory) -> None:\n+    def homepage(request: Request) -> PlainTextResponse:\n+        return PlainTextResponse(\"Homepage\", status_code=200)\n+\n+    # Test 1: Null rejected with wildcard origins\n+    app_wildcard = Starlette(\n+        routes=[Route(\"/\", endpoint=homepage)],\n+        middleware=[Middleware(CORSMiddleware, allow_origins=[\"*\"])],\n+    )\n+    client = test_client_factory(app_wildcard)\n+\n+    response = client.options(\"/\", headers={\"Origin\": \"null\", \"Access-Control-Request-Method\": \"GET\"})\n+    assert response.status_code == 400\n+    assert \"origin\" in response.text.lower()\n+\n+    response = client.get(\"/\", headers={\"Origin\": \"null\"})\n+    assert response.status_code == 200\n+    assert \"access-control-allow-origin\" not in response.headers\n+\n+    # Test 2: Null rejected with regex that matches everything\n+    app_regex = Starlette(\n+        routes=[Route(\"/\", endpoint=homepage)],\n+        middleware=[Middleware(CORSMiddleware, allow_origin_regex=r\".*\")],\n+    )\n+    client = test_client_factory(app_regex)\n+\n+    response = client.options(\"/\", headers={\"Origin\": \"null\", \"Access-Control-Request-Method\": \"GET\"})\n+    assert response.status_code == 400\n+    assert \"origin\" in response.text.lower()\n+\n+    # Test 3: Null rejected even when regex explicitly includes it\n+    app_regex_explicit = Starlette(\n+        routes=[Route(\"/\", endpoint=homepage)],\n+        middleware=[Middleware(CORSMiddleware, allow_origin_regex=r\"null|https://.*\")],\n+    )\n+    client = test_client_factory(app_regex_explicit)\n+\n+    response = client.options(\"/\", headers={\"Origin\": \"null\", \"Access-Control-Request-Method\": \"GET\"})\n+    assert response.status_code == 400\n+    assert \"origin\" in response.text.lower()\n+\n+    # Verify HTTPS origins still work with the regex\n+    response = client.get(\"/\", headers={\"Origin\": \"https://example.org\"})\n+    assert response.status_code == 200\n+    assert response.headers[\"access-control-allow-origin\"] == \"https://example.org\"\n+\n+\n+def test_cors_null_origin_explicitly_allowed(test_client_factory: TestClientFactory) -> None:\n+    def homepage(request: Request) -> PlainTextResponse:\n+        return PlainTextResponse(\"Homepage\", status_code=200)\n+\n+    app = Starlette(\n+        routes=[Route(\"/\", endpoint=homepage)],\n+        middleware=[Middleware(CORSMiddleware, allow_origins=[\"null\", \"https://example.org\"])],\n+    )\n+\n+    client = test_client_factory(app)\n+\n+    # Null origin should be allowed when explicitly whitelisted\n+    response = client.options(\"/\", headers={\"Origin\": \"null\", \"Access-Control-Request-Method\": \"GET\"})\n+    assert response.status_code == 200\n+    assert response.headers[\"access-control-allow-origin\"] == \"null\"\n+\n+    # Simple request should also allow null origin\n+    response = client.get(\"/\", headers={\"Origin\": \"null\"})\n+    assert response.status_code == 200\n+    assert response.headers[\"access-control-allow-origin\"] == \"null\"\n+\n+\n+def test_cors_method_case_sensitive(test_client_factory: TestClientFactory) -> None:\n+    def homepage(request: Request) -> PlainTextResponse:\n+        pass  # pragma: no cover\n+\n+    app = Starlette(\n+        routes=[Route(\"/\", endpoint=homepage)],\n+        middleware=[Middleware(CORSMiddleware, allow_origins=[\"https://example.org\"], allow_methods=[\"POST\"])],\n+    )\n+\n+    client = test_client_factory(app)\n+\n+    # Uppercase POST should be allowed\n+    response = client.options(\"/\", headers={\"Origin\": \"https://example.org\", \"Access-Control-Request-Method\": \"POST\"})\n+    assert response.status_code == 200\n+\n+    # Lowercase \"post\" should be rejected (methods are case-sensitive per HTTP spec)\n+    response = client.options(\"/\", headers={\"Origin\": \"https://example.org\", \"Access-Control-Request-Method\": \"post\"})\n+    assert response.status_code == 400\n+    assert \"method\" in response.text.lower()\n+\n+\n+def test_cors_empty_origins_list(test_client_factory: TestClientFactory) -> None:\n+    def homepage(request: Request) -> PlainTextResponse:\n+        return PlainTextResponse(\"Homepage\", status_code=200)\n+\n+    app = Starlette(\n+        routes=[Route(\"/\", endpoint=homepage)],\n+        middleware=[Middleware(CORSMiddleware, allow_origins=[])],\n+    )\n+    client = test_client_factory(app)\n+\n+    response = client.options(\"/\", headers={\"Origin\": \"https://example.org\", \"Access-Control-Request-Method\": \"GET\"})\n+    assert response.status_code == 400\n+    assert \"access-control-allow-origin\" not in response.headers\n+    assert_vary(\n+        response,\n+        {\n+            \"Access-Control-Request-Headers\",\n+            \"Access-Control-Request-Private-Network\",\n+            \"Access-Control-Request-Method\",\n+            \"Origin\",\n+        },\n+    )\n+\n+    response = client.get(\"/\", headers={\"Origin\": \"https://example.org\"})\n+    assert response.status_code == 200\n+    assert \"access-control-allow-origin\" not in response.headers\n+    assert_vary(response, {\"Origin\"})\n+\n+\n+def test_cors_origins_list_and_regex_both_accepted(test_client_factory: TestClientFactory) -> None:\n+    def homepage(request: Request) -> PlainTextResponse:\n+        return PlainTextResponse(\"Homepage\", status_code=200)\n+\n+    app = Starlette(\n+        routes=[Route(\"/\", endpoint=homepage)],\n+        middleware=[\n+            Middleware(\n+                CORSMiddleware,\n+                allow_origins=[\"https://example.org\"],\n+                allow_origin_regex=r\"https://.*\\.trusted\\.com\",\n+            )\n+        ],\n+    )\n+    client = test_client_factory(app)\n+\n+    # Origin in explicit list should be accepted\n+    response = client.get(\"/\", headers={\"Origin\": \"https://example.org\"})\n+    assert response.status_code == 200\n+    assert response.headers[\"access-control-allow-origin\"] == \"https://example.org\"\n+\n+    # Origin matching regex should be accepted\n+    response = client.get(\"/\", headers={\"Origin\": \"https://api.trusted.com\"})\n+    assert response.status_code == 200\n+    assert response.headers[\"access-control-allow-origin\"] == \"https://api.trusted.com\"\n+\n+    # Origin matching neither should be rejected\n+    response = client.get(\"/\", headers={\"Origin\": \"https://evil.com\"})\n+    assert response.status_code == 200\n+    assert \"access-control-allow-origin\" not in response.headers\n+\n+\n+def test_cors_max_age_header(test_client_factory: TestClientFactory) -> None:\n+    def homepage(request: Request) -> PlainTextResponse:\n+        pass  # pragma: no cover\n+\n+    app_default = Starlette(\n+        routes=[Route(\"/\", endpoint=homepage)],\n+        middleware=[Middleware(CORSMiddleware, allow_origins=[\"*\"])],\n+    )\n+    client = test_client_factory(app_default)\n+\n+    response = client.options(\"/\", headers={\"Origin\": \"https://example.org\", \"Access-Control-Request-Method\": \"GET\"})\n+    assert response.status_code == 200\n+    assert response.headers[\"access-control-max-age\"] == \"600\"\n+\n+    app_custom = Starlette(\n+        routes=[Route(\"/\", endpoint=homepage)],\n+        middleware=[Middleware(CORSMiddleware, allow_origins=[\"*\"], max_age=7200)],\n+    )\n+    client = test_client_factory(app_custom)\n+\n+    response = client.options(\"/\", headers={\"Origin\": \"https://example.org\", \"Access-Control-Request-Method\": \"GET\"})\n+    assert response.status_code == 200\n+    assert response.headers[\"access-control-max-age\"] == \"7200\"\n+\n+\n+def test_cors_no_origin_header_no_cors_processing(test_client_factory: TestClientFactory) -> None:\n+    def homepage(request: Request) -> PlainTextResponse:\n+        return PlainTextResponse(\"Homepage\", status_code=200)\n+\n+    app = Starlette(\n+        routes=[Route(\"/\", endpoint=homepage)],\n+        middleware=[Middleware(CORSMiddleware, allow_origins=[\"*\"])],\n+    )\n+    client = test_client_factory(app)\n+\n+    response = client.get(\"/\")\n+    assert response.status_code == 200\n+    assert \"access-control-allow-origin\" not in response.headers\n+    assert_vary(response, None)\n+\n+\n+def test_cors_header_name_case_insensitive(test_client_factory: TestClientFactory) -> None:\n+    def homepage(request: Request) -> PlainTextResponse:\n+        pass  # pragma: no cover\n+\n+    app = Starlette(\n+        routes=[Route(\"/\", endpoint=homepage)],\n+        middleware=[Middleware(CORSMiddleware, allow_origins=[\"*\"], allow_headers=[\"X-Custom-Header\"])],\n+    )\n+    client = test_client_factory(app)\n+\n+    response = client.options(\n+        \"/\",\n+        headers={\n+            \"Origin\": \"https://example.org\",\n+            \"Access-Control-Request-Method\": \"GET\",\n+            \"Access-Control-Request-Headers\": \"x-custom-header\",\n+        },\n+    )\n+    assert response.status_code == 200\n"
        }
    ]
}